<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Historia Cl√≠nica</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <script src="config.js"></script>
</head>

<body>
	<!-- ============== PANTALLA DE LOGIN ============== -->

	<div id="loginScreen">
		<img src="images/logo_2.png" alt="Logo Cl√≠nica"> 
		<form id="loginForm">
			<h2>Historias Cl√≠nicas Electr√≥nicas</h2>
			<div class="form-group">
			<label for="loginUsuario">Usuario (Login):</label>
			<input type="text" id="loginUsuario" name="loginUsuario" required>
			</div>
			<div class="form-group">
			<label for="loginPassword">Contrase√±a:</label>
			<input type="password" id="loginPassword" name="loginPassword" required>
			</div>
			<button type="submit" id="btnLogin">Ingresar</button>
			<p id="loginError"></p>
			<!-- Enlace para Olvid√≥ Contrase√±a -->
			<p id="forgotPasswordLinkContainer" style="margin-top: 5px; text-align: center;">
				<a href="#" id="forgotPasswordLink" style="color: #007bff; text-decoration: none;">Olvid√≥ su Contrase√±a?</a>
			</p>
			<!-- Secci√≥n para Recuperar Contrase√±a (oculta inicialmente) -->
			<div id="forgotPasswordSection" style="display: none; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;">
				<h3>Recuperar Contrase√±a</h3>
				<p style="font-size:0.9em; margin-bottom:15px;">Ingrese su direcci√≥n de correo electr√≥nico registrada, le enviaremos su contrase√±a.</p>
				<div class="form-group">
					<label for="forgotPasswordEmail">Correo Electr√≥nico:</label>
					<input type="email" id="forgotPasswordEmail" name="forgotPasswordEmail">
				</div>
				<button type="button" id="btnSendPasswordReminder">Enviar Contrase√±a</button>
				<p id="forgotPasswordMessage" style="margin-top: 15px; min-height: 1.2em;"></p>
				<p style="margin-top: 15px; text-align: center;">
					<a href="#" id="backToLoginLink" style="color: #007bff; text-decoration: none;">Volver a Iniciar Sesi√≥n</a>
				</p>
			</div>
		</form>
	</div>
	  
	<!-- ============== MODAL CAMBIO DE CONTRASE√ëA PRIMER LOGIN ============== -->
	<div id="modalPrimerLoginPassword" class="modal" style="display: none;">
	  <div class="modal-content" style="max-width: 450px;">
		<!-- No necesitamos bot√≥n de cierre '√ó' aqu√≠, el usuario debe completar el flujo -->
		<h2>Cambio de Contrase√±a Obligatorio</h2>
		<p>Es la primera vez que ingresa al sistema y deber√° cambiar la contrase√±a asignada.</p>
		<form id="formPrimerLoginPassword">
		  <input type="hidden" id="primerLoginMedicoId"> <!-- Para saber a qu√© m√©dico actualizar -->
		  <input type="hidden" id="primerLoginEmailMedico">
		  <input type="hidden" id="primerLoginNombreCompletoMedico">
		  <input type="hidden" id="primerLoginLoginMedico">
		  <input type="hidden" id="primerLoginNombreCentro">

		  <div class="form-group">
			<label for="nuevoPassword">Nueva Contrase√±a:</label>
			<input type="password" id="nuevoPassword" name="nuevoPassword" required minlength="6">
			<small>M√≠nimo 6 caracteres.</small>
		  </div>
		  <div class="form-group">
			<label for="confirmarNuevoPassword">Confirmar Nueva Contrase√±a:</label>
			<input type="password" id="confirmarNuevoPassword" name="confirmarNuevoPassword" required minlength="6">
		  </div>
		  <p id="primerLoginPasswordError" style="color: red; text-align: center; margin-bottom: 10px;"></p>
		  <div class="form-actions" style="justify-content: space-between;"> <!-- Ajuste para espaciar botones -->
		  	<button type="submit" id="btnGuardarNuevoPassword">Actualizar Contrase√±a</button>
			<button type="button" id="btnCancelarPrimerLogin" >Cancelar</button>
		  </div>
		</form>
	  </div>
	</div>
	<div id="appContainer">
		<div class="sidebar">
			<!-- Logo del Centro M√©dico -->
            <img id="sidebarCentroMedicoLogo" src="images/logo_circular.png" alt="Logo Centro M√©dico" style="width:100px; display:block; margin: 10px auto;">			
			<h3 style="text-align: center; margin-bottom: 4px;" id="sidebarMedicoNombre">Usuario</h3>
			<h5 style="text-align: center; margin-top: 0;" id="sidebarMedicoEspecialidad">Rol</h5>
			
			<!-- Selector de Centro M√©dico (SOLO PARA M√âDICOS CON M√öLTIPLES CENTROS) -->
			<div id="centroMedicoSelectorContainer" style="margin: 15px 0; display: none;">
				<label for="selectCentroMedico" style="display: block; margin-bottom: 5px; font-weight: bold; text-align:center;">Seleccione Centro M√©dico:</label>
				<select id="selectCentroMedico" style="background-color: #c8e6c9; width: 90%; margin: 0 auto; display: block; padding: 8px;"></select>
			</div>

			<!-- Contenedor para los botones/listas espec√≠ficos del rol -->
			<div id="sidebarRolContent">
				<!-- Para M√âDICOS -->
				<div id="sidebarMedicoContent" style="display:none;">
					<h3>Pacientes</h3>
					    <!-- SECCI√ìN DE B√öSQUEDA -->
                    <div id="pacienteSearchContainer" style="margin-bottom: 10px; padding: 0 5px;">
                        <input type="text" id="inputBuscarPaciente" placeholder="Buscar por nombre/apellido..." style="width: calc(100% - 12px); padding: 6px; margin-bottom: 5px; box-sizing: border-box;" disabled> 
                        <div style="display: flex; justify-content: space-between;">
                            <button id="btnBuscarPacienteGo" style="padding: 5px 10px; flex-grow: 1; margin-right: 5px;" disabled>Buscar</button>
                            <button id="btnVerTodosPacientes" style="padding: 5px 10px; flex-grow: 1;" disabled>Ver Todos</button> 
                        </div>
                    </div>
  					<ul id="pacientesList"></ul>
				</div>

				<!-- Para ADMINISTRADORES -->
				<div id="sidebarAdminContent" style="display:none;">
					<h3>Administraci√≥n</h3>
					<button id="btnGenerarCodigoPacienteAdmin" class="sidebar-button">+ Generar C√≥digo Paciente</button>
					<button id="btnGestionPacientesAdmin" class="sidebar-button">Gesti√≥n de Pacientes</button>
					<button id="btnGestionMedicosAdmin" class="sidebar-button">Gesti√≥n de RR.HH.</button>
				</div>
			</div>
		</div>

	  <div class="content">
		<div id="userInfo" style="background-color: #c8e6c9; padding: 10px;"> <!-- antes el color era f0f0f0 -->
			<div id="userDropdownContainer" style="position: relative; display: inline-block;">
				<span>Bienvenido(a)</span>
				<button id="userNameDropdownBtn" class="user-dropdown-button">
					<span id="loggedInUserName"></span> <span class="dropdown-arrow">‚ñæ</span>
				</button>
				<div id="userDropdownContent" class="dropdown-content" style="display: none;">
					<a href="#" id="changePasswordLink">Cambiar Contrase√±a</a>
					<a href="#" id="logoutLink">Cerrar Sesi√≥n</a> <!-- La acci√≥n de logout ahora est√° aqu√≠ -->
				</div>
			</div>
		</div>

		<!-- VISTA PARA M√âDICOS -->
		<div id="vistaMedico" style="display: none;">	
			<h1 style="text-align: center;">Datos del Paciente</h1>
			<div id="pacienteInfo" style="display: flex; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 20px;">
			  <div id="pacienteFotoContainer" style="margin-right: 20px; position: relative;"> <!-- position: relative A√ëADIDO -->
				<img id="pacienteFoto" src="images/placeholder-paciente.png" alt="Foto Paciente" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #ccc;">
			  </div>
			  <div id="pacienteDetalles" style="display: flex; flex-wrap: wrap; flex: 1;">
				
				<!-- COLUMNA 1 DE DATOS (con antecedentes al final) (aprox. 25%) -->
				<div style="width: 20%; padding-right: 15px; box-sizing: border-box; display: flex; flex-direction: column;"> 
					<div> <!-- Contenedor para los datos superiores de la columna 1 -->
						<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 130px;">Apellidos y Nombres:</strong> <span id="infoNombreCompleto"></span></div>
						<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 130px;">F. Nacimiento:</strong> <span id="infoFechaNacimiento"></span></div>
						<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 130px;">Edad:</strong> <span id="infoEdad"></span></div>
						<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 130px;">Genero:</strong> <span id="infoGenero"></span></div>
						<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 130px;">Tipo de Sangre:</strong> <span id="infoTipoSangre"></span></div>
					</div>


				</div>

				<!-- COLUMNA 2 DE DATOS -->
				<div style="width: 30%; padding-right: 15px; box-sizing: border-box;">
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Documento Id.:</strong> <span id="infoCarnet"></span></div>
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Tel√©fono:</strong> <span id="infoTelefono"></span></div>
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Seguro:</strong> <span id="infoSeguro"></span></div>
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Estado Civil:</strong> <span id="infoEstadoCivil"></span></div>
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Direcci√≥n:</strong> <span id="infoDireccion"></span></div>
					<div style="margin-bottom: 8px;"><strong style="display: inline-block; width: 120px;">Ocupaci√≥n:</strong> <span id="infoOcupacion"></span></div>
				</div>

                <!-- COLUMNA 3 DE DATOS - VACUNAS  -->
                <div style="width: 15%; padding-right: 15px; box-sizing: border-box; margin-top: -10px;">
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <strong>Vacunas:</strong>
                            <button id="btnGestionarVacunasPaciente" class="btn-accion-icono" title="Gestionar Vacunas" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <!-- Aplicar estilos directamente aqu√≠ o mediante CSS -->
                        <div id="listaVacunasAplicadas"
                             style="font-size: 14px; border: 1px solid #ccc; padding: 6px; background-color: #f9f9f9;
                                    height: 130px; 
                                    overflow-y: auto; 
                                    white-space: normal;">
                            <!--<small>No hay vacunas registradas.</small> -->
                        </div>
                    </div>
                </div>

                <!-- COLUMNA 4 DE DATOS - ALERGIAS -->
                <div style="width: 15%; box-sizing: border-box; margin-top: -10px;">
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <strong>Alergias:</strong>
                            <button id="btnEditarAlergiasPaciente" class="btn-accion-icono" title="Editar Alergias" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div id="infoAlergias" 
                             style="font-size: 14px; border: 1px solid #ccc; padding: 6px; background-color: #f9f9f9;
                                    white-space: pre-line;
                                    height: 130px; 
                                    overflow-y: auto;">
                            <!-- Contenido Alergias se cargar√° aqu√≠ por JS -->
                        </div>
                    </div>
                </div>
				
                <!-- COLUMNA 5 DE DATOS - Antecedentes -->
                <div style="width: 20%; padding-left: 15px; box-sizing: border-box; margin-top: -10px;">
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <strong>Antecedentes:</strong>
                            <button id="btnEditarAntecedentesPaciente" class="btn-accion-icono" title="Editar Antecedentes" style="display: none;">‚úèÔ∏è</button>
                        </div>
                            <div id="infoAntecedentes" style="background-color: #f9f9f9; height: 130px; overflow-y: auto; white-space: pre-line; border: 1px solid #ccc; padding: 6px; font-size: 14px; line-height: 1.5;">
                                <!-- Contenido -->
                            </div>
                    </div>
                </div>
				
			  </div> <!-- Fin de pacienteDetalles -->
			</div>

			<h2>Historia Cl√≠nica</h2>
			<table id="tablaConsultas">
                <thead>
                  <tr style="background-color: #c8e6c9;">
                      <th style="background-color: #c8e6c9; width: 5%; text-align: center;">N¬∞</th>
                      <th style="background-color: #c8e6c9; width: 10%;">Fecha y Hora</th>
                      <th style="background-color: #c8e6c9; width: 25%;">Motivo Consulta</th>
                      <th style="background-color: #c8e6c9; width: 25%;">Diagn√≥stico</th>
                      <th style="background-color: #c8e6c9; width: 25%;">Tratamiento - Ordenes M√©dicas</th>
                      <th style="background-color: #c8e6c9; width: 10%; text-align: center;">Acciones</th> <!-- Reduc√≠ un poco acciones para compensar -->
                  </tr>
                </thead>
                <tbody>
                <tr><td colspan="6">Selecciona un paciente para ver sus consultas.</td></tr>
                </tbody>
			</table>

			<h4>Crear Consulta</h4>
			<button id="startBtn" style="display: none; background-color: #4CAF50; color:white; border:none;" disabled>üé§Ô∏è Comenzar Grabaci√≥n</button>
			<button id="pauseBtn" disabled style="display: none;">‚è∏Ô∏è Pausar</button>
			<button id="resumeBtn" disabled style="display: none;">‚ñ∂Ô∏è Reanudar</button>
			<button id="finishBtn" disabled style="display: none;">‚èπÔ∏è Finalizar Grabaci√≥n</button>
			<p id="status">Estado: esperando grabaci√≥n...</p>
			<audio id="audioPlayback" controls></audio>
			
			<div id="recordingActions" style="margin-top: 10px; display: none;">
				<button id="uploadRecordingBtn" >üì§ Actualizar Historia Cl√≠nica</button>
				<button id="cancelRecordingBtn" style="margin-left: 10px;">‚ùå Cancelar</button>
			</div>
			
			<p id="uploadResult" style="margin-top: 5px;"></p>

			<form id="uploadForm" style="display: none;">
			  <h3>Subir Audio Existente</h3>
			  <input type="file" id="audioFile" name="audioFile" accept="audio/*" required>
			  <button type="submit">Subir Audio</button>
			</form>
		</div>
			
		<!-- VISTA PARA ADMINISTRADORES -->
		<div id="vistaAdministrador" style="display: none;">
			<h1 id="adminVistaTitulo" style="text-align: center;">Panel de Administraci√≥n</h1>
			<p style="text-align: center;">Centro M√©dico: <strong id="adminCentroMedicoNombre"></strong></p>
			
			<!-- Contenedor para la tabla de Gesti√≥n de Pacientes -->
            <div id="adminGestionPacientesContainer" style="display:none;">
                <h2>Gesti√≥n de Pacientes</h2>
					<button id="btnNuevoPacienteAdmin" style="margin-bottom:10px;">+ Nuevo Paciente</button> 
					<table id="tablaPacientesAdmin">
						<thead>
							<tr>
								<th style="width: 50px;">C√≥digo</th>
								<th style="width: 100px;">Apellidos ‚ñ≤</th>
								<th style="width: 100px;">Nombres</th>
								<th style="width: 90px;">Tel√©fono</th>
								<th style="width: 80px;">Doc.Identidad</th>
								<th style="width: 50px;">Genero</th>
								<th style="width: 70px;">Fecha Nac.</th>
								<th style="width: 220px;">Direcci√≥n</th>
								<th style="width: 30px;">T. S.</th>
								<th style="width: 65px;">Estado C.</th>
								<th style="width: 130px;">Seguro</th>
								<th style="width: 70px;">Ocupaci√≥n</th>
								<th style="width: 70px;">Acciones</th>
							</tr>
						</thead>
					<tbody id="tablaPacientesAdminBody"> 
					</tbody>
				</table>
			</div>
			
			<!-- Contenedor para la tabla de Gesti√≥n de M√©dicos -->
			<div id="adminGestionMedicosContainer" style="display:none;">
                <h2>Gesti√≥n de RR.HH.</h2>
                <button id="btnNuevoMedicoAdmin" style="margin-bottom:10px;">+ Nuevo RR.HH.</button>
                <table id="tablaMedicosAdmin">
                    <thead>
                        <tr>
                            <th style="width: 40px;">Doc.Identidad</th>
                            <th style="width: 25px;">Abrev.</th> 
                            <th style="width: 90px;">Apellidos ‚ñ≤</th>   
                            <th style="width: 90px;">Nombres</th>     
                            <th style="width: 80px;">Especialidad</th>
                            <th style="width: 50px;">Tel√©fono</th>
                            <th style="width: 90px;">Direcci√≥n</th>
                            <th style="width: 40px;">Login</th>
                            <th style="width: 55px;">Usuario</th>
							<th style="width: 85px;">E-Mail</th>
                            <th style="width: 50px;">Acciones</th> 
                        </tr>
                    </thead>
                    <tbody id="tablaMedicosAdminBody">
                    </tbody>
                </table>
            </div>
		</div>
		
		<!-- ============== MODAL CAMBIAR CONTRASE√ëA (DESDE MEN√ö USUARIO) ============== -->
		<div id="modalChangeUserPassword" class="modal" style="display: none;">
		  <div class="modal-content" style="max-width: 450px;">
			<span class="close-button" id="closeModalChangeUserPassword">√ó</span>
			<h2>Cambiar Contrase√±a</h2>
			<form id="formChangeUserPassword">
			  <div class="form-group">
				<label for="currentPassword">Contrase√±a Actual:</label>
				<input type="password" id="currentPassword" name="currentPassword" required>
			  </div>
			  <div class="form-group">
				<label for="newUserPassword">Nueva Contrase√±a:</label>
				<input type="password" id="newUserPassword" name="newUserPassword" required minlength="6">
				<small>M√≠nimo 6 caracteres.</small>
			  </div>
			  <div class="form-group">
				<label for="confirmNewUserPassword">Confirmar Nueva Contrase√±a:</label>
				<input type="password" id="confirmNewUserPassword" name="confirmNewUserPassword" required minlength="6">
			  </div>
			  <p id="changeUserPasswordError" style="color: red; text-align: center; margin-bottom: 10px;"></p>
			  <p id="changeUserPasswordSuccess" style="color: green; text-align: center; margin-bottom: 10px;"></p>
			  <div class="form-actions">
				<button type="submit" id="btnSubmitChangeUserPassword">Actualizar Contrase√±a</button>
				<button type="button" id="btnCancelChangeUserPassword" style="background-color: #f44336; color:white; border:none;">Cancelar</button>
			  </div>
			</form>
		  </div>
		</div>
		
		 <!-- ============== INICIO DEL MODAL NUEVO PACIENTE (existente) ============== -->
		<div id="modalNuevoPaciente" class="modal">
		  <div class="modal-content">
			<span class="close-button" id="closeModalNuevoPaciente">√ó</span>
			<h2>Registrar Nuevo Paciente</h2>
			<form id="formNuevoPaciente">
			  <div class="form-row">
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="pacienteNombres">Nombres:</label>
				  <input type="text" id="pacienteNombres" name="Nombres" maxlength="30" required>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="pacienteApellidos">Apellidos:</label>
				  <input type="text" id="pacienteApellidos" name="Apellidos" maxlength="30" required>
				</div>
			    <div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="pacienteCarnet">Documento Id.:</label>
				   <input type="text" id="pacienteCarnet" name="Carnet" maxlength="12" pattern="\d{1,12}" inputmode="numeric" title="Ingrese solo n√∫meros (hasta 12 d√≠gitos)." required>
				</div>
			  </div>	
			  <div class="form-row">			  
                <div class="form-group">
                  <label for="pacienteFechaNacimiento">Fecha Nac.:</label>
                  <input type="date" id="pacienteFechaNacimiento" name="Fecha Nacimiento" required min="1911-01-01">
                </div>
				<div class="form-group">
				  <label for="pacienteGenero">Genero:</label>
				  <select id="pacienteGenero" name="Genero" required>
					<option value="">Seleccionar...</option>
					<option value="Masculino">Masculino</option>
					<option value="Femenino">Femenino</option>
				  </select>
				</div>
			  </div>
			  
			  <div class="form-row">
			    <div class="form-group" style="width: calc(33.33% - 10px);">
    			    <label for="pacienteTelefono">Tel√©fono:</label>
    			    <input type="tel" id="pacienteTelefono" name="Tel√©fono" maxlength="15" required>
    			</div>
    			<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="pacienteTipoSangre">Tipo de Sangre:</label>
				  <select id="pacienteTipoSangre" name="Tipo Sangre">
					<option value="">Seleccionar...</option>
					<option value="A+">A+</option><option value="A-">A-</option>
					<option value="B+">B+</option><option value="B-">B-</option>
					<option value="AB+">AB+</option><option value="AB-">AB-</option>
					<option value="O+">O+</option><option value="O-">O-</option>
				  </select>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="pacienteOcupacion">Ocupaci√≥n:</label>
				  <input type="text" id="pacienteOcupacion" name="Ocupacion" maxlength="30" required>
				</div>
			  </div>				
			  <div class="form-row">
    			<div class="form-group">
    			  <label for="pacienteEstadoCivil">Estado Civil:</label>
    			  <select id="pacienteEstadoCivil" name="Estado Civil" required>
    				<option value="">Seleccionar...</option>
    				<option value="Casado(a)">Casado(a)</option><option value="Soltero(a)">Soltero(a)</option>
    				<option value="Viudo(a)">Viudo(a)</option><option value="Uni√≥n Libre">Uni√≥n Libre</option>
    				<option value="Divorciado(a)">Divorciado(a)</option> <option value="Prefiero no decirlo">Prefiero no decirlo</option>
    			  </select>
    			</div>
				<div class="form-group">
				  <label for="pacienteSeguro">Seguro:</label>
				  <select id="pacienteSeguro" name="Seguro" required>
					<option value="">Cargando seguros...</option>
				  </select>
				</div>
		     </div>
			  <div class="form-row">
    			  <div class="form-group full-width">
    				<label for="pacienteDireccion">Direcci√≥n:</label>
    				<input type="text" id="pacienteDireccion" name="Direccion" required>
    			  </div>
    		   </div>
    			  	<!-- CAMPO PARA C√ìDIGO DE ACTIVACI√ìN - MODIFICADO -->
				<div class="form-row" style="align-items: center; margin-bottom: 20px;"> <!-- A√±adido align-items y m√°s margen inferior -->
				  <div class="form-group" style="width: calc(32% - 10px); margin-right: 10px; margin-bottom: 0;"> <!-- Ancho autom√°tico y sin margen inferior para el label -->
					  <label for="pacienteCodigoActivacion" style="margin-bottom: 0;">C√≥digo de Activaci√≥n:</label>
				  </div>
				  <div class="form-group" style="flex-grow: 1; margin-bottom: 0;"> <!-- El input toma el espacio restante y sin margen inferior -->
					  <input type="text" id="pacienteCodigoActivacion" name="ID" required maxlength="6" pattern="\d{6}" title="C√≥digo de 6 d√≠gitos num√©ricos" inputmode="numeric">
				  </div>
				</div>

			  <!-- FIN CAMPO C√ìDIGO -->
			  <div id="nuevoPacienteError" style="color: red; margin-bottom: 10px; text-align: center;"></div>
			  <div id="nuevoPacienteSuccess" style="color: green; margin-bottom: 10px; text-align: center;"></div>
			  <div class="form-actions">
				<button type="submit" id="btnGuardarPaciente">Guardar Paciente</button>
				<button type="button" id="btnCancelarNuevoPaciente">Cancelar</button>
			  </div>
			</form>
		  </div>
		</div>
		<!-- ============== FIN DEL MODAL NUEVO PACIENTE ============== -->

		<!-- ============== INICIO DEL MODAL CAMBIAR FOTO ============== -->
		<div id="modalCambiarFoto" class="modal">
		  <div class="modal-content"> <!-- Se puede usar la misma clase modal-content o una espec√≠fica si se necesita mucho styling diferente -->
			<span class="close-button" id="closeModalCambiarFoto">√ó</span>
			<h2>Actualizar Foto del Paciente</h2>
			<form id="formCambiarFoto">
			  <div class="form-group full-width" style="text-align: center; margin-bottom: 15px;">
				<img id="fotoPreview" src="images/placeholder-paciente.png" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc; margin-bottom: 10px;">
			  </div>
			  <div class="form-group full-width" style="margin-bottom: 20px;">
				<label for="pacienteArchivoFoto" style="display: block; margin-bottom: 8px; text-align: center;">Selecciona una foto (JPEG):</label>
				<input type="file" id="pacienteArchivoFoto" name="archivoFoto" accept="image/jpeg, image/jpg" required style="display: block; margin: 0 auto;">
			  </div>
			  
			  <div id="cambiarFotoError" style="color: red; margin-bottom: 10px; text-align: center;"></div>
			  <div id="cambiarFotoSuccess" style="color: green; margin-bottom: 10px; text-align: center;"></div>

			  <div class="form-actions">
				<button type="submit" id="btnGuardarNuevaFoto">Guardar Foto</button>
				<button type="button" id="btnCancelarCambiarFoto">Cancelar</button>
			  </div>
			</form>
		  </div>
		</div>
		<!-- ============== FIN DEL MODAL CAMBIAR FOTO ============== -->
		
        <!-- ============== INICIO DEL MODAL RESULTADOS LAB Y AN√ÅLISIS ============== -->
        <div id="modalResultadosLab" class="modal">
          <div class="modal-content" style="max-width: 650px;">
            <span class="close-button" id="closeModalResultadosLab">√ó</span>
            <!-- ASEG√öRATE QUE EL H2 TENGA ESTE ID -->
            <h2 id="tituloModalResultadosLab">Resultados de Laboratorio y An√°lisis</h2>
            <p><strong>Consulta <span id="modalResultadosConsultaMotivo"></span></strong></p>
            <div id="listaResultadosContainer" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
              <!-- Los resultados se listar√°n aqu√≠ din√°micamente -->
              <p>No hay resultados cargados para esta consulta.</p>
            </div>
            <div class="form-actions" style="justify-content: space-between;">
                <button type="button" id="btnAbrirModalAgregarDocumento" style="background-color: #4CAF50; color:white; border:none;">+ Agregar Documento</button>
                <button type="button" id="btnCerrarModalResultados" style="background-color: #f44336; color:white; border:none;">Cerrar</button>
            </div>
          </div>
        </div>
        <!-- ============== FIN DEL MODAL RESULTADOS LAB Y AN√ÅLISIS ============== -->

        <!-- ============== INICIO DEL MODAL AGREGAR DOCUMENTO ============== -->
        <div id="modalAgregarDocumento" class="modal">
          <div class="modal-content" style="max-width: 550px;">
            <span class="close-button" id="closeModalAgregarDocumento">√ó</span>
            <h2>Agregar Nuevo Documento/Resultado</h2>
            <form id="formAgregarDocumento">
              <div class="form-group full-width" style="margin-bottom: 15px;">
                <label for="documentoTitulo">T√≠tulo del Documento:</label>
                <input type="text" id="documentoTitulo" name="documentoTitulo" placeholder="Ej: Examen Hemograma Completo" style="width: 100%;" required>
              </div>
              <div class="form-group full-width" style="margin-bottom: 20px;">
                <label for="documentoArchivoInput">URL o Nombre del Archivo:</label>
                <input type="text" id="documentoArchivoInput" name="documentoArchivo" placeholder="Ej: https://drive.google.com/... o examenes/resultado.pdf" style="width: 100%;" required>
                <small>Ingrese una URL completa (ej: Google Drive, OneDrive) o el nombre/ruta relativa del archivo (ej: <code>resultados/hemograma.pdf</code>, asumiendo que est√° en la carpeta de la aplicaci√≥n).</small>
                <!-- El span nombreArchivoSeleccionado se elimina ya que no es type="file" -->
              </div>
              
              <div id="agregarDocumentoError" style="color: red; margin-bottom: 10px; text-align: center;"></div>
              <div id="agregarDocumentoSuccess" style="color: green; margin-bottom: 10px; text-align: center;"></div>
        
              <div class="form-actions">
                <button type="submit" id="btnGuardarDocumento"  style="background-color: #4CAF50; color:white; border:none;">Guardar Documento</button>
                <button type="button" id="btnCancelarAgregarDocumento" style="background-color: #f44336; color:white; border:none;">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
        <!-- ============== FIN DEL MODAL AGREGAR DOCUMENTO ============== -->
		
		<!-- NUEVO MODAL PARA GENERAR C√ìDIGO (ADMIN) -->
		<div id="modalGenerarCodigo" class="modal">
		  <div class="modal-content" style="max-width: 400px;">
			<span class="close-button" id="closeModalGenerarCodigo">√ó</span>
			<h2>Generar C√≥digo para Nuevo Paciente</h2>
			<!-- P√°rrafo con ID espec√≠fico -->
			<p id="mensajeInstruccionCodigo">El siguiente c√≥digo debe ser proporcionado al m√©dico para registrar un nuevo paciente:</p> 
			<div id="codigoGeneradoDisplay" style="font-size: 2em; font-weight: bold; text-align: center; margin: 20px 0; padding: 10px; border: 1px dashed #ccc; background-color: #f0f8ff;">
				<!-- C√≥digo se mostrar√° aqu√≠ -->
			</div>
			<p style="font-size:0.9em; text-align:center;">Este c√≥digo es de un solo uso y es la identificaci√≥n del paciente.</p>
			<div class="form-actions" style="margin-top: 20px; justify-content: flex-end;">
				<button type="button" id="btnCerrarModalGenerarCodigo" style="background-color: #f44336; color:white; border:none;" >Cerrar</button>
			</div>
		  </div>
		</div>
		
		<!-- ============== INICIO DEL MODAL MODIFICAR PACIENTE (ADMIN) ============== -->
		<div id="modalModificarPaciente" class="modal">
		  <div class="modal-content"> <!-- El max-width se hereda de .modal-content general -->
			<span class="close-button" id="closeModalModificarPaciente">√ó</span>
			<h2>Modificar Datos del Paciente</h2>
			<form id="formModificarPaciente">
              <input type="hidden" id="modificarPacienteRecordID">
			  
			  <div class="form-row">
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteNombres">Nombres:</label>
				  <input type="text" id="modificarPacienteNombres" name="Nombres" maxlength="30" required>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteApellidos">Apellidos:</label>
				  <input type="text" id="modificarPacienteApellidos" name="Apellidos" maxlength="30" required>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteCarnet">Doc.Identidad:</label>
				  <input type="text" id="modificarPacienteCarnet" name="Carnet" maxlength="12" pattern="\d{1,12}" inputmode="numeric" title="Ingrese solo n√∫meros (hasta 12 d√≠gitos)." required>
				</div>
			  </div>

			  <div class="form-row">
				<div class="form-group">
				  <label for="modificarPacienteFechaNacimiento">Fecha Nacimiento:</label>
				  <input type="date" id="modificarPacienteFechaNacimiento" name="Fecha Nacimiento" required min="1900-01-01">
				</div>
				<div class="form-group">
				  <label for="modificarPacienteGenero">Genero:</label>
				  <select id="modificarPacienteGenero" name="Genero" required>
					<option value="">Seleccionar...</option>
					<option value="Masculino">Masculino</option>
					<option value="Femenino">Femenino</option>
				  </select>
				</div>
			  </div>

			  <div class="form-row">
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteTelefono">Tel√©fono:</label>
				  <input type="tel" id="modificarPacienteTelefono" name="Tel√©fono" required>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteTipoSangre">Tipo de Sangre:</label>
				  <select id="modificarPacienteTipoSangre" name="Tipo Sangre">
					<option value="">Seleccionar...</option>
					<option value="A+">A+</option><option value="A-">A-</option>
					<option value="B+">B+</option><option value="B-">B-</option>
					<option value="AB+">AB+</option><option value="AB-">AB-</option>
					<option value="O+">O+</option><option value="O-">O-</option>
				  </select>
				</div>
				<div class="form-group" style="width: calc(33.33% - 10px);">
				  <label for="modificarPacienteOcupacion">Ocupaci√≥n:</label>
				  <input type="tel" id="modificarPacienteOcupacion" name="Ocupacion" maxlength="30" required>
				</div>
			  </div>

			  <div class="form-row">
				<div class="form-group">
				  <label for="modificarPacienteEstadoCivil">Estado Civil:</label>
				  <select id="modificarPacienteEstadoCivil" name="Estado Civil" required>
					<option value="">Seleccionar...</option>
					<option value="Casado(a)">Casado(a)</option><option value="Soltero(a)">Soltero(a)</option>
					<option value="Viudo(a)">Viudo(a)</option><option value="Uni√≥n Libre">Uni√≥n Libre</option>
					<option value="Divorciado(a)">Divorciado(a)</option> <option value="Prefiero no decirlo">Prefiero no decirlo</option>
				  </select>
				</div>
				<div class="form-group">
				  <label for="modificarPacienteSeguro">Seguro:</label>
				  <select id="modificarPacienteSeguro" name="Seguro" required>
					<!-- Opciones de seguro se cargar√°n aqu√≠ por fetchSeguros -->
				  </select>
				</div>
			  </div>

			  <div class="form-group full-width"> <!-- Direcci√≥n de ancho completo -->
				<label for="modificarPacienteDireccion">Direcci√≥n:</label>
				<input type="text" id="modificarPacienteDireccion" name="Direccion" required>
			  </div>
			  
			  <div id="modificarPacienteError" style="color: red; margin-bottom: 10px; text-align: center;"></div>
			  <div id="modificarPacienteSuccess" style="color: green; margin-bottom: 10px; text-align: center;"></div>
			  
			  <div class="form-actions">
				<button type="submit" id="btnGuardarModificacionesPaciente">Guardar Cambios</button>
				<button type="button" id="btnCancelarModificarPaciente">Cancelar</button>
			  </div>
			</form>
		  </div>
		</div>
		<!-- ============== FIN DEL MODAL MODIFICAR PACIENTE (ADMIN) ============== -->

		<!-- ============== INICIO DEL MODAL NUEVO MEDICO ============== -->
		<div id="modalGestionMedico" class="modal">
			<div class="modal-content">
				<span class="close-button" id="closeModalGestionMedico">√ó</span>
				<h2 id="modalGestionMedicoTitulo">Registrar Nuevo RR.HH.</h2>
				<form id="formGestionMedico">
                  <input type="hidden" id="gestionMedicoRecordID">
    			  
                  <div class="form-row">
                    <div class="form-group" style="width: calc(20% - 10px);"> <!-- Ajustado para Abreviatura -->
    				  <label for="medicoAbreviatura">Abreviatura:</label>
    				  <input type="text" id="medicoAbreviatura" name="Abreviatura" placeholder="Ej: Dr., Dra., Lic., Sr." maxlength="10" required>
    				</div>
    				<div class="form-group" style="width: calc(40% - 10px);"> <!-- Ajustado -->
    				  <label for="medicoNombres">Nombres:</label>
    				  <input type="text" id="medicoNombres" name="Nombres" maxlength="30" required>
    				</div>
    				<div class="form-group" style="width: calc(40% - 10px);"> <!-- Ajustado -->
    				  <label for="medicoApellidos">Apellidos:</label>
    				  <input type="text" id="medicoApellidos" name="Apellidos" maxlength="30" required>
    				</div>
    
    			  </div>
                  <div class="form-row">
    				<div class="form-group">
    				  <label for="medicoEspecialidad">Especialidad:</label>
    				  <input type="text" id="medicoEspecialidad" name="Especialidad" maxlength="30" required>
    				</div>
    				<div class="form-group">
    				  <label for="medicoCarnet">Doc.Identidad):</label>
    				  <input type="text" id="medicoCarnet" name="Carnet" maxlength="12" pattern="\d{1,12}" inputmode="numeric" title="Ingrese solo n√∫meros (hasta 12 d√≠gitos)." required>
    				</div>
    			  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
    				  <label for="medicoTelefono">Tel√©fono:</label>
    				  <input type="tel" id="medicoTelefono" name="Telefono" maxlength="15" required>
    				</div>
                    <div class="form-group">
                        <!-- Espacio o puedes poner Direcci√≥n aqu√≠ si prefieres 2 columnas -->
                         <label for="medicoDireccion">Direcci√≥n:</label>
    				     <input type="text" id="medicoDireccion" name="Direccion" maxlength="40" required >
                    </div>
    			  </div>
                  <!-- Si prefieres Direcci√≥n en ancho completo, descomenta esto y comenta el de arriba -->
                  <!-- <div class="form-group full-width">
    				  <label for="medicoDireccion">Direcci√≥n:</label>
    				  <input type="text" id="medicoDireccion" name="Direccion">
                  </div> -->
    
                  <hr style="margin: 20px 0;">
    
                  <div class="form-row">
    				<div class="form-group">
    				  <label for="medicoLogin">Login (Usuario):</label>
    				  <input type="text" id="medicoLogin" name="login" maxlength="10" required>
    				</div>
    				<div class="form-group" style="width: calc(50% - 10px);">
                      <label for="medicoTipoUser">Tipo de RR.HH.:</label>
                      <select id="medicoTipoUser" name="TipoUser" required>
                        <option value="Medico">Medico</option>
                        <option value="Administrador">Administrador</option>
                      </select>
                    </div>
    			  </div>
    
                  <div class="form-row">
    					<div class="form-group" style="width: calc(50% - 10px);">
    					  <label for="medicoemail">E-Mail:</label>
    					  <input type="email" id="medicoemail" name="EMail" maxlength="50" required>
    					<div class="form-group" style="width: calc(50% - 10px);">
    					</div>
    				  </div>
    
    				  <div id="gestionMedicoError" style="color: red; margin-bottom: 10px; text-align: center;"></div>
    				  <div id="gestionMedicoSuccess" style="color: green; margin-bottom: 10px; text-align: center;"></div>
    				  
    				  <div class="form-actions">
    					<button type="submit" id="btnGuardarGestionMedico">Guardar RR.HH.</button>
    					<button type="button" id="btnCancelarGestionMedico">Cancelar</button>
    				  </div>
    			  </div>
			    </form>
			</div>
		</div><!-- ============== FIN DEL MODAL GESTION M√âDICO (ADMIN) ============== -->
		
        <!-- ============== MODAL B√öSQUEDA DE CARNET RRHH ============== -->
        <div id="modalBuscarCarnetRrhh" class="modal"> <!-- ID principal -->
          <div class="modal-content"> <!-- Clase para el contenido -->
            <span class="close-button" id="closeModalBuscarCarnetRrhh">√ó</span>
            <h2>Registrar Nuevo RR.HH.</h2> <!-- h2 dentro del modal -->
            <p>Antes de registrar un nuevo RR.HH. verificaremos si existe o no en la base de datos.</p>
            <form id="formBuscarCarnetRrhh"> <!-- ID del formulario -->
              <div class="form-group"> <!-- Clase para el grupo de formulario -->
                <label for="buscarCarnetInput">Ingrese N√∫mero de Carnet:</label>
                <input type="text" id="buscarCarnetInput" name="buscarCarnetInput" minlength= "7" maxlength="12" pattern="\d{1,12}" inputmode="numeric" title="Ingrese solo n√∫meros (hasta 12 d√≠gitos)." required>
              </div>
              <p id="buscarCarnetError" style="color: red; text-align: center; margin-bottom: 10px;"></p>
              <div class="form-actions"> <!-- Clase para las acciones del formulario -->
                <button type="submit" id="btnSubmitBuscarCarnet" style="background-color: #4CAF50; color:white; border:none;">Buscar</button>
                <button type="button" id="btnCancelBuscarCarnetRrhh" style="background-color: #f44336; color:white; border:none;">Cancelar</button> <!-- Estilo inline aqu√≠ -->
              </div>
            </form>
          </div>
        </div><!-- ============== FIN DEL MODAL GESTION M√âDICO (ADMIN) ============== -->

         <!-- ============== MODAL GESTI√ìN DE VACUNAS DEL PACIENTE ============== -->
        <div id="modalGestionVacunas" class="modal">
          <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" id="closeModalGestionVacunas">√ó</span>
            <h2 id="tituloModalGestionVacunas">Gestionar Vacunas de <span></span></h2>
        
            <div style="display: flex; gap: 20px; margin-bottom: 20px;"> <!-- A√±adido margin-bottom -->
                <!-- Secci√≥n Izquierda: A√±adir Nueva Vacuna -->
                <div style="flex: 1; border-right: 1px solid #ccc; padding-right: 20px;">
                    <h3><u>A√±adir Nueva Vacuna</u></h3>
                    <form id="formAnadirVacunaPaciente">
                        <div class="form-group">
                            <label for="selectVacunaDisponible">Vacuna:</label>
                            <select id="selectVacunaDisponible" name="vacunaId" required></select>
                        </div>
                        <br>
                        <div class="form-group">
                            <label for="inputFechaAplicacionVacuna">Fecha de Aplicaci√≥n:</label>
                            <input type="date" id="inputFechaAplicacionVacuna" name="fechaAplicacion" required>
                        </div>
                        <p id="anadirVacunaError" style="color: red; text-align: center; min-height: 1.2em; margin-top:10px;"></p>
                        <!-- El bot√≥n de A√±adir se mover√° abajo -->
                    </form>
                </div>
        
                <!-- Secci√≥n Derecha: Vacunas Aplicadas -->
                <div style="flex: 1.5;">
                    <h3><u>Vacunas Aplicadas</u></h3>
                    <div id="tablaVacunasAplicadasContainer" style="max-height: 260px; overflow-y: auto;"> <!-- Ajustar altura si es necesario -->
                        <table id="tablaVacunasDelPaciente">
                            <thead>
                                <tr>
                                    <th style="width: 42%;">Vacuna</th>
                                    <th style="width: 28%;">Fecha Aplic.</th>
                                    <th style="width: 20%; text-align:center;">Acci√≥n</th> <!-- Ancho fijo y centrado para el icono -->
                                </tr>
                            </thead>
                            <tbody id="tbodyVacunasDelPaciente">
                                <tr><td colspan="3" style="text-align:center;">No hay vacunas registradas.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- Fin del contenedor flex para las dos columnas -->
        
            <!-- NUEVA SECCI√ìN DE ACCIONES DEL MODAL -->
            <div class="form-actions" style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center;">
                 <button type="submit" form="formAnadirVacunaPaciente" id="btnSubmitAnadirVacuna" style="background-color: #4CAF50; color:white; border:none;">A√±adir Vacuna</button> <!-- Bot√≥n submit para el form -->
                 <button type="button" id="btnCerrarModalGestionVacunas" class="btn-secondary" style="background-color: #f44336; color:white; border:none;">Cerrar</button> <!-- Bot√≥n cerrar normal -->
            </div>
          </div>
        </div>
        
        <!-- ============== MODAL EDITAR ALERGIAS DEL PACIENTE ============== -->
        <div id="modalEditarAlergias" class="modal">
          <div class="modal-content" style="max-width: 550px;">
            <span class="close-button" id="closeModalEditarAlergias">√ó</span>
            <h2 id="tituloModalEditarAlergias">Gestionar Alergias de <span></span></h2>
            <form id="formEditarAlergias">
              <input type="hidden" id="editarAlergiasPacienteId">
              <div class="form-group full-width">
                <label for="textareaAlergias">Alergias (una por l√≠nea si son varias):</label>
                <textarea id="textareaAlergias" name="alergiasContenido" rows="8" style="width: 100%; padding: 8px; border: 1px solid #ccc; font-family: Arial, sans-serif; font-size: 14px;  box-sizing: border-box;"></textarea>
              </div>
              <p id="editarAlergiasError" style="color: red; text-align: center; min-height: 1.2em; margin-top:10px;"></p>
              <div class="form-actions" style="margin-top: 20px;">
                <button type="submit" id="btnGuardarAlergias"  style="background-color: #4CAF50; color:white; border:none;">Guardar Alergias</button>
                <button type="button" id="btnCancelarEditarAlergias" class="btn-secondary" style="background-color: #f44336; color:white; border:none;">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- ============== MODAL VER/EDITAR Antecedentes ============== -->
        <div id="modalVerAntecedentes" class="modal">
          <div class="modal-content" style="max-width: 600px;">
            <span class="close-button" id="closeModalVerAntecedentes">√ó</span>
            <h2 id="tituloModalVerAntecedentes">Antecedentes del Paciente</h2>

            <!-- Div para visualizaci√≥n (se ocultar√° en modo edici√≥n) -->
            <div id="modalAntecedentesContenidoDisplay"
                 style="border: 1px solid #ccc; padding: 15px;
                        min-height: 100px; max-height: 300px; 
                        overflow-y: auto; background-color: #fdfdfd;
                        white-space: pre-line;
                        line-height: 1.5; 
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                        display: block;">
              <!-- El contenido de los antecedentes se cargar√° aqu√≠ para visualizaci√≥n -->
            </div>
        
            <!-- Textarea para edici√≥n (oculto inicialmente o cuando solo se visualiza) -->
            <form id="formEditarAntecedentes" style="display: none;"> <!-- Inicialmente oculto -->
                <input type="hidden" id="editarAntecedentesPacienteId">
                <div class="form-group full-width" style="margin-top: 15px;">
                    <label for="textareaAntecedentesEditar">Editar Antecedentes (uno por l√≠nea si son varios):</label>
                    <textarea id="textareaAntecedentesEditar" name="antecedentesContenido" rows="10" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.5; box-sizing: border-box;"></textarea>
                </div>
                <p id="editarAntecedentesError" style="color: red; text-align: center; min-height: 1.2em; margin-top:10px;"></p>
            </form>
        
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <!-- El bot√≥n de guardar solo es relevante y visible en modo edici√≥n -->
                <button type="submit" form="formEditarAntecedentes" id="btnGuardarAntecedentes" style="display: none; background-color: #4CAF50; color:white; border:none;">Guardar Cambios</button>
                <button type="button" id="btnCerrarModalAntecedentes" style="background-color: #f44336; color:white; border:none;">Cerrar</button>
            </div>
          </div>
        </div>
        
        <!-- ============== MODAL VER DETALLES CONSULTA ============== -->
        <div id="modalVerDetallesConsulta" class="modal">
          <div class="modal-content" style="max-width: 800px;">
            <span class="close-button" id="closeModalDetallesConsulta">√ó</span>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 id="tituloModalDetallesConsulta" style="margin-bottom: 0; flex-grow: 1; text-align: center;"></h2>
                <button id="btnEditarDetallesConsultaModal" class="btn-accion-icono" title="Editar esta consulta">‚úèÔ∏è</button>
            </div>
            <!--<p><strong>Fecha y Hora:</strong> <span id="detallesConsultaFecha"></span><p> -->
            <p> </p>
            <input type="hidden" id="detallesConsultaRecordID"> <!-- Para guardar el ID de la consulta -->
        
            <div style="display: flex; justify-content: space-between; gap: 15px;">
                <!-- MOTIVO DE CONSULTA -->
                <div style="flex: 1; border-right: 1px solid #ccc; padding-right: 15px;">
                    <h4><u>Motivo de Consulta</u></h4>
                    <div id="detallesConsultaMotivoDisplay" class="detalle-columna-contenido"></div>
                    <textarea id="detallesConsultaMotivoEdit" class="detalle-columna-edit" style="display: none; width: 100%; min-height: 100px; box-sizing: border-box;"></textarea>
                </div>
                <!-- DIAGN√ìSTICO -->
                <div style="flex: 1; border-right: 1px solid #ccc; padding-right: 15px;">
                    <h4><u>Diagn√≥stico</u></h4>
                    <div id="detallesConsultaDiagnosticoDisplay" class="detalle-columna-contenido"></div>
                    <textarea id="detallesConsultaDiagnosticoEdit" class="detalle-columna-edit" style="display: none; width: 100%; min-height: 100px; box-sizing: border-box;"></textarea>
                </div>
                <!-- TRATAMIENTO / √ìRDENES -->
                <div style="flex: 1;">
                    <h4><u>Tratamiento / √ìrdenes</u></h4>
                    <div id="detallesConsultaTratamientoDisplay" class="detalle-columna-contenido"></div>
                    <textarea id="detallesConsultaTratamientoEdit" class="detalle-columna-edit" style="display: none; width: 100%; min-height: 100px; box-sizing: border-box;"></textarea>
                </div>
            </div>
        
            <p id="detallesConsultaError" style="color: red; text-align: center; margin-top: 15px; min-height: 1.2em;"></p>
        
            <div class="form-actions" style="margin-top: 25px; justify-content: flex-end;">
                <button type="button" id="btnGuardarCambiosDetallesConsulta" style="display: none; background-color: #4CAF50; color:white; border:none; margin-right:10px;">Guardar Cambios</button>
                <button type="button" id="btnCancelarEdicionDetallesConsulta" style="display: none; background-color: #f44336; color:white; border:none; margin-right:10px;">Cancelar Edici√≥n</button>
                <button type="button" id="btnCerrarModalDetallesConsulta" style="background-color: #f44336; color:white; border:none;">Cerrar</button>
            </div>
          </div>
        </div>      
		
	</div>
</div>	
<script>
    // --- Configuraci√≥n Base de Datos ---
    const tablaPacientes = 'Pacientes';
    const tablaConsultas = 'Consultas';
	const tablaSeguros = 'Seguros'; 
	const tablaMedicos = 'Medicos';
	const tablaCentrosMedicos = 'Centros Medicos';
	const EXPANDED_MAX_HEIGHT_PX = '150px'; 

    // --- Elementos del DOM (Declaraciones) ---
    // Estas declaraciones pueden estar fuera de DOMContentLoaded
    const pacientesList = document.getElementById('pacientesList');
    const pacienteInfo = document.getElementById('pacienteInfo');
    const consultasBody = document.querySelector('#tablaConsultas tbody');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const finishBtn = document.getElementById('finishBtn');
    const statusP = document.getElementById('status');
    const audioPlayback = document.getElementById('audioPlayback');
    const recordingActionsDiv = document.getElementById('recordingActions');
    const uploadRecordingBtn = document.getElementById('uploadRecordingBtn');
    const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
    const uploadForm = document.getElementById('uploadForm');
    const audioFileInput = document.getElementById('audioFile');
    const uploadResultP = document.getElementById('uploadResult');
	//const btnNuevoPaciente = document.getElementById('btnNuevoPaciente');
    const modalNuevoPaciente = document.getElementById('modalNuevoPaciente');
    const closeModalNuevoPaciente = document.getElementById('closeModalNuevoPaciente');
    const formNuevoPaciente = document.getElementById('formNuevoPaciente');
    const btnCancelarNuevoPaciente = document.getElementById('btnCancelarNuevoPaciente');
    const nuevoPacienteErrorP = document.getElementById('nuevoPacienteError');
    const nuevoPacienteSuccessP = document.getElementById('nuevoPacienteSuccess');
	const selectPacienteSeguro = document.getElementById('pacienteSeguro'); 
    //const btnAbrirModalFoto = document.getElementById('btnAbrirModalFoto');
    const modalCambiarFoto = document.getElementById('modalCambiarFoto');
    const closeModalCambiarFoto = document.getElementById('closeModalCambiarFoto');
    const formCambiarFoto = document.getElementById('formCambiarFoto');
    const pacienteArchivoFotoInput = document.getElementById('pacienteArchivoFoto');
    const fotoPreviewImg = document.getElementById('fotoPreview');
    const btnGuardarNuevaFoto = document.getElementById('btnGuardarNuevaFoto');
    const btnCancelarCambiarFoto = document.getElementById('btnCancelarCambiarFoto');
    const cambiarFotoErrorP = document.getElementById('cambiarFotoError');
    const cambiarFotoSuccessP = document.getElementById('cambiarFotoSuccess');
	const modalResultadosLab = document.getElementById('modalResultadosLab');
    const closeModalResultadosLab = document.getElementById('closeModalResultadosLab'); // Ya estaba
    const modalResultadosConsultaMotivo = document.getElementById('modalResultadosConsultaMotivo');
    const listaResultadosContainer = document.getElementById('listaResultadosContainer');
    const btnAbrirModalAgregarDocumento = document.getElementById('btnAbrirModalAgregarDocumento');
    const btnCerrarModalResultados = document.getElementById('btnCerrarModalResultados'); // Ya estaba
    const modalAgregarDocumento = document.getElementById('modalAgregarDocumento');
    const closeModalAgregarDocumento = document.getElementById('closeModalAgregarDocumento');
    const formAgregarDocumento = document.getElementById('formAgregarDocumento');
    const inputDocumentoTitulo = document.getElementById('documentoTitulo');
	const inputDocumentoArchivo = document.getElementById('documentoArchivoInput'); 
    const spanNombreArchivoSeleccionado = document.getElementById('nombreArchivoSeleccionado');
    const btnCancelarAgregarDocumento = document.getElementById('btnCancelarAgregarDocumento');
    const agregarDocumentoErrorP = document.getElementById('agregarDocumentoError');
    const agregarDocumentoSuccessP = document.getElementById('agregarDocumentoSuccess');
	const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('appContainer');
    const loginForm = document.getElementById('loginForm');
    const loginUsuarioInput = document.getElementById('loginUsuario');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginErrorP = document.getElementById('loginError');
    const loggedInUserNameSpan = document.getElementById('loggedInUserName');
    const sidebarMedicoNombreH3 = document.getElementById('sidebarMedicoNombre');
    const sidebarMedicoEspecialidadH5 = document.getElementById('sidebarMedicoEspecialidad');
	const sidebarCentroMedicoLogoImg = document.getElementById('sidebarCentroMedicoLogo');
    const centroMedicoSelectorContainerDiv = document.getElementById('centroMedicoSelectorContainer');
    const selectCentroMedicoDropdown = document.getElementById('selectCentroMedico');
    
	const infoAntecedentesDivLocal = document.getElementById('infoAntecedentes'); 
	const vistaMedicoDiv = document.getElementById('vistaMedico');
	const vistaAdministradorDiv = document.getElementById('vistaAdministrador');
	const adminCentroMedicoNombreSpan = document.getElementById('adminCentroMedicoNombre');
	const tablaPacientesAdminBody = document.querySelector('#tablaPacientesAdmin tbody');
	const modalGenerarCodigo = document.getElementById('modalGenerarCodigo');
	const closeModalGenerarCodigo = document.getElementById('closeModalGenerarCodigo');
	const codigoGeneradoDisplayDiv = document.getElementById('codigoGeneradoDisplay');
	const btnCerrarModalGenerarCodigo = document.getElementById('btnCerrarModalGenerarCodigo');
	const pacienteCodigoActivacionInput = document.getElementById('pacienteCodigoActivacion');
	const tablaCodigosActivacion = 'CodigosActivacion'; 
	const modalModificarPaciente = document.getElementById('modalModificarPaciente');
	const closeModalModificarPaciente = document.getElementById('closeModalModificarPaciente');
	const formModificarPaciente = document.getElementById('formModificarPaciente');
	const btnCancelarModificarPaciente = document.getElementById('btnCancelarModificarPaciente');
	const modificarPacienteErrorP = document.getElementById('modificarPacienteError');
	const modificarPacienteSuccessP = document.getElementById('modificarPacienteSuccess');
	const modificarPacienteRecordIDInput = document.getElementById('modificarPacienteRecordID');
	const modificarPacienteNombresInput = document.getElementById('modificarPacienteNombres');
	const modificarPacienteApellidosInput = document.getElementById('modificarPacienteApellidos');
	const modificarPacienteCarnetInput = document.getElementById('modificarCarnetNombres');
	const modificarPacienteFechaNacimientoInput = document.getElementById('modificarPacienteFechaNacimiento');
	const modificarPacienteGeneroInput = document.getElementById('modificarPacienteGenero');
	const modificarPacienteTelefonoInput = document.getElementById('modificarPacienteTelefono');
	const modificarPacienteTipoSangreInput = document.getElementById('modificarPacienteTipoSangre');
	const modificarPacienteEstadoCivilInput = document.getElementById('modificarPacienteEstadoCivil');
	const modificarPacienteSeguroInput = document.getElementById('modificarPacienteSeguro');
	const modificarPacienteDireccionInput = document.getElementById('modificarPacienteDireccion');
	const modificarPacienteOcupacionInput = document.getElementById('modificarPacienteOcupacion');

	const sidebarMedicoContentDiv = document.getElementById('sidebarMedicoContent');
	const sidebarAdminContentDiv = document.getElementById('sidebarAdminContent');
	const btnNuevoPacienteAdmin = document.getElementById('btnNuevoPacienteAdmin');
	const btnGenerarCodigoPacienteAdmin = document.getElementById('btnGenerarCodigoPacienteAdmin');
	const btnGestionPacientesAdmin = document.getElementById('btnGestionPacientesAdmin');
	const btnGestionMedicosAdmin = document.getElementById('btnGestionMedicosAdmin');

	const adminVistaTituloH1 = document.getElementById('adminVistaTitulo');
	const adminGestionPacientesContainerDiv = document.getElementById('adminGestionPacientesContainer');
	const adminGestionMedicosContainerDiv = document.getElementById('adminGestionMedicosContainer');
	const tablaMedicosAdminBody = document.querySelector('#tablaMedicosAdmin tbody');

	const modalGestionMedico = document.getElementById('modalGestionMedico');
	const closeModalGestionMedico = document.getElementById('closeModalGestionMedico');
	const modalGestionMedicoTituloH2 = document.getElementById('modalGestionMedicoTitulo');
	const formGestionMedico = document.getElementById('formGestionMedico');
	const gestionMedicoRecordIDInput = document.getElementById('gestionMedicoRecordID');
	const medicoNombresApellidosInput = document.getElementById('medicoNombresApellidos');
	const medicoEspecialidadInput = document.getElementById('medicoEspecialidad');
	const medicoCarnet = document.getElementById('medicoCarnet');
	const medicoTelefono = document.getElementById('medicoTelefono');
	const medicoDireccionInput = document.getElementById('medicoDireccion');
	const medicoLoginInput = document.getElementById('medicoLogin');
	const medicoemailInput = document.getElementById('medicoemail');
	const medicoTipoUserInput = document.getElementById('medicoTipoUser');
	const gestionMedicoErrorP = document.getElementById('gestionMedicoError');
	const gestionMedicoSuccessP = document.getElementById('gestionMedicoSuccess');
	const btnCancelarGestionMedico = document.getElementById('btnCancelarGestionMedico');
	
	const loginFieldsDiv = document.getElementById('loginFields');
	const forgotPasswordLink = document.getElementById('forgotPasswordLink');
	const forgotPasswordSectionDiv = document.getElementById('forgotPasswordSection');
	const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
	const btnSendPasswordReminder = document.getElementById('btnSendPasswordReminder');
	const forgotPasswordMessageP = document.getElementById('forgotPasswordMessage');
	const backToLoginLink = document.getElementById('backToLoginLink');
	
	const userNameDropdownBtn = document.getElementById('userNameDropdownBtn');
	const userDropdownContent = document.getElementById('userDropdownContent');
	const changePasswordLink = document.getElementById('changePasswordLink');
	const logoutLink = document.getElementById('logoutLink'); 

    const modalBuscarCarnetRrhh = document.getElementById('modalBuscarCarnetRrhh');
    const closeModalBuscarCarnetRrhh = document.getElementById('closeModalBuscarCarnetRrhh');
    const formBuscarCarnetRrhh = document.getElementById('formBuscarCarnetRrhh');
    const buscarCarnetInput = document.getElementById('buscarCarnetInput');
    const buscarCarnetErrorP = document.getElementById('buscarCarnetError');
    const btnCancelBuscarCarnetRrhh = document.getElementById('btnCancelBuscarCarnetRrhh');
	const btnNuevoMedicoAdmin = document.getElementById('btnNuevoMedicoAdmin');

	const modalChangeUserPassword = document.getElementById('modalChangeUserPassword');
	const closeModalChangeUserPassword = document.getElementById('closeModalChangeUserPassword');
	const formChangeUserPassword = document.getElementById('formChangeUserPassword');
	const btnCancelChangeUserPassword = document.getElementById('btnCancelChangeUserPassword');
	const changeUserPasswordErrorP = document.getElementById('changeUserPasswordError');
	const changeUserPasswordSuccessP = document.getElementById('changeUserPasswordSuccess');
	const today = new Date().toISOString().split('T')[0];
    document.getElementById('pacienteFechaNacimiento').setAttribute('max', today);
    document.getElementById('inputFechaAplicacionVacuna').setAttribute('max', today);
    
    // --- Estado Global ---
    let selectedPacienteData = null; 
    let mediaRecorder;
    let audioChunks = [];
	let currentRecordingConsultaId = null;
    let currentRecordingRowElement = null;
    let currentAudioBlob = null;
    let isPaused = false; 
    let archivoFotoSeleccionado = null;
	let currentConsultaIdForDocuments = null;
    let currentConsultaMotivoForModal = "";
	let loggedInMedicoId = null;
    let loggedInMedicoNombre = null;
    let loggedInMedicoEspecialidad = null;
	let selectedCentroMedicoId = null;
    let medicoCentrosMedicos = [];
	let loggedInUserType = null; // "Medico" o "Administrador"
	let adminCentroMedicoData = null; // { id, nombre, logo } para el admin
	let pacienteParaActualizarFotoAdmin = null
	let btnGestionarVacunasPaciente = null;
    let modalGestionVacunas = null;
    let closeModalGestionVacunas = null;
    let tituloModalGestionVacunasSpan = null; // El span dentro del h2
    let formAnadirVacunaPaciente = null;
    let selectVacunaDisponible = null;
    let inputFechaAplicacionVacuna = null;
    let anadirVacunaErrorP = null;
    let tablaVacunasAplicadasContainer = null; // El div que contiene la tabla
    let tbodyVacunasDelPaciente = null;
    let btnCerrarModalGestionVacunas = null;
    let btnEditarAlergiasPaciente = null;
    let modalEditarAlergias = null;
    let closeModalEditarAlergias = null;
    let tituloModalEditarAlergiasSpan = null;
    let formEditarAlergias = null;
    let textareaAlergias = null;
    let editarAlergiasErrorP = null;
    let btnCancelarEditarAlergias = null;
    let btnEditarAntecedentesPaciente = null;
    let modalAntecedentesContenidoDisplay = null; // El div de solo lectura
    let formEditarAntecedentes = null;
    let textareaAntecedentesEditar = null;
    let editarAntecedentesErrorP = null;
    let btnGuardarAntecedentes = null;    

    let modalVerAntecedentes = null;                                                  
    let closeModalVerAntecedentes = null;
    let btnCerrarModalAntecedentes = null;
    let tituloModalVerAntecedentes = null;
    let modalAntecedentesNombrePaciente = null;
    
    let modalVerDetallesConsulta = null;
    let closeModalDetallesConsulta = null;
    let btnCerrarModalDetallesConsulta = null;
    let detallesConsultaFecha = null;
    let detallesConsultaMotivo = null;
    let detallesConsultaDiagnostico = null;
    let detallesConsultaTratamiento = null;
    
    let camposOriginalesDetallesConsulta = {};
    let consultaActualIdParaEdicion = null; // ID de la consulta que se est√° viendo/editando

    // FUNCIONES 

    async function fetchPacientes(centroMedicoId, terminoBusqueda = '') { 
        if (!pacientesList) return; // Asegurarse que el elemento existe
        // console.log("fetchPacientes - ID del Centro M√©dico (RECORD_ID) para filtrar:", centroMedicoId);
        if (!centroMedicoId) {
            pacientesList.innerHTML = '<li>Error: No se ha especificado un centro m√©dico para filtrar.</li>';
            return;
        }
        pacientesList.innerHTML = '<li>Cargando pacientes...</li>';
        
        const params = new URLSearchParams({
            action: 'getPacientesPorCentro',
            centro_id: centroMedicoId,
            sort_field: 'Apellidos', // O el campo por el que quieras ordenar por defecto
            sort_direction: 'ASC'
        });
        
        if (terminoBusqueda.trim() !== '') { // Si hay t√©rmino de b√∫squeda, a√±adirlo
            params.append('search_term', terminoBusqueda.trim());
        }

        try {
            const res = await fetch(`${apiPacientes}?${params.toString()}`);
        
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: "Error desconocido del servidor."}));
                console.error("fetchPacientes - Error de API:", res.status, errorData);
                pacientesList.innerHTML = `<li>Error ${res.status} al cargar pacientes: ${errorData.error || ''}</li>`;
                return; 
            }
            
            const data = await res.json();
            
            pacientesList.innerHTML = ''; 
            if (data.records && data.records.length > 0) {
                data.records.forEach(pacienteAirtableFormat => {
                    const pFields = pacienteAirtableFormat.fields; // Acceder a los campos
                    const nombreParaMostrar = pFields['Nombre Completo'] || 'Paciente sin nombre completo';
                    const li = document.createElement('li');
                    li.textContent = nombreParaMostrar;
                    li.dataset.pacienteId = pacienteAirtableFormat.id; // Usar el ID principal
                    
                    const pacienteObjetoParaCargar = {
                        id: pacienteAirtableFormat.id,
                        fields: pFields 
                    };
                    li.onclick = () => cargarPaciente(pacienteObjetoParaCargar); 
                    pacientesList.appendChild(li);
                });
            } else {
                if (terminoBusqueda.trim() !== '') {
                    pacientesList.innerHTML = '<li>No se encontraron pacientes con ese criterio.</li>';
                } else {
                    pacientesList.innerHTML = '<li>No hay pacientes registrados para este centro m√©dico.</li>';
                }
            }
        } catch (error) {
            console.error("Error en fetchPacientes (catch JS):", error);
            pacientesList.innerHTML = `<li>Error de red o JavaScript al cargar pacientes.</li>`;
        }
    }

    function resetRecordingState() {
        if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
           mediaRecorder.stream.getTracks().forEach(track => track.stop()); 
           mediaRecorder = null; 
        }
        audioChunks = [];
        currentAudioBlob = null;
        isPaused = false;
        
        audioPlayback.style.display = 'none';
        audioPlayback.src = '';
        recordingActionsDiv.style.display = 'none';
        uploadResultP.textContent = '';
        statusP.textContent = 'Estado: esperando grabaci√≥n...';
        statusP.classList.remove('blink-red');

        startBtn.style.display = 'inline-block';
        startBtn.textContent = 'üé§Ô∏è Comenzar Grabaci√≥n';
        
        pauseBtn.style.display = 'none';
        pauseBtn.disabled = true;
        resumeBtn.style.display = 'none';
        resumeBtn.disabled = true;
        finishBtn.style.display = 'none';
        finishBtn.disabled = true;

        uploadRecordingBtn.disabled = true;
        cancelRecordingBtn.disabled = true;
		
		// Habilitar startBtn solo si hay paciente seleccionado con carnet
		if (startBtn && selectedPacienteData?.fields?.Carnet) {
			startBtn.disabled = false;
		} else if (startBtn) {
			startBtn.disabled = true;
		}
    }

	function generarCodigoAleatorio(longitud = 6) {
		// const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; // Alfanum√©rico
		const caracteres = '123456789'; // Solo num√©rico
		let codigo = '';
		for (let i = 0; i < longitud; i++) {
			codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
		}
		
		return codigo;
	}

	function mostrarAppPrincipal() {
        loginScreen.style.display = 'none';
        appContainer.style.display = 'flex'; 
        loggedInUserNameSpan.textContent = loggedInMedicoNombre;
        
        if (sidebarMedicoNombreH3) {
            sidebarMedicoNombreH3.textContent = loggedInMedicoNombre || "Dr. Desconocido"; 
        }
        if (sidebarMedicoEspecialidadH5) {
            sidebarMedicoEspecialidadH5.textContent = loggedInMedicoEspecialidad || "Especialidad no definida";
        }
        fetchPacientes(); 
    }
	
	function mostrarAppPrincipalSinCargarPacientes() {
		loginScreen.style.display = 'none';
		appContainer.style.display = 'flex'; 
		loggedInUserNameSpan.textContent = loggedInMedicoNombre;
		
		if (sidebarMedicoNombreH3) {
			sidebarMedicoNombreH3.textContent = loggedInMedicoNombre || "Dr. Desconocido"; 
		}
		if (sidebarMedicoEspecialidadH5) {
			sidebarMedicoEspecialidadH5.textContent = loggedInMedicoEspecialidad || "Especialidad no definida";
		}
		// YA NO SE LLAMA A fetchPacientes() aqu√≠ directamente
	}

    async function cargarPaciente(paciente) {
        selectedPacienteData = paciente;
        if (uploadResultP) uploadResultP.textContent = '';
        resetRecordingState();
    
        document.querySelectorAll('#pacientesList li').forEach(item => item.style.backgroundColor = '');
        const currentLi = document.querySelector(`#pacientesList li[data-paciente-id='${paciente.id}']`);
        if (currentLi) {
            currentLi.style.backgroundColor = '#c8e6c9';
        }
    
        const pacienteFotoImg = document.getElementById('pacienteFoto');
        const camposInfoIds = ['infoNombreCompleto', 'infoFechaNacimiento', 'infoCarnet', 'infoEdad',
                               'infoTipoSangre', 'infoTelefono', 'infoGenero', 'infoEstadoCivil',
                               'infoDireccion', 'infoSeguro', 'infoOcupacion'];
        camposInfoIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '';
        });
    
        [document.getElementById('infoAlergias'), document.getElementById('infoAntecedentes')].forEach(div => {
            if (div) {
                div.innerHTML = ''; div.classList.remove('expanded'); div.style.maxHeight = 'none';
                div.style.overflowY = 'hidden'; div.style.cursor = 'default';
                delete div.dataset.fullContentHtml; delete div.dataset.initialMaxHeight; delete div.dataset.fullHeight;
            }
        });
    
        const listaVacunasDiv = document.getElementById('listaVacunasAplicadas');
        if (listaVacunasDiv) listaVacunasDiv.innerHTML = '<small>Cargando vacunas...</small>';
    
        if (pacienteFotoImg) pacienteFotoImg.src = 'images/placeholder-paciente.png';
        // El colspan aqu√≠ ya deber√≠a ser 6 por la columna N¬∞
        if (consultasBody) consultasBody.innerHTML = '<tr><td colspan="6">Cargando datos del paciente...</td></tr>';
    
    
        if (!paciente || !paciente.fields) {
            console.error("[cargarPaciente] Datos del paciente inv√°lidos:", paciente);
            if (document.getElementById('pacienteInfo')) document.getElementById('pacienteInfo').innerHTML = "<p><strong>Error: Datos del paciente no v√°lidos.</strong></p>";
            if (consultasBody) consultasBody.innerHTML = '<tr><td colspan="6">Seleccione un paciente v√°lido.</td></tr>'; // Colspan 6
            selectedPacienteData = null;
            if (startBtn) startBtn.disabled = true;
            const btnGestionVacunas = document.getElementById('btnGestionarVacunasPaciente');
            if (btnGestionVacunas) btnGestionVacunas.style.display = 'none';
            return;
        }
    
        const fields = paciente.fields;
    
        if (pacienteFotoImg) {
            if (fields.Foto && typeof fields.Foto === 'string' && fields.Foto.trim() !== '') {
                let fotoUrlCorrecta = fields.Foto; // Asumimos que fields.Foto ya es la ruta correcta
                pacienteFotoImg.src = fotoUrlCorrecta;
                pacienteFotoImg.onerror = () => {
                    console.warn(`[cargarPaciente] Error al cargar foto: ${fotoUrlCorrecta}. Usando placeholder.`);
                    if (pacienteFotoImg) pacienteFotoImg.src = 'images/placeholder-paciente.png';
                    pacienteFotoImg.onerror = null;
                };
            } else {
                pacienteFotoImg.src = 'images/placeholder-paciente.png';
            }
        }
    
        document.getElementById('infoNombreCompleto').textContent = fields['Nombre Completo'] || 'N/A';
        document.getElementById('infoCarnet').textContent = fields.Carnet || 'N/A';
        document.getElementById('infoTelefono').textContent = String(fields.Telefono || fields.Tel√©fono || 'N/A');
        document.getElementById('infoDireccion').textContent = fields.Direccion || 'N/A';
        document.getElementById('infoSeguro').textContent = fields['Razon Social (de Seguros)'] || 'N/A';
        document.getElementById('infoOcupacion').textContent = fields.Ocupacion || 'N/A';
    
        let fechaNacFormateada = 'N/A';
        if (fields.Fecha_Nacimiento) {
            try {
                const fechaObj = new Date(fields.Fecha_Nacimiento);
                if (!isNaN(fechaObj.getTime())) {
                    const opcionesFormato = { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' };
                    fechaNacFormateada = new Intl.DateTimeFormat('es-ES', opcionesFormato).format(fechaObj);
                } else {
                    fechaNacFormateada = 'Fecha inv√°lida';
                }
            } catch (e) {
                console.error("[cargarPaciente] Error al parsear Fecha_Nacimiento:", fields.Fecha_Nacimiento, e);
                fechaNacFormateada = fields.Fecha_Nacimiento || 'Error al cargar fecha';
            }
        }
    
        const btnEditarAlergias = document.getElementById('btnEditarAlergiasPaciente');
        if (paciente && paciente.id) {
            if (btnEditarAlergias) btnEditarAlergias.style.display = 'inline-block';
        } else {
            if (btnEditarAlergias) btnEditarAlergias.style.display = 'none';
        }
    
        const btnEditarAntecedentes = document.getElementById('btnEditarAntecedentesPaciente');
        if (paciente && paciente.id) {
            if (btnEditarAntecedentes) btnEditarAntecedentes.style.display = 'inline-block';
        } else {
            if (btnEditarAntecedentes) btnEditarAntecedentes.style.display = 'none';
        }
    
        document.getElementById('infoFechaNacimiento').textContent = fechaNacFormateada;
        document.getElementById('infoEdad').textContent = fields.Edad !== null && fields.Edad !== undefined ? `${fields.Edad}` : 'N/A';
        document.getElementById('infoTipoSangre').textContent = fields.Tipo_Sangre || 'N/A';
        document.getElementById('infoGenero').textContent = fields.Genero || 'N/A';
        document.getElementById('infoEstadoCivil').textContent = fields.Estado_Civil || 'N/A';
    
        const infoAlergiasDiv = document.getElementById('infoAlergias');
        if (infoAlergiasDiv) {
            const alergiasTexto = fields.Alergias || '';
            if (alergiasTexto.trim() === '') {
                infoAlergiasDiv.innerHTML = '<small>No hay alergias registradas.</small>';
            } else {
                infoAlergiasDiv.innerHTML = alergiasTexto.replace(/\n/g, '<br>');
            }
            infoAlergiasDiv.style.height = '130px';
            infoAlergiasDiv.style.overflowY = 'auto';
            infoAlergiasDiv.style.maxHeight = '';
            infoAlergiasDiv.style.cursor = '';
        }
    
        //setupExpandableListInline('infoAntecedentes', fields.Antecedentes || '<small>No hay antecedentes registrados</small>', 4);
        const infoAntecedentesDiv = document.getElementById('infoAntecedentes');
        if (infoAntecedentesDiv) {
            const antecedentesTexto = fields.Antecedentes || '';
            const placeholder = 'No hay antecedentes registrados';
        
            if (!antecedentesTexto.trim() || antecedentesTexto.toLowerCase() === placeholder.toLowerCase()) {
                infoAntecedentesDiv.innerHTML = `<small>${placeholder}</small>`;
            } else {
                infoAntecedentesDiv.innerHTML = antecedentesTexto.replace(/\n/g, '<br>');
            }
        
            // ESTILOS ESENCIALES QUE DEBE TENER EL DIV PARA EL SCROLL
            // Si los tienes inline en el HTML, esta parte es una reconfirmaci√≥n.
            // Si quieres que JS los controle, deben estar aqu√≠.
            infoAntecedentesDiv.style.height = '130px';
            infoAntecedentesDiv.style.overflowY = 'auto'; // <-- ¬°ASEG√öRATE DE QUE EST√â 'auto'!
            infoAntecedentesDiv.style.backgroundColor = '#f9f9f9'; // Si no est√° en el CSS
            infoAntecedentesDiv.style.border = '1px solid #ccc';   // Si no est√° en el CSS
            infoAntecedentesDiv.style.padding = '6px';            // Si no est√° en el CSS
            infoAntecedentesDiv.style.fontSize = '14px';          // Si no est√° en el CSS
            infoAntecedentesDiv.style.lineHeight = '1.5';         // Si no est√° en el CSS
            infoAntecedentesDiv.style.whiteSpace = 'pre-line';    // Si no est√° en el CSS
        
        
            // Limpiar estilos que podr√≠an haber quedado de la l√≥gica anterior de "ver m√°s"
            infoAntecedentesDiv.style.maxHeight = '';
            infoAntecedentesDiv.style.cursor = 'default';
            infoAntecedentesDiv.classList.remove('expanded'); // Si esta clase se usaba
        
            const seeMoreLink = infoAntecedentesDiv.querySelector('.see-more-link, .see-more-overlay');
            if (seeMoreLink) {
                seeMoreLink.remove();
            }
        }
        
        const btnGestionVacunas = document.getElementById('btnGestionarVacunasPaciente');
        if (paciente && paciente.id) {
            if (btnGestionVacunas) btnGestionVacunas.style.display = 'inline-block';
            await cargarYMostrarVacunasDelPaciente(paciente.id, listaVacunasDiv);
        } else {
            if (listaVacunasDiv) listaVacunasDiv.innerHTML = '<small>No se puede cargar vacunas sin ID de paciente.</small>';
            if (btnGestionVacunas) btnGestionVacunas.style.display = 'none';
        }
    
        if (!fields.Carnet) {
            console.warn("[cargarPaciente] Carnet no disponible para este paciente, no se pueden cargar consultas.");
            if (consultasBody) consultasBody.innerHTML = '<tr><td colspan="6">Carnet no disponible para cargar consultas.</td></tr>'; // Colspan 6
            if (startBtn) startBtn.disabled = true;
            return;
        }
        if (startBtn) startBtn.disabled = false;
    
        const carnetDelPaciente = fields.Carnet;
        if (consultasBody) consultasBody.innerHTML = '<tr><td colspan="6">Cargando consultas...</td></tr>';
    
        try {
            const params = new URLSearchParams({
                action: 'getConsultasPorPacienteCarnet',
                carnet: carnetDelPaciente
            });
            const resConsultas = await fetch(`${apiConsultas}?${params.toString()}`);
    
            if (!resConsultas.ok) {
                const errorData = await resConsultas.json().catch(() => ({ error: "Error desconocido del servidor al cargar consultas." }));
                console.error("[cargarPaciente] Error de API al cargar consultas:", resConsultas.status, errorData);
                throw new Error(errorData.error || `Error ${resConsultas.status} al cargar consultas.`);
            }
    
            const dataConsultas = await resConsultas.json();
            if (consultasBody) consultasBody.innerHTML = '';
    
            if (dataConsultas.records && dataConsultas.records.length > 0) {
                let numeroConsulta = 1;
                dataConsultas.records.forEach(consultaRecord => {
                    const cFields = consultaRecord.fields;
                    const tr = document.createElement('tr');
    
                    const tdNumero = document.createElement('td');
                    tdNumero.textContent = numeroConsulta++;
                    tdNumero.style.textAlign = 'center';
                    tr.appendChild(tdNumero);
    
                    let fechaFormateada = 'N/A';
                    if (cFields['Fecha_Consulta'] || cFields['Fecha Consulta']) {
                        const fechaOriginal = cFields['Fecha_Consulta'] || cFields['Fecha Consulta'];
                        try {
                            const fechaObj = new Date(fechaOriginal);
                            if (!isNaN(fechaObj.getTime())) {
                                const dia = fechaObj.getDate();
                                const mesOpciones = { month: 'short' };
                                let nombreMesCorto = new Intl.DateTimeFormat('es-ES', mesOpciones).format(fechaObj);
                                if (nombreMesCorto.endsWith('.')) nombreMesCorto = nombreMesCorto.slice(0, -1);
                                const anio = fechaObj.getFullYear();
                                const horas = fechaObj.getHours();
                                const minutos = fechaObj.getMinutes().toString().padStart(2, '0');
                                const horas12 = horas % 12 || 12;
                                const sufijo = horas < 12 ? 'AM' : 'PM';
                                let parteHora = `${horas12}:${minutos} ${sufijo}`;
                                parteHora = parteHora.replace(/\bp\. m\./g, 'PM').replace(/\ba\. m\./g, 'AM');
                                fechaFormateada = `${dia}/${nombreMesCorto}/${anio} ${parteHora}`;
                            } else { fechaFormateada = 'Fecha inv√°lida'; }
                        } catch (e) {
                            console.error("Error al parsear la fecha de consulta:", fechaOriginal, e);
                            fechaFormateada = fechaOriginal || 'Error fecha';
                        }
                    }
                    const tdFecha = document.createElement('td');
                    tdFecha.textContent = fechaFormateada;
                    tr.appendChild(tdFecha);
    
                    const tdMotivo = document.createElement('td');
                    const divMotivo = document.createElement('div');
                    divMotivo.className = 'celda-contenido-scrollable';
                    divMotivo.textContent = cFields.Motivo || '';
                    tdMotivo.appendChild(divMotivo);
                    tr.appendChild(tdMotivo);
    
                    const tdDiagnostico = document.createElement('td');
                    const divDiagnostico = document.createElement('div');
                    divDiagnostico.className = 'celda-contenido-scrollable';
                    divDiagnostico.textContent = cFields.Diagnostico || cFields.Diagn√≥stico || '';
                    tdDiagnostico.appendChild(divDiagnostico);
                    tr.appendChild(tdDiagnostico);
    
                    const tdTratamiento = document.createElement('td');
                    const divTratamiento = document.createElement('div');
                    divTratamiento.className = 'celda-contenido-scrollable';
                    divTratamiento.textContent = cFields.Tratamiento || '';
                    tdTratamiento.appendChild(divTratamiento);
                    tr.appendChild(tdTratamiento);
    
                    // --- ACCIONES ---
                    const tdAcciones = document.createElement('td');
                    tdAcciones.style.textAlign = 'center';
        
                    // Contenedor principal para la fila de botones Y el texto de estado
                    const divContenedorAccionesCompleto = document.createElement('div');
                    // Opcional: si quieres centrar todo el bloque de acciones verticalmente dentro de la celda
                    // tdAcciones.style.display = 'flex';
                    // tdAcciones.style.flexDirection = 'column';
                    // tdAcciones.style.justifyContent = 'center';
        
        
                    // Div para la fila de botones
                    const divFilaDeBotones = document.createElement('div');
                    divFilaDeBotones.classList.add('grabacion-inline-controls'); // Reutiliza esta clase para flex y gap
                    divFilaDeBotones.style.display = 'flex';
                    divFilaDeBotones.style.justifyContent = 'center';
                    divFilaDeBotones.style.gap = '5px'; // Ajusta el gap como necesites
                    // divFilaDeBotones.style.marginBottom = '4px'; // Espacio si el texto de estado est√° muy pegado
        
                    // Bot√≥n Grabar Actualizaci√≥n (Micr√≥fono)
                    const btnGrabarActualizacion = document.createElement('button');
                    btnGrabarActualizacion.innerHTML = 'üé§';
                    btnGrabarActualizacion.classList.add('btn-record-update'); // Para querySelector en iniciarGrabacionActualizacion
                    btnGrabarActualizacion.classList.add('btn-accion-icono');
                    btnGrabarActualizacion.title = "Grabar Actualizaci√≥n para esta Consulta...";
                    btnGrabarActualizacion.dataset.consultaId = consultaRecord.id;
                    btnGrabarActualizacion.dataset.medicoCreadorId = cFields.MedicoCreadorID || '';
                    btnGrabarActualizacion.dataset.nombreMedicoCreador = cFields.NombreMedicoCreador || 'un m√©dico desconocido';
                    btnGrabarActualizacion.onclick = (event) => iniciarGrabacionActualizacion(event.currentTarget);
                    divFilaDeBotones.appendChild(btnGrabarActualizacion);
        
                    // Bot√≥n Detener Actualizaci√≥n (Stop)
                    const btnDetenerActualizacion = document.createElement('button');
                    btnDetenerActualizacion.innerHTML = '‚èπÔ∏è';
                    btnDetenerActualizacion.classList.add('btn-stop-update'); // Para querySelector
                    btnDetenerActualizacion.classList.add('btn-accion-icono');
                    btnDetenerActualizacion.title = "Detener y Guardar Actualizaci√≥n";
                    btnDetenerActualizacion.style.display = 'none'; // Oculto inicialmente
                    btnDetenerActualizacion.onclick = (event) => detenerGrabacionActualizacion(event.currentTarget);
                    divFilaDeBotones.appendChild(btnDetenerActualizacion);
        
                    // Bot√≥n Cancelar Actualizaci√≥n (Cruz)
                    const btnCancelarActualizacion = document.createElement('button');
                    btnCancelarActualizacion.innerHTML = '‚ùå';
                    btnCancelarActualizacion.classList.add('btn-cancel-update'); // Para querySelector
                    btnCancelarActualizacion.classList.add('btn-accion-icono');
                    btnCancelarActualizacion.title = "Cancelar Grabaci√≥n de Actualizaci√≥n";
                    btnCancelarActualizacion.style.display = 'none'; // Oculto inicialmente
                    btnCancelarActualizacion.onclick = (event) => cancelarGrabacionActualizacion(event.currentTarget);
                    divFilaDeBotones.appendChild(btnCancelarActualizacion);
                    
                    // Bot√≥n Ver Resultados de Laboratorio (Cuaderno)
                    const btnVerResultados = document.createElement('button');
                    btnVerResultados.innerHTML = 'üìí';
                    btnVerResultados.classList.add('btn-view-results');
                    btnVerResultados.classList.add('btn-accion-icono');
                    btnVerResultados.title = "Ver/Agregar Resultados de Laboratorio y An√°lisis";
                    btnVerResultados.dataset.consultaId = consultaRecord.id;
                    btnVerResultados.dataset.motivoConsulta = cFields.Motivo || 'Consulta sin motivo espec√≠fico';
                    btnVerResultados.dataset.numeroConsulta = numeroConsulta -1; // numeroConsulta ya se increment√≥, as√≠ que restamos 1
                    btnVerResultados.dataset.fechaFormateada = fechaFormateada;   // La fecha ya formateada para la tabla
                    if (selectedPacienteData && selectedPacienteData.fields) {
                        btnVerResultados.dataset.nombrePaciente = selectedPacienteData.fields['Nombre Completo'] || 'Paciente Desconocido';
                    }
                    btnVerResultados.onclick = (event) => {
                        const consultaId = event.currentTarget.dataset.consultaId;
                        const motivo = event.currentTarget.dataset.motivoConsulta;
                        const numConsulta = event.currentTarget.dataset.numeroConsulta;
                        const fechaConsulta = event.currentTarget.dataset.fechaFormateada;
                        const nombrePaciente = event.currentTarget.dataset.nombrePaciente;
                        abrirModalResultadosLab(consultaId, motivo, numConsulta, fechaConsulta, nombrePaciente);
                    };
                    divFilaDeBotones.appendChild(btnVerResultados);
        
                    // Bot√≥n Ver Detalles de Consulta (Ojo)
                    const btnVerDetalles = document.createElement('button');
                    btnVerDetalles.innerHTML = 'üëÅÔ∏è';
                    btnVerDetalles.classList.add('btn-accion-icono');
                    btnVerDetalles.title = "Ver Detalles de la Consulta";
                    if (selectedPacienteData && selectedPacienteData.fields) {
                        btnVerDetalles.dataset.nombrePaciente = selectedPacienteData.fields['Nombre Completo'] || 'Paciente Desconocido';
                    }
                    btnVerDetalles.dataset.numeroConsulta = numeroConsulta;
                    btnVerDetalles.onclick = () => {
                        const nombrePacienteParaDetalles = btnVerDetalles.dataset.nombrePaciente;
                        const numConsultaParaDetalles = btnVerDetalles.dataset.numeroConsulta-1;
                        abrirModalDetallesConsulta(cFields, fechaFormateada, nombrePacienteParaDetalles, numConsultaParaDetalles);
                    };
                    divFilaDeBotones.appendChild(btnVerDetalles);
        
                    // A√±adir la fila de botones al contenedor completo
                    divContenedorAccionesCompleto.appendChild(divFilaDeBotones);
        
                    // Span para el estado de la grabaci√≥n en l√≠nea (se crea aqu√≠ y se a√±ade al contenedor completo)
                    const statusGrabacionInline = document.createElement('span');
                    statusGrabacionInline.classList.add('status-grabacion-inline'); // Para querySelector en iniciarGrabacionActualizacion
                    statusGrabacionInline.style.display = 'block'; // Para que ocupe su propia l√≠nea
                    statusGrabacionInline.style.textAlign = 'center';
                    statusGrabacionInline.style.fontSize = '0.85em';
                    statusGrabacionInline.style.fontStyle = 'italic';
                    statusGrabacionInline.style.minHeight = '1.2em'; // Evita saltos de layout
                    statusGrabacionInline.style.marginTop = '4px'; // Peque√±o espacio sobre el texto
                    divContenedorAccionesCompleto.appendChild(statusGrabacionInline);
    
                    if (!loggedInMedicoId) {
                        btnGrabarActualizacion.disabled = true;
                        btnGrabarActualizacion.title = "Inicie sesi√≥n para grabar actualizaciones.";
                        btnVerResultados.disabled = true;
                        btnVerResultados.title = "Inicie sesi√≥n para ver/agregar resultados.";
                        btnVerDetalles.disabled = true;
                        btnVerDetalles.title = "Inicie sesi√≥n para ver detalles.";
                    } else {
                        btnVerResultados.disabled = false;
                        btnVerDetalles.disabled = false;
                        const medicoCreadorDeEstaConsultaId = cFields.MedicoCreadorID;
                        const nombreDelMedicoCreador = cFields.NombreMedicoCreador || "un m√©dico desconocido";
                        if (medicoCreadorDeEstaConsultaId == loggedInMedicoId) {
                            btnGrabarActualizacion.disabled = false;
                        } else {
                            btnGrabarActualizacion.disabled = true;
                            btnGrabarActualizacion.title = `El m√©dico creador de esta consulta es ${nombreDelMedicoCreador}...`;
                        }
                    }
                    tdAcciones.appendChild(divContenedorAccionesCompleto); 
                    tr.appendChild(tdAcciones);
                    consultasBody.appendChild(tr);
                });
            } else {
                consultasBody.innerHTML = '<tr><td colspan="6">No hay consultas registradas para este paciente.</td></tr>'; // Colspan 6
            }
        } catch (error) {
            console.error("Error al cargar consultas:", error); // Aqu√≠ se imprimir√≠a el ReferenceError
            consultasBody.innerHTML = `<tr><td colspan="6">Error al cargar las consultas.</td></tr>`;
            if (startBtn) startBtn.disabled = true;
        }
    }
    
    async function cargarYMostrarVacunasDelPaciente(pacienteId, displayContainer) {
        if (!displayContainer) {
            console.error("Contenedor para vacunas no proporcionado.");
            return;
        }
        displayContainer.innerHTML = '<small>Cargando vacunas...</small>';
        try {
            const params = new URLSearchParams({ action: 'getVacunasDelPaciente', paciente_id: pacienteId });
            // apiPacientes se toma de config.js
            const res = await fetch(`${apiPacientes}?${params.toString()}`);
            const data = await res.json();
    
            if (!res.ok || data.error) {
                throw new Error(data.error || "Error al cargar vacunas del paciente.");
            }
    
            if (data.records && data.records.length > 0) {
                let html = '<ul style="margin:0; padding-left:15px; list-style-type: disc;">';
                data.records.forEach(vac => {
                    // Formatear fecha
                    let fechaFmt = 'Fecha no especificada';
                    if (vac.FechaAplicacion) {
                        try {
                            const fechaObj = new Date(vac.FechaAplicacion + 'T00:00:00'); // Asumir UTC o ajustar
                            fechaFmt = fechaObj.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) { fechaFmt = vac.FechaAplicacion; }
                    }
                    html += `<li>${vac.NombreVacuna || 'Vacuna desconocida'} (${fechaFmt})</li>`;
                });
                html += '</ul>';
                displayContainer.innerHTML = html;
            } else {
                displayContainer.innerHTML = '<small>No hay vacunas registradas.</small>';
            }
        } catch (error) {
            console.error("Error en cargarYMostrarVacunasDelPaciente:", error);
            displayContainer.innerHTML = `<small style="color:red;">Error al cargar vacunas.</small>`;
        }
    }
	
    function abrirModalDetallesConsulta(consultaFields, fechaConsultaFormateada, nombrePaciente, numeroConsulta) {
        consultaActualIdParaEdicion = consultaFields.ID || consultaFields.id_consulta || null; // Asume que tienes el ID de la consulta en consultaFields

        if (!consultaActualIdParaEdicion && consultaRecord && consultaRecord.id) { // Fallback si pasas consultaRecord
             consultaActualIdParaEdicion = consultaRecord.id;
        }
         if (!consultaActualIdParaEdicion) {
            console.error("No se pudo obtener el ID de la consulta para edici√≥n.");
            // Considera mostrar un error al usuario o no abrir el modal si falta el ID
        }


        const modalTituloEl = document.getElementById('tituloModalDetallesConsulta');
        const detallesFechaEl = document.getElementById('detallesConsultaFecha');
        
        const motivoDisplay = document.getElementById('detallesConsultaMotivoDisplay');
        const motivoEdit = document.getElementById('detallesConsultaMotivoEdit');
        const diagnosticoDisplay = document.getElementById('detallesConsultaDiagnosticoDisplay');
        const diagnosticoEdit = document.getElementById('detallesConsultaDiagnosticoEdit');
        const tratamientoDisplay = document.getElementById('detallesConsultaTratamientoDisplay');
        const tratamientoEdit = document.getElementById('detallesConsultaTratamientoEdit');
        
        const consultaRecordIDInput = document.getElementById('detallesConsultaRecordID');
        const errorMsgP = document.getElementById('detallesConsultaError');

        const btnEditar = document.getElementById('btnEditarDetallesConsultaModal');
        const btnGuardar = document.getElementById('btnGuardarCambiosDetallesConsulta');
        const btnCancelarEdicion = document.getElementById('btnCancelarEdicionDetallesConsulta');
        const btnCerrar = document.getElementById('btnCerrarModalDetallesConsulta');


        if (!modalVerDetallesConsulta || !modalTituloEl /*... y todos los dem√°s elementos ...*/) {
            console.error("Faltan elementos del DOM para el modal de detalles de consulta.");
            return;
        }
        if (errorMsgP) errorMsgP.textContent = ''; // Limpiar errores previos

        // Guardar el ID de la consulta en el input hidden
        if (consultaRecordIDInput) { // Asegurarse que el input exista
            // Necesitas obtener el ID real de la consulta. Si 'consultaFields' es el objeto 'fields' de Airtable,
            // y no tiene el ID de la tabla Consultas, necesitar√°s pasarlo de alguna forma.
            // Por ahora, asumir√© que 'consultaFields' S√ç tiene un campo 'id_consulta' o 'ID' (del registro de consulta).
            // Si no, necesitas pasarlo como un argumento extra a abrirModalDetallesConsulta
            consultaRecordIDInput.value = consultaActualIdParaEdicion;
        }


        // 1. T√≠tulo
        let tituloTexto = "Detalles de la Consulta";
        if (numeroConsulta) tituloTexto += ` N¬∞ ${numeroConsulta}`;
        if (nombrePaciente && nombrePaciente !== 'Paciente Desconocido') tituloTexto += ` de ${nombrePaciente}`;
        modalTituloEl.textContent = tituloTexto;

        // 2. Fecha
        //detallesFechaEl.textContent = fechaConsultaFormateada || 'N/A';

        // 3. Poblar campos y configurar modo visualizaci√≥n inicial
        camposOriginalesDetallesConsulta = { // Guardar para posible cancelaci√≥n
            motivo: consultaFields.Motivo || '',
            diagnostico: consultaFields.Diagnostico || consultaFields.Diagn√≥stico || '',
            tratamiento: consultaFields.Tratamiento || ''
        };

        motivoDisplay.innerHTML = camposOriginalesDetallesConsulta.motivo.replace(/\n/g, '<br>');
        diagnosticoDisplay.innerHTML = camposOriginalesDetallesConsulta.diagnostico.replace(/\n/g, '<br>');
        tratamientoDisplay.innerHTML = camposOriginalesDetallesConsulta.tratamiento.replace(/\n/g, '<br>');

        // Asegurar estado inicial de visualizaci√≥n
        motivoDisplay.style.display = 'block'; motivoEdit.style.display = 'none';
        diagnosticoDisplay.style.display = 'block'; diagnosticoEdit.style.display = 'none';
        tratamientoDisplay.style.display = 'block'; tratamientoEdit.style.display = 'none';

        btnEditar.style.display = 'inline-block'; // Mostrar l√°piz de editar
        btnGuardar.style.display = 'none';
        btnCancelarEdicion.style.display = 'none';
        btnCerrar.style.display = 'inline-block'; // Asegurar que el bot√≥n cerrar est√© visible

        modalVerDetallesConsulta.style.display = 'block';
    }

    async function fetchSeguros(selectElementId = 'pacienteSeguro', valorSeleccionadoId = null) {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) {
            console.error(`fetchSeguros: Elemento select con ID '${selectElementId}' no encontrado.`);
            return;
        }

        selectElement.innerHTML = '<option value="">Cargando seguros...</option>'; 
        selectElement.disabled = true;
        try {
            const params = new URLSearchParams({
                action: 'getAllSeguros', // <--- CAMBIA ESTO
                // sort_field: 'Razon_Social', 
                // sort_direction: 'ASC'
            });

            const res = await fetch(`${apiSeguros}?${params.toString()}`);

            if (!res.ok) {
                const errorData = await res.json();
                console.error(`Error (Seguros) ${res.status} para ${selectElementId}: ${errorData.error?.message || 'Error desconocido'}`);
                selectElement.innerHTML = '<option value="">Error al cargar seguros</option>';
                return; 
            }

            const data = await res.json();
            selectElement.innerHTML = '<option value="">Seleccionar seguro...</option>'; // Opci√≥n por defecto

            if (data.records && data.records.length > 0) {
                data.records.forEach(seguroRecord => { // seguroRecord es {id: ..., fields: {Razon_Social: ...}}
                    const option = document.createElement('option');
                    option.value = seguroRecord.id; // El ID del seguro de MySQL
                    option.textContent = seguroRecord.fields.Razon_Social || 'Seguro sin nombre'; // El nombre del seguro
                    selectElement.appendChild(option);
                });

                if (valorSeleccionadoId !== null && valorSeleccionadoId !== undefined) { // Verifica que no sea null o undefined
                    // Convertir a string para comparaci√≥n, ya que option.value es string
                    selectElement.value = String(valorSeleccionadoId); 
                    if (selectElement.selectedIndex === -1 || selectElement.value !== String(valorSeleccionadoId)) {
                        // Si despu√©s de intentar setear, no se seleccion√≥ o el valor no coincide, es que no existe
                        console.warn(`fetchSeguros: El seguro con ID '${valorSeleccionadoId}' no se encontr√≥ en las opciones del select '${selectElementId}'. Se dejar√° "Seleccionar...".`);
                        selectElement.value = ""; // Volver a la opci√≥n por defecto "Seleccionar..."
                    }
                } else {
                     selectElement.value = ""; // Si no hay valor seleccionado, asegurar que se muestre "Seleccionar..."
                }
            } else {
                selectElement.innerHTML = '<option value="">No hay seguros registrados</option>';
            }
        } catch (error) {
            console.error(`Error al cargar seguros para ${selectElementId}:`, error);
            selectElement.innerHTML = '<option value="">Error al cargar seguros (catch)</option>';
        } finally {
            selectElement.disabled = false; 
        }
    }
	
    async function fetchConsultaResultados(consultaId) {
        if (!consultaId) {
            console.error("fetchConsultaResultados: consultaId no proporcionado.");
            if (listaResultadosContainer) listaResultadosContainer.innerHTML = `<p style="color:red;">Error: ID de consulta no especificado.</p>`;
            return "";
        }
        try {
            const params = new URLSearchParams({
                action: 'getConsultaById', // Esta acci√≥n ya existe en tu consultas.php
                consulta_id: consultaId
            });
    
            // apiConsultas se toma de config.js
            const res = await fetch(`${apiConsultas}?${params.toString()}`);
    
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: "Error desconocido del servidor."}));
                console.error("fetchConsultaResultados - Error de API:", res.status, errorData);
                throw new Error(errorData.error || `Error ${res.status} al obtener resultados.`);
            }
            const data = await res.json(); // Tu PHP devuelve { fields: { Resultados: "..." } }
    
            if (data.fields && data.fields.Resultados !== undefined) {
                return data.fields.Resultados || ""; // Devuelve el string de resultados
            } else if (data.error) {
                console.error("fetchConsultaResultados - Error devuelto por API:", data.error);
                throw new Error(data.error);
            } else {
                console.warn("fetchConsultaResultados - Respuesta inesperada de API, no conten√≠a 'fields.Resultados':", data);
                return ""; // O manejar como un error si esperas siempre el campo
            }
        } catch (error) { // Captura errores de red o de la l√≥gica de throw new Error
            console.error("Error en fetchConsultaResultados (catch JS):", error);
            if (listaResultadosContainer) {
                 listaResultadosContainer.innerHTML = `<p style="color:red;">Error al cargar resultados: ${error.message}. Intente de nuevo.</p>`;
            }
            return "";
        }
    }

    function parseResultadosString(resultadosStr) {
        if (!resultadosStr || typeof resultadosStr !== 'string' || resultadosStr.trim() === '') {
            return [];
        }
        return resultadosStr.split('\n').map(linea => {
            const partes = linea.split(' file:');
            if (partes.length === 2) {
                return { titulo: partes[0].trim(), archivo: partes[1].trim() };
            }
            return null; 
        }).filter(item => item !== null && item.titulo && item.archivo);
    }

    function displayResultadosEnModal(documentos) {
        if (!listaResultadosContainer) return; // Asegurarse que el contenedor existe

        listaResultadosContainer.innerHTML = ''; // Limpiar resultados anteriores
        if (documentos.length === 0) {
            listaResultadosContainer.innerHTML = '<p>No hay resultados cargados para esta consulta.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.paddingLeft = '0';

        documentos.forEach((doc, index) => { // A√±adimos 'index' si lo necesitas para la eliminaci√≥n
            const li = document.createElement('li');
            li.style.display = 'flex'; // Para alinear el enlace y el bot√≥n
            li.style.justifyContent = 'space-between'; // Espacio entre enlace y bot√≥n
            li.style.alignItems = 'center'; // Alinear verticalmente
            li.style.marginBottom = '8px';
            li.style.paddingBottom = '8px';
            li.style.borderBottom = '1px dotted #ccc';

            const a = document.createElement('a');
            a.href = doc.archivo;
            a.textContent = doc.titulo;
            a.target = "_blank";
            a.style.textDecoration = 'underline';
            a.style.color = '#007bff';
            a.style.cursor = 'pointer';
            a.style.flexGrow = '1'; // Para que el enlace ocupe el espacio disponible

            const btnEliminarDoc = document.createElement('button');
            btnEliminarDoc.innerHTML = 'üóëÔ∏è'; // Icono de basurero
            btnEliminarDoc.title = `Eliminar resultado: ${doc.titulo}`;
            btnEliminarDoc.classList.add('btn-accion-icono'); // Reutilizar estilo de icono
            btnEliminarDoc.style.marginLeft = '10px'; // Espacio a la izquierda del bot√≥n
            btnEliminarDoc.style.color = '#dc3545'; // Color rojo para eliminar, o usa una clase

            // Guardar informaci√≥n para la eliminaci√≥n. Usaremos el t√≠tulo y archivo exactos.
            btnEliminarDoc.dataset.titulo = doc.titulo;
            btnEliminarDoc.dataset.archivo = doc.archivo;

            btnEliminarDoc.onclick = async () => {
                // currentConsultaIdForDocuments es una variable global que se establece al abrir el modal
                if (currentConsultaIdForDocuments) {
                    await eliminarDocumentoResultado(currentConsultaIdForDocuments, doc.titulo, doc.archivo);
                } else {
                    console.error("No se pudo identificar la consulta actual para eliminar el documento.");
                    alert("Error: No se pudo identificar la consulta actual.");
                }
            };

            li.appendChild(a);
            li.appendChild(btnEliminarDoc);
            ul.appendChild(li);
        });
        listaResultadosContainer.appendChild(ul);
    }
	
    function setActionButtonsState(disableMic = false, disableDocs = false, currentControlsToExclude = null) {
        const todosLosControles = consultasBody.querySelectorAll('.grabacion-inline-controls');
        todosLosControles.forEach(controls => {
            if (controls === currentControlsToExclude) return; 
            const btnMic = controls.querySelector('.btn-record-update');
            const btnDocs = controls.querySelector('.btn-view-results');
            if (btnMic) btnMic.disabled = disableMic;
            if (btnDocs) btnDocs.disabled = disableDocs;
        });
    }

    async function abrirModalResultadosLab(consultaId, motivoConsultaOriginal, numeroConsulta, fechaConsulta, nombrePaciente) {
        currentConsultaIdForDocuments = consultaId;

        // Obtener los elementos del DOM del modal
        const modalTituloEl = document.getElementById('tituloModalResultadosLab'); // Selecciona el H2 por su ID
        const modalConsultaInfoEl = document.getElementById('modalResultadosConsultaMotivo');

        if (!modalTituloEl || !modalConsultaInfoEl) {
            console.error("Elementos del DOM para el t√≠tulo o la info de consulta del modal de resultados no encontrados.");
            return;
        }

        // 1. Actualizar el t√≠tulo principal del modal para incluir el nombre del paciente
        if (nombrePaciente && nombrePaciente !== 'Paciente Desconocido') {
            modalTituloEl.textContent = `Resultados de Laboratorio y An√°lisis de ${nombrePaciente}`;
        } else {
            modalTituloEl.textContent = 'Resultados de Laboratorio y An√°lisis'; // Texto por defecto
        }

        // 2. Construir el string para la informaci√≥n espec√≠fica de la consulta
        let motivoCorto = motivoConsultaOriginal || '';
        if (motivoCorto.length > 30) {
            motivoCorto = motivoCorto.substring(0, 60) + "...";
        }
        const textoConsultaModal = `N¬∞: ${numeroConsulta} ${motivoCorto}`;
        modalConsultaInfoEl.textContent = textoConsultaModal;


        if (listaResultadosContainer) listaResultadosContainer.innerHTML = '<p>Cargando resultados...</p>';
        if (modalResultadosLab) modalResultadosLab.style.display = 'block';

        // Deshabilitar botones de acci√≥n en la tabla mientras el modal est√° abierto
        const todosLosControlesAccion = consultasBody.querySelectorAll('.grabacion-inline-controls');
        todosLosControlesAccion.forEach(controls => {
            const mic = controls.querySelector('.btn-record-update');
            const docs = controls.querySelector('.btn-view-results');
            if (mic) {
                mic.dataset.wasDisabled = mic.disabled;
                mic.disabled = true;
            }
            if (docs) {
                docs.dataset.wasDisabled = docs.disabled;
                docs.disabled = true;
            }
        });

        // Cargar y mostrar los documentos/resultados
        const resultadosStr = await fetchConsultaResultados(consultaId);
        const documentos = parseResultadosString(resultadosStr);
        displayResultadosEnModal(documentos);
    }
    
    function cerrarYRestaurarBotonesModalResultados() {
        modalResultadosLab.style.display = 'none';
        if (modalAgregarDocumento.style.display === 'block') {
            modalAgregarDocumento.style.display = 'none';
        }
        // console.log("FN: cerrarYRestaurarBotonesModalResultados - INICIO");
        const todosLosControlesAccion = consultasBody.querySelectorAll('.grabacion-inline-controls');
        if (todosLosControlesAccion.length === 0) {
            // console.log("FN: cerrarYRestaurarBotonesModalResultados - No se encontraron controles de acci√≥n.");
        }
        todosLosControlesAccion.forEach((controls, index) => { 
            const mic = controls.querySelector('.btn-record-update');
            const docs = controls.querySelector('.btn-view-results');
            // console.log(`FN: cerrarYRestaurarBotonesModalResultados - Fila ${index}:`);
            if (mic) {
                if (mic.dataset.wasDisabled !== undefined) {
                    // console.log(`  Mic: dataset.wasDisabled='${mic.dataset.wasDisabled}'. Se restaurar√° mic.disabled a: ${(mic.dataset.wasDisabled === 'true')}`);
                    mic.disabled = (mic.dataset.wasDisabled === 'true'); 
                    delete mic.dataset.wasDisabled; 
                } else {
                    // console.log("  Mic: dataset.wasDisabled NO EST√Å DEFINIDO.");
                }
            } else {
                // console.log("  Mic: Bot√≥n de micr√≥fono no encontrado.");
            }
            if (docs) {
                if (docs.dataset.wasDisabled !== undefined) {
                    // console.log(`  Docs: dataset.wasDisabled='${docs.dataset.wasDisabled}'. Se restaurar√° docs.disabled a: ${(docs.dataset.wasDisabled === 'true')}`);
                    docs.disabled = (docs.dataset.wasDisabled === 'true');
                    delete docs.dataset.wasDisabled; 
                } else {
                    // console.log("  Docs: dataset.wasDisabled NO EST√Å DEFINIDO.");
                }
            } else {
                // console.log("  Docs: Bot√≥n de documentos no encontrado.");
            }
        });
        // console.log("FN: cerrarYRestaurarBotonesModalResultados - FIN");
    }
	
    async function eliminarDocumentoResultado(consultaId, tituloDocAEliminar, archivoDocAEliminar) {
        if (!confirm(`¬øEst√° seguro de que desea eliminar el resultado "${tituloDocAEliminar}"?`)) {
            return; // El usuario cancel√≥
        }

        // Obtener la cadena actual de resultados de la consulta
        let resultadosActualesStr = await fetchConsultaResultados(consultaId);
        if (typeof resultadosActualesStr !== 'string') {
            resultadosActualesStr = ""; // Asegurar que sea un string
        }

        // Parsear la cadena en un array de objetos documento
        const documentosActuales = parseResultadosString(resultadosActualesStr);

        // Filtrar para remover el documento que se quiere eliminar
        // Comparamos tanto t√≠tulo como archivo para mayor seguridad
        const documentosFiltrados = documentosActuales.filter(doc => {
            return !(doc.titulo === tituloDocAEliminar && doc.archivo === archivoDocAEliminar);
        });

        // Reconstruir la cadena de resultados a partir de los documentos filtrados
        const nuevaCadenaResultados = documentosFiltrados.map(doc => `${doc.titulo} file:${doc.archivo}`).join('\n');

        // Bloquear UI o mostrar indicador de carga (opcional)
        const btnAgregarDocEnModal = document.getElementById('btnAbrirModalAgregarDocumento');
        if(btnAgregarDocEnModal) btnAgregarDocEnModal.disabled = true;
        // Podr√≠as deshabilitar tambi√©n todos los botones de eliminar mientras se procesa

        try {
            const payload = {
                action: 'updateConsultaResultados', // Reutilizamos la acci√≥n de la API
                consultaId: consultaId,
                fields: {
                    Resultados: nuevaCadenaResultados // La nueva cadena sin el documento eliminado
                }
            };

            const res = await fetch(apiConsultas, { // apiConsultas de config.js
                method: 'PATCH', // O 'POST' seg√∫n tu API
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const responseData = await res.json().catch(() => ({ success: false, error: "Respuesta inv√°lida del servidor al actualizar resultados." }));

            if (!res.ok || !responseData.success) {
                const errorMsg = responseData.error || `Error ${res.status} al eliminar documento.`;
                console.error('Error al eliminar documento (API):', errorMsg);
                alert(`Error al eliminar documento: ${errorMsg}`);
            } else {
                // √âxito: Refrescar la lista de resultados en el modal
                // console.log("Documento eliminado, refrescando modal.");
                displayResultadosEnModal(documentosFiltrados); // Usar los documentos ya filtrados para no hacer otra llamada a fetch
            }
        } catch (error) {
            console.error('Error de red o procesamiento al eliminar documento:', error);
            alert('Error de conexi√≥n al intentar eliminar el documento: ' + error.message);
        } finally {
             if(btnAgregarDocEnModal) btnAgregarDocEnModal.disabled = false;
            // Rehabilitar botones de eliminar si los deshabilitaste
        }
    }
    
    function checkLoginStatus() {
        loggedInMedicoId = localStorage.getItem('loggedInMedicoId');
        loggedInMedicoNombre = localStorage.getItem('loggedInMedicoNombre');
        loggedInMedicoEspecialidad = localStorage.getItem('loggedInMedicoEspecialidad');
        if (loggedInMedicoId && loggedInMedicoNombre) {
            mostrarAppPrincipal();
        } else {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
			if (sidebarMedicoNombreH3) sidebarMedicoNombreH3.textContent = "Dr. .......";
            if (sidebarMedicoEspecialidadH5) sidebarMedicoEspecialidadH5.textContent = "Especialidad";
        }
    }

    function rehabilitarBotonesDeAccionGlobalmente() {
        // 1. Rehabilitar bot√≥n de grabaci√≥n principal si hay paciente con carnet
        if (startBtn) {
            startBtn.disabled = !(selectedPacienteData?.fields?.Carnet);
        }
    
        // 2. Iterar sobre todas las filas de la tabla de consultas
        const todasLasFilasDeConsulta = consultasBody.querySelectorAll('tr');
        todasLasFilasDeConsulta.forEach(tr => {
            const divFilaDeBotones = tr.querySelector('.grabacion-inline-controls');
            if (!divFilaDeBotones) return; // Si la fila no tiene controles
    
            const btnMic = divFilaDeBotones.querySelector('.btn-record-update');
            const btnDocs = divFilaDeBotones.querySelector('.btn-view-results');
            
            // NO MODIFICAR la visibilidad de btnStop, btnCancel ni el statusInline aqu√≠,
            // ya que eso lo maneja la l√≥gica espec√≠fica de iniciar/detener/cancelar grabaci√≥n para cada fila.
            // Esta funci√≥n solo se encarga de RE-HABILITAR los botones principales (mic y docs)
            // despu√©s de una acci√≥n global como una cancelaci√≥n o una finalizaci√≥n de la grabaci√≥n principal.
    
            if (!loggedInMedicoId) {
                if (btnMic) { btnMic.disabled = true; btnMic.title = "Inicie sesi√≥n para grabar actualizaciones."; }
                if (btnDocs) { btnDocs.disabled = true; btnDocs.title = "Inicie sesi√≥n para ver/agregar resultados."; }
            } else {
                if (btnDocs) {
                    btnDocs.disabled = false;
                    btnDocs.title = "Ver/Agregar Resultados de Laboratorio y An√°lisis";
                }
                if (btnMic) {
                    const medicoCreadorDeEstaConsultaId = btnMic.dataset.medicoCreadorId;
                    const nombreDelMedicoCreador = btnMic.dataset.nombreMedicoCreador;
    
                    if (medicoCreadorDeEstaConsultaId && typeof medicoCreadorDeEstaConsultaId !== 'undefined') { // Asegurarse que el dataset exista
                        if (medicoCreadorDeEstaConsultaId == loggedInMedicoId) {
                            btnMic.disabled = false;
                            btnMic.title = "Grabar Actualizaci√≥n para esta Consulta...";
                        } else {
                            btnMic.disabled = true;
                            btnMic.title = `El m√©dico creador de esta consulta es ${nombreDelMedicoCreador || 'otro m√©dico'}...`;
                        }
                    } else {
                        // Fallback: si no hay datos del creador en el dataset (no deber√≠a pasar si cargarPaciente los a√±ade)
                        // Habilitar si est√° logueado, pero podr√≠a ser incorrecto.
                        // Console.warn para alertar.
                        // console.warn("Dataset medicoCreadorId no encontrado para un bot√≥n de micr√≥fono. Habilitando por defecto.");
                        btnMic.disabled = false; 
                        btnMic.title = "Grabar Actualizaci√≥n para esta Consulta... (Creador no verificado)";
                    }
                }
            }
        });
    }
    
    // La funci√≥n cancelarGrabacionActualizacion ahora se ve as√≠:
    function cancelarGrabacionActualizacion(buttonElement) {
        const filaDeBotones = buttonElement.closest('.grabacion-inline-controls');
        if (!filaDeBotones) {
            console.error("cancelarGrabacionActualizacion: No se encontr√≥ el contenedor de la fila de botones.");
            rehabilitarBotonesDeAccionGlobalmente();
            return;
        }
        const contenedorAccionesCompleto = filaDeBotones.parentElement; // Este es el div que contiene la fila de botones y el span de estado
        if (!contenedorAccionesCompleto) {
            console.error("cancelarGrabacionActualizacion: No se encontr√≥ el contenedor principal de acciones.");
            rehabilitarBotonesDeAccionGlobalmente();
            return;
        }
        const statusElInline = contenedorAccionesCompleto.querySelector('.status-grabacion-inline');
    
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.onstop = null;
            mediaRecorder.ondataavailable = null;
            if (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused') {
                try { mediaRecorder.stop(); } catch (e) { console.error("Error al detener mediaRecorder:", e); }
            }
            if (mediaRecorder.stream && typeof mediaRecorder.stream.getTracks === 'function') {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }
        audioChunks = [];
        if (statusElInline) {
            statusElInline.textContent = 'Cancelado.';
            statusElInline.classList.remove('blink-red'); // Quitar blink si estaba
        }
    
        // 1. Resetear controles (visibilidad) de la fila actual.
        // resetearControlesGrabacionInline se encarga de:
        // - Poner btnMic visible
        // - Ocultar btnStop y btnCancel
        // - NO deber√≠a tocar statusElInline.textContent aqu√≠, ya lo hicimos arriba.
        resetearControlesGrabacionInline(filaDeBotones, contenedorAccionesCompleto);
    
    
        currentRecordingConsultaId = null;
        mediaRecorder = null;
    
        // 2. Rehabilitar los estados 'disabled' de los botones de acci√≥n en TODAS las filas
        // y el bot√≥n de grabaci√≥n PRINCIPAL.
        rehabilitarBotonesDeAccionGlobalmente();
    
    
        // Limpiar el mensaje "Cancelado." despu√©s de un tiempo
        if (statusElInline) {
            setTimeout(() => {
                if (statusElInline.textContent === 'Cancelado.') {
                    statusElInline.textContent = '';
                }
            }, 2000); // Aumentado a 2 segundos para que se vea mejor
        }
    }
    
    
    // Aseg√∫rate que resetearControlesGrabacionInline NO limpie el statusEl.textContent
    // si ya fue establecido por la funci√≥n que llama (como "Cancelado." o "Actualizaci√≥n enviada.")
    function resetearControlesGrabacionInline(filaDeBotonesContainer, contenedorPrincipalAcciones) {
        if (filaDeBotonesContainer && contenedorPrincipalAcciones) {
            const statusEl = contenedorPrincipalAcciones.querySelector('.status-grabacion-inline');
            
            // Solo limpiar el texto si NO es un mensaje final como "Cancelado" o "Enviada"
            if (statusEl && statusEl.textContent !== 'Cancelado.' && statusEl.textContent !== 'Actualizaci√≥n enviada.' && !statusEl.textContent.startsWith('Error')) {
                // console.log("resetearControlesGrabacionInline: Limpiando texto de statusEl:", statusEl.textContent)
                statusEl.textContent = '';
            } else if (statusEl && (statusEl.textContent === 'Cancelado.' || statusEl.textContent === 'Actualizaci√≥n enviada.' || statusEl.textContent.startsWith('Error'))) {
                // console.log("resetearControlesGrabacionInline: NO limpiando texto de statusEl:", statusEl.textContent, "Programando limpieza.")
                // Si ya tiene un mensaje final, programar su limpieza para despu√©s
                setTimeout(() => {
                    if (statusEl.textContent === 'Cancelado.' || statusEl.textContent === 'Actualizaci√≥n enviada.' || statusEl.textContent.startsWith('Error')) {
                        statusEl.textContent = '';
                    }
                }, 2000); // 2 segundos
            }
            if (statusEl) statusEl.classList.remove('blink-red');
    
    
            const btnGrabar = filaDeBotonesContainer.querySelector('.btn-record-update');
            if (btnGrabar) btnGrabar.style.display = 'inline-block';
    
            const btnDetener = filaDeBotonesContainer.querySelector('.btn-stop-update');
            if (btnDetener) {
                btnDetener.style.display = 'none';
                btnDetener.disabled = true;
            }
    
            const btnCancelar = filaDeBotonesContainer.querySelector('.btn-cancel-update');
            if (btnCancelar) {
                btnCancelar.style.display = 'none';
                btnCancelar.disabled = true;
            }
        } else {
            // console.warn("resetearControlesGrabacionInline: No se proporcion√≥ filaDeBotonesContainer o contenedorPrincipalAcciones");
        }
    }
	
	function setupExpandableListInline(containerId, contentItemsOrString, itemsToShow = 3) {
		const container = document.getElementById(containerId);
		if (!container) {
			return;
		}

		container.innerHTML = '';
		container.classList.remove('expanded');
		container.style.maxHeight = 'none';
		container.style.overflowY = 'hidden';
		container.style.cursor = 'default';
		delete container.dataset.fullContentHtml;
		delete container.dataset.initialMaxHeight;
		delete container.dataset.fullHeight;

		let isArrayOriginal = Array.isArray(contentItemsOrString);
		let processedContentInput = contentItemsOrString;

		// Normalizar la entrada: si es un array, filtrar strings vac√≠os; si es string, usarlo.
		if (isArrayOriginal) {
			processedContentInput = contentItemsOrString.filter(item => typeof item === 'string' && item.trim() !== '');
		} else if (typeof contentItemsOrString === 'string') {
			processedContentInput = contentItemsOrString.trim();
		} else { // Si no es array ni string (o es null/undefined)
			processedContentInput = ''; // Tratar como vac√≠o
		}

		// --- SALIDA TEMPRANA SI NO HAY CONTENIDO REAL O ES EL PLACEHOLDER ---
		const placeholderText = "No hay antecedentes registrados"; // O el texto exacto que uses
        const isEffectivelyEmpty = 
            (!processedContentInput) ||
            (Array.isArray(processedContentInput) && processedContentInput.length === 0) ||
            (typeof processedContentInput === 'string' && (processedContentInput === '' || processedContentInput.toLowerCase() === placeholderText.toLowerCase()));

		if (isEffectivelyEmpty) {
			container.innerHTML = (typeof contentItemsOrString === 'string' && contentItemsOrString.trim() !== '') ? contentItemsOrString : placeholderText; // Mostrar el placeholder o el string original si era solo espacios
			container.style.maxHeight = 'none';
			container.style.overflowY = 'visible';
			container.style.cursor = 'default';
			return;
		}
        // --- FIN SALIDA TEMPRANA ---


		let fullContentHTML = '';
		let totalItems = 0;
		let initialVisibleHeight = 0;
		let calculatedInitialMaxHeightPx = getComputedStyle(container).minHeight || '40px';
		let fullHeight = 0;

		const currentIsArrayAfterProcessing = Array.isArray(processedContentInput) && processedContentInput.length > 0;

		if (currentIsArrayAfterProcessing) {
			totalItems = processedContentInput.length;
			const ul = document.createElement('ul');
			ul.style.margin = '0';
			ul.style.paddingLeft = '20px';
			processedContentInput.forEach(itemText => {
				const li = document.createElement('li');
				li.textContent = itemText;
				ul.appendChild(li);
			});
			fullContentHTML = ul.outerHTML;
		} else if (typeof processedContentInput === 'string' && processedContentInput !== '') { // Ya sabemos que no es el placeholder aqu√≠
            let textToProcess = processedContentInput;
            // textToProcess = textToProcess.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); // Ya no es tan necesario si el input es limpio
            // textToProcess = textToProcess.replace(/\n\s*\n+/g, '\n');
            // textToProcess = textToProcess.trim(); // Ya se hizo trim a processedContentInput

			fullContentHTML = textToProcess.replace(/\n/g, '<br>');
            const linesArray = textToProcess.split('\n').map(line => line.trim()).filter(line => line !== '');
			totalItems = linesArray.length;
            if (totalItems === 0 && textToProcess.length > 0 && !textToProcess.includes('\n')) {
                totalItems = 1;
            }
		} else {
            // Este caso no deber√≠a alcanzarse debido a la salida temprana
            container.innerHTML = placeholderText;
            container.style.maxHeight = 'none';
            container.style.overflowY = 'visible';
            container.style.cursor = 'default';
			return;
		}

		const tempMeasureDiv = container.cloneNode(false);
		tempMeasureDiv.style.visibility = 'hidden';
		tempMeasureDiv.style.position = 'absolute';
		tempMeasureDiv.style.width = container.clientWidth + 'px';
		tempMeasureDiv.style.maxHeight = 'none';
		tempMeasureDiv.style.overflowY = 'visible';
		tempMeasureDiv.innerHTML = fullContentHTML; // Usar el HTML procesado para medir
		document.body.appendChild(tempMeasureDiv);
		fullHeight = tempMeasureDiv.scrollHeight;
		document.body.removeChild(tempMeasureDiv);

		if (totalItems > 0) {
			const tempVisibleDiv = container.cloneNode(false);
			tempVisibleDiv.style.visibility = 'hidden';
			tempVisibleDiv.style.position = 'absolute';
            tempVisibleDiv.style.width = container.clientWidth + 'px';
			tempVisibleDiv.style.padding = getComputedStyle(container).padding;
			tempVisibleDiv.style.border = getComputedStyle(container).border;
			tempVisibleDiv.style.minHeight = 'auto';
			document.body.appendChild(tempVisibleDiv);

			if (currentIsArrayAfterProcessing) {
				const tempUl = document.createElement('ul');
				tempUl.style.margin = '0';
				tempUl.style.paddingLeft = getComputedStyle(container.querySelector('ul') || container).paddingLeft || '20px';
                for (let i = 0; i < Math.min(itemsToShow, totalItems); i++) {
					const tempLi = document.createElement('li');
					tempLi.textContent = processedContentInput[i];
					tempUl.appendChild(tempLi);
				}
				tempVisibleDiv.appendChild(tempUl);
			} else {
				const lines = fullContentHTML.split('<br>');
				tempVisibleDiv.innerHTML = lines.slice(0, Math.min(itemsToShow, totalItems)).join('<br>');
			}
			initialVisibleHeight = tempVisibleDiv.scrollHeight;
			calculatedInitialMaxHeightPx = initialVisibleHeight + 'px';
			document.body.removeChild(tempVisibleDiv);
		} else { // Si totalItems es 0 despu√©s de todo (no deber√≠a por la salida temprana)
            container.innerHTML = placeholderText;
            container.style.maxHeight = 'none';
            container.style.overflowY = 'visible';
            container.style.cursor = 'default';
            return;
		}

		container.innerHTML = '';

		const isAntecedentesField = (containerId === 'infoAntecedentes');
		let needsVisualTruncationForOthers = (totalItems > itemsToShow && fullHeight > initialVisibleHeight && initialVisibleHeight > 0);

		if (isAntecedentesField) {
            const divNominalHeight = 130;
            
            // Solo evaluar truncamiento si hay contenido real (ya filtrado el placeholder)
            let showSeeMoreForAntecedentes = false;
            if (fullContentHTML.trim() !== '') { // Asegurarse que no sea string vac√≠o despu√©s de <br>
                const needsTruncationByItemCount = (totalItems > itemsToShow && fullHeight > initialVisibleHeight);
                const needsTruncationByOverallHeight = (fullHeight > divNominalHeight + 5); // A√±adido un peque√±o umbral (+5px)
                showSeeMoreForAntecedentes = needsTruncationByItemCount || needsTruncationByOverallHeight;
            }


            if (showSeeMoreForAntecedentes) {
                container.style.cursor = 'pointer';
                container.style.maxHeight = divNominalHeight + 'px';
                container.style.overflowY = 'hidden';
                const linkHTMLModal = ` ... <span class="see-more-link" data-action="openModal" style="color: #007bff; text-decoration: underline;">..ver m√°s</span>`;
                container.innerHTML = fullContentHTML;
                const seeMoreOverlay = document.createElement('div');
                seeMoreOverlay.classList.add('see-more-overlay');
                seeMoreOverlay.innerHTML = linkHTMLModal;
                seeMoreOverlay.style.cssText = `
                    position: absolute; bottom: 1px; right: 6px; 
                    background: linear-gradient(to right, transparent 0%, ${getComputedStyle(container).backgroundColor || '#f9f9f9'} 20%, ${getComputedStyle(container).backgroundColor || '#f9f9f9'} 100%);
                    padding-left: 20px;
                    line-height: ${getComputedStyle(container).lineHeight || 'normal'};
                    font-size: ${getComputedStyle(container).fontSize};
                `;
                container.appendChild(seeMoreOverlay);
                container.dataset.fullContentHtml = fullContentHTML;
                container.dataset.initialMaxHeight = divNominalHeight + 'px';
                container.dataset.fullHeight = fullHeight + 'px';
            } else {
                container.style.cursor = 'default';
                container.style.maxHeight = 'none';
                container.style.overflowY = 'visible';
                container.innerHTML = fullContentHTML; // Mostrar el contenido real (no el placeholder si llegamos aqu√≠)
            }
		} else if (needsVisualTruncationForOthers) {
            container.style.cursor = 'pointer';
			container.style.maxHeight = calculatedInitialMaxHeightPx;
			container.style.overflowY = 'hidden';
			const action = 'expand';
			const linkText = '..ver m√°s';
			const linkHTML = ` ... <span class="see-more-link" data-action="${action}" style="color: #007bff; text-decoration: underline;">${linkText}</span>`;
			if (currentIsArrayAfterProcessing) {
				const ulTruncated = document.createElement('ul');
				ulTruncated.style.margin = '0';
				ulTruncated.style.paddingLeft = '20px';
				for (let i = 0; i < itemsToShow; i++) {
					const li = document.createElement('li');
					li.textContent = processedContentInput[i];
					if (i === itemsToShow - 1) { 
						const tempSpan = document.createElement('span');
						tempSpan.innerHTML = linkHTML;
						li.appendChild(tempSpan);
					}
					ulTruncated.appendChild(li);
				}
				container.appendChild(ulTruncated);
			} else {
				container.innerHTML = fullContentHTML;
				const seeMoreOverlay = document.createElement('div');
				seeMoreOverlay.classList.add('see-more-overlay');
				seeMoreOverlay.innerHTML = linkHTML;
				seeMoreOverlay.style.cssText = `
					position: absolute; bottom: 1px; right: 6px; 
					background: linear-gradient(to right, transparent 0%, ${getComputedStyle(container).backgroundColor || '#f9f9f9'} 20%, ${getComputedStyle(container).backgroundColor || '#f9f9f9'} 100%);
					padding-left: 20px; 
					line-height: ${getComputedStyle(container).lineHeight || 'normal'};
					font-size: ${getComputedStyle(container).fontSize};
				`;
				container.appendChild(seeMoreOverlay);
			}
			container.dataset.fullContentHtml = fullContentHTML;
			container.dataset.initialMaxHeight = calculatedInitialMaxHeightPx;
			container.dataset.fullHeight = fullHeight + 'px';
		} else {
			container.innerHTML = fullContentHTML; // Mostrar el contenido real
			container.style.maxHeight = 'none';
			container.style.overflowY = 'visible';
			container.style.cursor = 'default';
		}
	}
	
	function limpiarInterfazParaSeleccionCentro() {
		// Limpiar lista de pacientes y mensaje inicial
		if (pacientesList) {
            // El mensaje que se muestra aqu√≠ depende de si el selector de centros est√° visible o no.
            // Si el selector est√° visible (m√©dico con m√∫ltiples centros y ninguno seleccionado),
            // el mensaje deber√≠a ser "Seleccione un Centro M√©dico para ver pacientes."
            // Si el m√©dico tiene un solo centro y se est√° limpiando por otra raz√≥n (logout),
            // "Cargando pacientes..." o "" podr√≠a ser m√°s apropiado antes de un nuevo fetch.
            // Por ahora, un mensaje gen√©rico:
            pacientesList.innerHTML = '<li>Seleccione o cargue un centro m√©dico.</li>'; 
        }

		if (consultasBody) {
            consultasBody.innerHTML = '<tr><td colspan="6">Seleccione un paciente para ver sus consultas.</td></tr>';
        }
		
		// Limpiar informaci√≥n detallada del paciente en la vista principal
		document.getElementById('infoNombreCompleto').textContent = '';
        document.getElementById('infoFechaNacimiento').textContent = '';
        document.getElementById('infoCarnet').textContent = '';
        document.getElementById('infoEdad').textContent = '';
        document.getElementById('infoTipoSangre').textContent = '';
        document.getElementById('infoTelefono').textContent = '';
        document.getElementById('infoGenero').textContent = '';
        document.getElementById('infoEstadoCivil').textContent = '';
        document.getElementById('infoDireccion').textContent = '';
        document.getElementById('infoSeguro').textContent = '';
        document.getElementById('infoOcupacion').textContent = '';
        // ... (a√±ade cualquier otro span de infoPaciente que tengas) ...

		const pacienteFotoImgReset = document.getElementById('pacienteFoto');
		if (pacienteFotoImgReset) {
            pacienteFotoImgReset.src = 'images/placeholder-paciente.png';
        }
		
		// Limpiar Vacunas, Alergias, Antecedentes y resetear sus estilos/estados
		const listaVacunasDivClean = document.getElementById('listaVacunasAplicadas'); // Usando el ID correcto
		const infoAlergiasDivClean = document.getElementById('infoAlergias');
		const infoAntecedentesDivClean = document.getElementById('infoAntecedentes');

		[listaVacunasDivClean, infoAlergiasDivClean, infoAntecedentesDivClean].forEach(div => {
			if (div) {
				div.innerHTML = ''; // O un placeholder como '<small>N/A</small>' o espec√≠fico del campo
				div.classList.remove('expanded'); // Si usabas esta clase para expansi√≥n inline
				
                // Resetear estilos importantes a sus valores por defecto o controlados por CSS
                div.style.maxHeight = ''; // Quitar maxHeight para que CSS lo controle
                div.style.cursor = 'default';
                
                // Para Antecedentes, queremos overflow-y: auto; para otros, quiz√°s 'hidden' o 'visible'
                if (div.id === 'infoAntecedentes') {
                    div.style.overflowY = 'auto'; // Asegurar scroll para Antecedentes si tiene CSS height
                } else {
                    div.style.overflowY = 'hidden'; // O 'visible' seg√∫n tu dise√±o por defecto para otros
                }

                // Limpiar datasets de la l√≥gica de expansi√≥n si exist√≠an
				delete div.dataset.fullContentHtml;
				delete div.dataset.initialMaxHeight;
				delete div.dataset.fullHeight;
			}
		});

		if (startBtn) {
            startBtn.disabled = true; // Deshabilitar grabaci√≥n hasta seleccionar paciente
        }
		resetRecordingState(); // Tu funci√≥n para resetear los controles de grabaci√≥n de audio

		selectedPacienteData = null;    // Limpiar datos del paciente seleccionado globalmente
		selectedCentroMedicoId = null; // Importante resetear el centro seleccionado globalmente

        // Resetear selector de centros (si existe y est√° visible para el m√©dico)
		if (selectCentroMedicoDropdown) {
            // No limpiar las opciones si el m√©dico tiene m√∫ltiples y necesita elegir.
            // Solo resetear el valor seleccionado si es apropiado.
            // selectCentroMedicoDropdown.value = ""; // Podr√≠a hacer que se dispare onchange
            // Considera si el mensaje en pacientesList es suficiente indicador.
            // Si el m√©dico tiene m√∫ltiples centros, este dropdown se poblar√° de nuevo o ya estar√° poblado.
            // Si tiene uno solo, el container del dropdown estar√° oculto.
        }
		if (centroMedicoSelectorContainerDiv) {
            // La visibilidad de esto se maneja en la l√≥gica de login
            // No necesariamente se oculta siempre aqu√≠.
        }
		
		if (sidebarCentroMedicoLogoImg) {
            sidebarCentroMedicoLogoImg.src = 'images/logo_circular.png'; // Logo gen√©rico inicial
        }

        // Ocultar vistas principales
		if(vistaMedicoDiv) vistaMedicoDiv.style.display = 'none';
		if(vistaAdministradorDiv) vistaAdministradorDiv.style.display = 'none';
		
        // Limpiar info espec√≠fica del admin
        if(adminCentroMedicoNombreSpan) adminCentroMedicoNombreSpan.textContent = '';
		if(tablaPacientesAdminBody) tablaPacientesAdminBody.innerHTML = '<tr><td colspan="13"></td></tr>'; // Ajusta colspan
        if(tablaMedicosAdminBody) tablaMedicosAdminBody.innerHTML = '<tr><td colspan="11"></td></tr>'; // Ajusta colspan

        // --- L√ìGICA A√ëADIDA PARA RESETEAR CONTROLES DE B√öSQUEDA DE PACIENTES ---
        // Aseg√∫rate que 'inputBuscarPacienteEl' est√© definido en un √°mbito accesible
        if (typeof inputBuscarPacienteEl !== 'undefined' && inputBuscarPacienteEl) { 
            inputBuscarPacienteEl.value = ''; // Limpiar el campo de b√∫squeda
        }
        // Aseg√∫rate que 'actualizarEstadoControlesBusquedaPaciente' est√© definida
        if (typeof actualizarEstadoControlesBusquedaPaciente === 'function') {
            actualizarEstadoControlesBusquedaPaciente(false); // Ocultar/deshabilitar controles de b√∫squeda
        }
        // --- FIN DE L√ìGICA A√ëADIDA ---
	}
	
	function poblarSelectorCentrosMedicos() {
		if (!selectCentroMedicoDropdown || !medicoCentrosMedicos) return;

		selectCentroMedicoDropdown.innerHTML = '<option value="">-- Elija un Centro --</option>';
		medicoCentrosMedicos.forEach(centro => {
			const option = document.createElement('option');
			option.value = centro.id;
			option.textContent = centro.nombre;
			option.dataset.logo = centro.logo || 'images/logo_circular.png'; // Guardar el logo en dataset
			selectCentroMedicoDropdown.appendChild(option);
		});
	}
	
    function habilitarEdicionDetallesConsulta() {
        const motivoDisplay = document.getElementById('detallesConsultaMotivoDisplay');
        const motivoEdit = document.getElementById('detallesConsultaMotivoEdit');
        const diagnosticoDisplay = document.getElementById('detallesConsultaDiagnosticoDisplay');
        const diagnosticoEdit = document.getElementById('detallesConsultaDiagnosticoEdit');
        const tratamientoDisplay = document.getElementById('detallesConsultaTratamientoDisplay');
        const tratamientoEdit = document.getElementById('detallesConsultaTratamientoEdit');

        const btnEditar = document.getElementById('btnEditarDetallesConsultaModal');
        const btnGuardar = document.getElementById('btnGuardarCambiosDetallesConsulta');
        const btnCancelarEdicion = document.getElementById('btnCancelarEdicionDetallesConsulta');
        const btnCerrar = document.getElementById('btnCerrarModalDetallesConsulta'); // Bot√≥n de cerrar principal del modal

        // Poblar textareas con contenido actual (de camposOriginalesDetallesConsulta)
        motivoEdit.value = camposOriginalesDetallesConsulta.motivo;
        diagnosticoEdit.value = camposOriginalesDetallesConsulta.diagnostico;
        tratamientoEdit.value = camposOriginalesDetallesConsulta.tratamiento;

        // Cambiar visibilidad
        motivoDisplay.style.display = 'none'; motivoEdit.style.display = 'block';
        diagnosticoDisplay.style.display = 'none'; diagnosticoEdit.style.display = 'block';
        tratamientoDisplay.style.display = 'none'; tratamientoEdit.style.display = 'block';

        btnEditar.style.display = 'none'; // Ocultar l√°piz
        btnGuardar.style.display = 'inline-block';
        btnCancelarEdicion.style.display = 'inline-block';
        btnCerrar.style.display = 'none'; // Ocultar el bot√≥n de cerrar principal durante la edici√≥n
    }

    function cancelarEdicionDetallesConsulta() {
        const motivoDisplay = document.getElementById('detallesConsultaMotivoDisplay');
        const motivoEdit = document.getElementById('detallesConsultaMotivoEdit');
        const diagnosticoDisplay = document.getElementById('detallesConsultaDiagnosticoDisplay');
        const diagnosticoEdit = document.getElementById('detallesConsultaDiagnosticoEdit');
        const tratamientoDisplay = document.getElementById('detallesConsultaTratamientoDisplay');
        const tratamientoEdit = document.getElementById('detallesConsultaTratamientoEdit');
        const errorMsgP = document.getElementById('detallesConsultaError');


        const btnEditar = document.getElementById('btnEditarDetallesConsultaModal');
        const btnGuardar = document.getElementById('btnGuardarCambiosDetallesConsulta');
        const btnCancelarEdicion = document.getElementById('btnCancelarEdicionDetallesConsulta');
        const btnCerrar = document.getElementById('btnCerrarModalDetallesConsulta');

        // Restaurar contenido original a los divs de display (ya deber√≠a estar ah√≠, pero por si acaso)
        // motivoDisplay.innerHTML = camposOriginalesDetallesConsulta.motivo.replace(/\n/g, '<br>');
        // diagnosticoDisplay.innerHTML = camposOriginalesDetallesConsulta.diagnostico.replace(/\n/g, '<br>');
        // tratamientoDisplay.innerHTML = camposOriginalesDetallesConsulta.tratamiento.replace(/\n/g, '<br>');

        // Cambiar visibilidad
        motivoDisplay.style.display = 'block'; motivoEdit.style.display = 'none';
        diagnosticoDisplay.style.display = 'block'; diagnosticoEdit.style.display = 'none';
        tratamientoDisplay.style.display = 'block'; tratamientoEdit.style.display = 'none';
        
        if(errorMsgP) errorMsgP.textContent = ''; // Limpiar mensaje de error

        btnEditar.style.display = 'inline-block'; // Mostrar l√°piz
        btnGuardar.style.display = 'none';
        btnCancelarEdicion.style.display = 'none';
        btnCerrar.style.display = 'inline-block'; // Mostrar bot√≥n de cerrar principal
    }

    async function guardarCambiosDetallesConsulta() {
        const consultaId = document.getElementById('detallesConsultaRecordID').value;
        if (!consultaId) {
            alert("Error: No se pudo identificar la consulta para guardar los cambios.");
            return;
        }

        const motivoActualizado = document.getElementById('detallesConsultaMotivoEdit').value;
        const diagnosticoActualizado = document.getElementById('detallesConsultaDiagnosticoEdit').value;
        const tratamientoActualizado = document.getElementById('detallesConsultaTratamientoEdit').value;
        const errorMsgP = document.getElementById('detallesConsultaError');
        const btnGuardar = document.getElementById('btnGuardarCambiosDetallesConsulta');

        if(errorMsgP) errorMsgP.textContent = '';
        btnGuardar.disabled = true;
        btnGuardar.textContent = 'Guardando...';

        try {
            const payload = {
                action: 'updateConsultaDetalles', // Necesitar√°s una nueva acci√≥n en consultas.php
                consultaId: consultaId,
                fields: {
                    Motivo: motivoActualizado,
                    Diagnostico: diagnosticoActualizado, // Aseg√∫rate que el nombre del campo coincida con tu BD/Airtable
                    Tratamiento: tratamientoActualizado
                }
            };

            // apiConsultas debe estar definida en config.js
            const res = await fetch(apiConsultas, {
                method: 'PATCH', // O POST
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const responseData = await res.json().catch(() => ({ success: false, error: "Respuesta inv√°lida del servidor."}));

            if (!res.ok || !responseData.success) {
                throw new Error(responseData.error || `Error ${res.status} al guardar cambios.`);
            }

            // √âxito
            // Actualizar los 'camposOriginalesDetallesConsulta' con los nuevos valores
            camposOriginalesDetallesConsulta.motivo = motivoActualizado;
            camposOriginalesDetallesConsulta.diagnostico = diagnosticoActualizado;
            camposOriginalesDetallesConsulta.tratamiento = tratamientoActualizado;

            // Actualizar los divs de display
            document.getElementById('detallesConsultaMotivoDisplay').innerHTML = motivoActualizado.replace(/\n/g, '<br>');
            document.getElementById('detallesConsultaDiagnosticoDisplay').innerHTML = diagnosticoActualizado.replace(/\n/g, '<br>');
            document.getElementById('detallesConsultaTratamientoDisplay').innerHTML = tratamientoActualizado.replace(/\n/g, '<br>');

            cancelarEdicionDetallesConsulta(); // Vuelve al modo visualizaci√≥n

            // IMPORTANTE: Refrescar la tabla de consultas en la vista principal
            if (selectedPacienteData) {
                await cargarPaciente(selectedPacienteData);
            }

        } catch (error) {
            console.error("Error guardando detalles de consulta:", error);
            if(errorMsgP) errorMsgP.textContent = error.message;
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'Guardar Cambios';
        }
    }

    // --- INICIO DEL BLOQUE DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', () => {
		//console.log("DOM completamente cargado y parseado.");
        btnGestionarVacunasPaciente = document.getElementById('btnGestionarVacunasPaciente');
        modalGestionVacunas = document.getElementById('modalGestionVacunas');
        closeModalGestionVacunas = document.getElementById('closeModalGestionVacunas');
        tituloModalGestionVacunasSpan = document.querySelector('#tituloModalGestionVacunas span');
        formAnadirVacunaPaciente = document.getElementById('formAnadirVacunaPaciente');
        selectVacunaDisponible = document.getElementById('selectVacunaDisponible');
        inputFechaAplicacionVacuna = document.getElementById('inputFechaAplicacionVacuna');
        anadirVacunaErrorP = document.getElementById('anadirVacunaError');
        tablaVacunasAplicadasContainer = document.getElementById('tablaVacunasAplicadasContainer');
        tbodyVacunasDelPaciente = document.getElementById('tbodyVacunasDelPaciente');
        btnCerrarModalGestionVacunas = document.getElementById('btnCerrarModalGestionVacunas');
        
        btnEditarAlergiasPaciente = document.getElementById('btnEditarAlergiasPaciente');
        modalEditarAlergias = document.getElementById('modalEditarAlergias');
        closeModalEditarAlergias = document.getElementById('closeModalEditarAlergias');
        tituloModalEditarAlergiasSpan = document.querySelector('#tituloModalEditarAlergias span');
        formEditarAlergias = document.getElementById('formEditarAlergias');
        textareaAlergias = document.getElementById('textareaAlergias');
        editarAlergiasErrorP = document.getElementById('editarAlergiasError');
        btnCancelarEditarAlergias = document.getElementById('btnCancelarEditarAlergias');

        modalVerAntecedentes = document.getElementById('modalVerAntecedentes');
        closeModalVerAntecedentes = document.getElementById('closeModalVerAntecedentes');
        btnCerrarModalAntecedentes = document.getElementById('btnCerrarModalAntecedentes');
        tituloModalVerAntecedentes = document.getElementById('tituloModalVerAntecedentes');
        modalAntecedentesNombrePaciente = document.getElementById('modalAntecedentesNombrePaciente');
        modalAntecedentesContenidoDisplay = document.getElementById('modalAntecedentesContenidoDisplay');
        formEditarAntecedentes = document.getElementById('formEditarAntecedentes');
        textareaAntecedentesEditar = document.getElementById('textareaAntecedentesEditar');
        editarAntecedentesErrorP = document.getElementById('editarAntecedentesError');
        btnGuardarAntecedentes = document.getElementById('btnGuardarAntecedentes');
        btnEditarAntecedentesPaciente = document.getElementById('btnEditarAntecedentesPaciente');
        
        modalVerDetallesConsulta = document.getElementById('modalVerDetallesConsulta');
        closeModalDetallesConsulta = document.getElementById('closeModalDetallesConsulta');
        btnCerrarModalDetallesConsulta = document.getElementById('btnCerrarModalDetallesConsulta');
        detallesConsultaFecha = document.getElementById('detallesConsultaFecha');
        detallesConsultaMotivo = document.getElementById('detallesConsultaMotivo');
        detallesConsultaDiagnostico = document.getElementById('detallesConsultaDiagnostico');
        detallesConsultaTratamiento = document.getElementById('detallesConsultaTratamiento');
        
		if (loginForm) {
            loginForm.onsubmit = async (event) => {
                event.preventDefault();
                const login = loginUsuarioInput.value.trim();
                const password = loginPasswordInput.value.trim();
                loginErrorP.textContent = '';
                const btnLogin = document.getElementById('btnLogin');
                btnLogin.disabled = true;
                btnLogin.textContent = 'Verificando...';

                if (!login || !password) {
                    loginErrorP.textContent = 'Por favor, ingrese usuario y contrase√±a.';
                    btnLogin.disabled = false;
                    btnLogin.textContent = 'Ingresar';
                    return;
                }

                try { 
                    // Paso 1: Autenticar al m√©dico y obtener sus datos
                    const loginPayload = new FormData();
                    loginPayload.append('action', 'login');
                    loginPayload.append('loginUsuario', login); // 'login' es la variable con loginUsuarioInput.value.trim()
                    loginPayload.append('loginPassword', password); // 'password' es la variable con loginPasswordInput.value.trim()
                
                    // Asumiendo que tienes una constante 'apiMedicos' definida en tu config.js o globalmente
                    // que apunta a 'https://productsonpoint.com/hce/api/medicos.php'
                    const resMedico = await fetch(apiMedicos, { 
                        method: 'POST',
                        body: loginPayload 
                        // No necesitas 'Authorization' ni 'Content-Type' para FormData con POST simple a tu PHP
                    });
                    if (!resMedico.ok) {
                        // Intenta obtener un mensaje de error del cuerpo de la respuesta del PHP
                        let errorMsg = `Error ${resMedico.status} al autenticar.`;
                        try {
                            responseBodyText = await resMedico.text(); // Lee el cuerpo como texto UNA SOLA VEZ
                            const errorData = JSON.parse(responseBodyText); // Intenta parsear el texto
                            if (errorData && errorData.error) {
                                errorMsg = errorData.error;
                            } else if (responseBodyText) { // Si no es JSON pero hay texto, incl√∫yelo (limitado)
                               errorMsg += " Respuesta del servidor: " + responseBodyText.substring(0, 200);
                            }
                        } catch (e) { // Error al parsear JSON, usa el texto crudo si existe
                            if(responseBodyText) errorMsg += " Respuesta del servidor: " + responseBodyText.substring(0, 200);
                            else errorMsg += " No se pudo obtener detalle del error del servidor.";
                        }
                        loginErrorP.textContent = errorMsg;
                        console.error("Login - Error de la API PHP:", resMedico.status, errorMsg);
                        btnLogin.disabled = false;
                        btnLogin.textContent = 'Ingresar';
                        return;
                    }
                    
                    const dataMedico = await resMedico.json(); 
                    
					if (!dataMedico.records || dataMedico.records.length === 0) {
						loginErrorP.textContent = 'Usuario o contrase√±a incorrectos.';
						btnLogin.disabled = false;
						btnLogin.textContent = 'Ingresar';
						return; // No throw, solo return para que el finally del bot√≥n no se ejecute a√∫n si hay que mostrar modal
					}
                    
                    const medico = dataMedico.records[0];
                    // console.log("LOGIN DEBUG - Campos completos del m√©dico:", JSON.stringify(medico.fields, null, 2));
					const medicoId = medico.id;
					const camposMedico = medico.fields;

					// --- INICIO: VERIFICACI√ìN DE PRIMER LOGIN ---
					if (!camposMedico.PrimerLogin || camposMedico.PrimerLogin.toLowerCase() !== 'ok') {
						// Es primer login o el flag no est√° 'ok'
						// console.log("Primer login detectado para:", camposMedico.login);
						document.getElementById('primerLoginMedicoId').value = medicoId;
						document.getElementById('primerLoginEmailMedico').value = camposMedico['EMail'] || '';
						document.getElementById('primerLoginNombreCompletoMedico').value = camposMedico.Nombres_Apellidos || `${camposMedico.Nombres || ''} ${camposMedico.Apellidos || ''}`.trim();
						document.getElementById('primerLoginLoginMedico').value = camposMedico.login || '';
						// Para el nombre del centro, si el m√©dico est√° en m√∫ltiples, tomamos el primero o necesitamos l√≥gica adicional
						// Aqu√≠ asumimos que 'CentroMedicoRazonSocial' es un array lookup y tomamos el primero.
						const nombreCentro = (camposMedico.CentroMedicoRazonSocial && camposMedico.CentroMedicoRazonSocial.length > 0) ?
											 camposMedico.CentroMedicoRazonSocial[0] : "Centro M√©dico No Especificado";
						document.getElementById('primerLoginNombreCentro').value = nombreCentro;
						document.getElementById('modalPrimerLoginPassword').style.display = 'block';
						loginScreen.style.display = 'none'; // Ocultar pantalla de login normal
						// btnLogin se reactivar√° en el finally general, pero aqu√≠ el flujo es diferente
						return; // Detener el flujo de login normal, el usuario debe cambiar contrase√±a
					}
					// --- FIN: VERIFICACI√ìN DE PRIMER LOGIN ---

					// Si PrimerLogin es 'ok', proceder con el login normal
                    loggedInMedicoId = medico.id; 
					loggedInUserType = medico.fields['TipoUser']; 
                    loggedInMedicoNombre = medico.fields.Nombres_Apellidos || 'M√©dico';
                    loggedInMedicoEspecialidad = medico.fields.Especialidad || (loggedInUserType === 'Administrador' ? 'Administrador de Centro' : 'Especialista');

                    localStorage.setItem('loggedInMedicoId', loggedInMedicoId);
                    localStorage.setItem('loggedInMedicoNombre', loggedInMedicoNombre);
                    localStorage.setItem('loggedInMedicoEspecialidad', loggedInMedicoEspecialidad);
                    
                    limpiarInterfazParaSeleccionCentro(); 
					
					if (loggedInUserType === 'Administrador') {
                        // --- L√ìGICA PARA ADMINISTRADOR ---
                        if(vistaMedicoDiv) vistaMedicoDiv.style.display = 'none';
                        if(vistaAdministradorDiv) vistaAdministradorDiv.style.display = 'block';
                        if(sidebarAdminContentDiv) sidebarAdminContentDiv.style.display = 'block';
                        if(centroMedicoSelectorContainerDiv) centroMedicoSelectorContainerDiv.style.display = 'none';
                        
                        // Asumiendo que 'camposMedico' es el objeto fields del m√©dico/admin logueado
                        const adminCentroID = camposMedico.CentrosMedicosID?.[0] || null; // Usar camposMedico
                        const adminCentroNombre = camposMedico.CentroMedicoRazonSocial?.[0] || 'Centro no asignado'; // Usar camposMedico
                        
                        let logoFileNameDelAdmin = camposMedico['Logo (de CentrosMedicosID)']?.[0]; // Nombre del archivo desde la DB
                        let urlCompletaLogoAdmin;
                    
                        if (logoFileNameDelAdmin && logoFileNameDelAdmin.trim() !== '') {
                            urlCompletaLogoAdmin = `images/${logoFileNameDelAdmin}`; // Anteponer 'images/'
                        } else {
                            urlCompletaLogoAdmin = 'images/logo_circular.png'; // Placeholder
                            logoFileNameDelAdmin = 'logo_circular.png'; // Para guardar un nombre de archivo consistente en adminCentroMedicoData si es el default
                        }
                    
                        if (!adminCentroID) {
                            loginErrorP.textContent = 'Administrador no asignado a un centro m√©dico.';
                            if(btnLogin) { // Asegurarse que btnLogin existe
                                btnLogin.disabled = false;
                                btnLogin.textContent = 'Ingresar';
                            }
                            return; 
                        }
                        
                        // En adminCentroMedicoData.logo, guardamos solo el nombre del archivo para consistencia
                        adminCentroMedicoData = { id: adminCentroID, nombre: adminCentroNombre, logo: logoFileNameDelAdmin }; 
                        
                        if(sidebarCentroMedicoLogoImg) {
                            //console.log("[Login Admin] Intentando cargar logo:", urlCompletaLogoAdmin);
                            sidebarCentroMedicoLogoImg.src = urlCompletaLogoAdmin; // Usar la URL construida
                            sidebarCentroMedicoLogoImg.onerror = function() {
                                console.warn("Error cargando logo del admin desde DB:", urlCompletaLogoAdmin, ". Usando logo por defecto.");
                                this.src = 'images/logo_circular.png';
                                this.onerror = null;
                            };
                        }
                        
                        if(adminCentroMedicoNombreSpan) adminCentroMedicoNombreSpan.textContent = adminCentroMedicoData.nombre;
                        else if (sidebarMedicoNombreH3) sidebarMedicoNombreH3.textContent = loggedInMedicoNombre; 
                        if(sidebarMedicoEspecialidadH5) sidebarMedicoEspecialidadH5.textContent = "Administrador";
                        // ... (resto de la l√≥gica para mostrar/ocultar elementos de la UI del admin) ...
                        if(adminVistaTituloH1) adminVistaTituloH1.textContent = "Panel de Administraci√≥n";
                        if(adminGestionPacientesContainerDiv) adminGestionPacientesContainerDiv.style.display = 'none';
                        if(adminGestionMedicosContainerDiv) adminGestionMedicosContainerDiv.style.display = 'none';

                    } else if (loggedInUserType === 'Medico') {
                        // --- L√ìGICA PARA M√âDICO ---
                        if(vistaMedicoDiv) vistaMedicoDiv.style.display = 'block';
                        if(vistaAdministradorDiv) vistaAdministradorDiv.style.display = 'none';
						if(sidebarMedicoContentDiv) sidebarMedicoContentDiv.style.display = 'block';
						if(sidebarAdminContentDiv) sidebarAdminContentDiv.style.display = 'none';
  
                        medicoCentrosMedicos = []; // Resetear por si acaso
                        const medicoCentrosIDs = medico.fields.CentrosMedicosID; 
                        const medicoCentrosNombres = medico.fields.CentroMedicoRazonSocial; 
                        const medicoCentrosLogos = medico.fields['Logo (de CentrosMedicosID)'];

                        if (medicoCentrosIDs && Array.isArray(medicoCentrosIDs) && medicoCentrosNombres && Array.isArray(medicoCentrosNombres)) {
                            medicoCentrosIDs.forEach((id, index) => {
                                const nombreCentro = medicoCentrosNombres[index];
                                let logoCentro = 'images/logo_circular.png';
                                if (medicoCentrosLogos && Array.isArray(medicoCentrosLogos) && medicoCentrosLogos[index]) {
                                    logoCentro = medicoCentrosLogos[index];
                                }
                                if (id && nombreCentro) {
                                    medicoCentrosMedicos.push({
                                        id: id,       
                                        nombre: nombreCentro,
                                        logo: logoCentro
                                    });
                                }
                            });
                        } else {
                            console.warn("Login (Medico) - No se encontraron 'CentrosMedicosID' o 'CentroMedicoRazonSocial' como arrays, o uno de ellos falta.");
                        }
						
                        if (medicoCentrosMedicos.length === 0) {
							loginErrorP.textContent = 'Este m√©dico no est√° asignado a ning√∫n centro m√©dico o no se pudieron cargar los datos del centro.';
                            btnLogin.disabled = false;
                            btnLogin.textContent = 'Ingresar';
                            actualizarEstadoControlesBusquedaPaciente(false);
                            return; 
						} else if (medicoCentrosMedicos.length === 1) {
							selectedCentroMedicoId = medicoCentrosMedicos[0].id;
					        const logoFileName = medicoCentrosMedicos[0].logo; 
                            let logoUrlParaUnicoCentro;
                    
                            if (logoFileName && logoFileName.trim() !== '') {
                                logoUrlParaUnicoCentro = `images/${logoFileName}`; // <--- ¬°AQU√ç DEBE ESTAR EL PREFIJO!
                            } else {
                                logoUrlParaUnicoCentro = 'images/logo_circular.png'; // Placeholder
                            }
							if(sidebarCentroMedicoLogoImg) {
                                sidebarCentroMedicoLogoImg.src = logoUrlParaUnicoCentro;
                                sidebarCentroMedicoLogoImg.onerror = function() { // A√±adir onerror aqu√≠ tambi√©n
                                    console.warn("Error cargando logo para √∫nico centro:", logoUrlParaUnicoCentro, ". Usando logo por defecto.");
                                    this.src = 'images/logo_circular.png';
                                    this.onerror = null; 
                                };
                            }
							if(centroMedicoSelectorContainerDiv) centroMedicoSelectorContainerDiv.style.display = 'none';
							fetchPacientes(selectedCentroMedicoId); 
							actualizarEstadoControlesBusquedaPaciente(true);
						} else { // M√∫ltiples centros
							if(centroMedicoSelectorContainerDiv) centroMedicoSelectorContainerDiv.style.display = 'block';
							poblarSelectorCentrosMedicos(); 
							if(sidebarCentroMedicoLogoImg) sidebarCentroMedicoLogoImg.src = 'images/logo_circular.png';
							if(pacientesList) pacientesList.innerHTML = '<li>Seleccione un Centro M√©dico para ver pacientes.</li>';
							actualizarEstadoControlesBusquedaPaciente(false);
						}
					} else if (loggedInUserType === 'Administrador') {
                        // ...
                        actualizarEstadoControlesBusquedaPaciente(false); // Los admins no usan esta b√∫squeda en el sidebar
                    } else {
                        loginErrorP.textContent = 'Tipo de usuario desconocido.';
						btnLogin.disabled = false;
						btnLogin.textContent = 'Ingresar';
                        return; // Para que el 'finally' se ejecute
                    }
                    
					// Solo ocultar loginScreen y mostrar appContainer si el login fue completamente exitoso (no primer login)
					loginScreen.style.display = 'none';
					appContainer.style.display = 'flex';
					loggedInUserNameSpan.textContent = loggedInMedicoNombre;
					if (sidebarMedicoNombreH3) sidebarMedicoNombreH3.textContent = loggedInMedicoNombre || "Dr. Desconocido";
					if (sidebarMedicoEspecialidadH5) sidebarMedicoEspecialidadH5.textContent = loggedInMedicoEspecialidad || "Especialidad no definida";
                    
                } catch (error) { // <--- ESTE ES EL CATCH PARA TODO EL BLOQUE TRY
                    console.error("Error detallado en login:", error);
                    if (!loginErrorP.textContent) { // Si no se puso un mensaje espec√≠fico antes
                        loginErrorP.textContent = error.message === 'Credenciales incorrectas.' ? 'Usuario o contrase√±a incorrectos.' : 'Error al iniciar sesi√≥n. Verifique la consola.';
                    }
                } finally { 
				    // Solo reactivar si no estamos mostrando el modal de cambio de contrase√±a
					if (document.getElementById('modalPrimerLoginPassword').style.display !== 'block') {
						btnLogin.disabled = false;
						btnLogin.textContent = 'Ingresar';
					}
                }
            };
        } else { console.error("Elemento loginForm no encontrado."); }
        
        		// Buscar carnet RRHH
        if (btnNuevoMedicoAdmin) { // Sabemos que btnNuevoMedicoAdmin NO es null
            //btnNuevoMedicoAdmin.onclick = () => {
            btnNuevoMedicoAdmin.addEventListener('click', () => {
                if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
                    if(formBuscarCarnetRrhh) formBuscarCarnetRrhh.reset();
                    if(buscarCarnetErrorP) buscarCarnetErrorP.textContent = '';
                     if(modalBuscarCarnetRrhh) modalBuscarCarnetRrhh.style.display = 'block';
                    if(buscarCarnetInput) buscarCarnetInput.focus();    
                 } else {
                    alert("Acci√≥n no permitida o no se ha identificado el centro m√©dico.");
                }
            });
        } else {
            console.error("ERROR CR√çTICO: Bot√≥n btnNuevoMedicoAdmin no encontrado DENTRO de DOMContentLoaded al intentar asignar onclick.");
        }
        
        if (closeModalBuscarCarnetRrhh) {
            closeModalBuscarCarnetRrhh.onclick = () => {
                if(modalBuscarCarnetRrhh) modalBuscarCarnetRrhh.style.display = 'none';
            };
        }
        if (btnCancelBuscarCarnetRrhh) {
            btnCancelBuscarCarnetRrhh.onclick = () => {
                if(modalBuscarCarnetRrhh) modalBuscarCarnetRrhh.style.display = 'none';
            };
        }
        
        if (formBuscarCarnetRrhh) {
            formBuscarCarnetRrhh.onsubmit = async (event) => {
                event.preventDefault();
                const carnetBuscado = buscarCarnetInput.value.trim();
                if(buscarCarnetErrorP) buscarCarnetErrorP.textContent = '';
        
                if (!carnetBuscado) {
                    if(buscarCarnetErrorP) buscarCarnetErrorP.textContent = 'Por favor, ingrese un n√∫mero de carnet.';
                    return;
                }
        
                if (!/^\d{1,12}$/.test(carnetBuscado)) {
                    if(buscarCarnetErrorP) buscarCarnetErrorP.textContent = 'El Carnet debe contener solo n√∫meros (hasta 12 d√≠gitos).';
                    // Reactivar bot√≥n si es necesario
                    if(btnSubmitBuscar) { /* ... */ }
                    return;
                }
                
                const btnSubmitBuscar = document.getElementById('btnSubmitBuscarCarnet');
                if(btnSubmitBuscar) {
                    btnSubmitBuscar.disabled = true;
                    btnSubmitBuscar.textContent = 'Buscando...';
                }
        
                try {
                    const payload = {
                        action: 'buscarMedicoPorCarnet',
                        carnet: carnetBuscado,
                        centroIdActual: adminCentroMedicoData.id // ID del centro que el admin est√° gestionando
                    };
        
                    // apiMedicos se toma de config.js
                    const res = await fetch(apiMedicos, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
        
                    const data = await res.json();
        
                    if (!res.ok) {
                        throw new Error(data.error || `Error ${res.status} del servidor.`);
                    }
        
                    if (modalBuscarCarnetRrhh) modalBuscarCarnetRrhh.style.display = 'none'; // Cerrar modal de b√∫squeda
        
                    if (data.encontrado) {
                        //console.log("RRHH ENCONTRADO. Asociado a este centro:", data.asociado_a_este_centro);
                        if (modalGestionMedico && modalGestionMedico.style.display === 'block') {
                            modalGestionMedico.style.display = 'none';
                            //console.log("Cerrando modalGestionMedico (preventivo).");
                        }
                        if (data.asociado_a_este_centro) {
                            // CASO 1: Duplicado en este centro
                            alert(`El RR.HH. ${data.nombre_completo || ''} con carnet ${carnetBuscado} ya est√° registrado en ${adminCentroMedicoData.nombre}.`);
                        } else {
                            // CASO 2: Encontrado en DB, NO en este centro
                            const confirmarHabilitacion = confirm(`El RR.HH. ${data.nombre_completo || ''} con carnet ${carnetBuscado} ya existe en la base de datos pero no est√° asignado a ${adminCentroMedicoData.nombre}.\n\n¬øDesea habilitarlo para este centro m√©dico?`);
                            if (confirmarHabilitacion) {
                                await asociarMedicoACentroExistente(data.medico_id, adminCentroMedicoData.id, carnetBuscado);
                            }
                        }
                    } else {
                        // CASO 3: No encontrado en DB, abrir modal de creaci√≥n
                        abrirModalGestionMedico(null, carnetBuscado); // Pasar carnet para pre-llenar
                    }
        
                } catch (error) {
                    console.error("Error buscando carnet de RRHH:", error);
                    if(buscarCarnetErrorP) buscarCarnetErrorP.textContent = error.message || "Error en la b√∫squeda.";
                    // No cerrar el modal de b√∫squeda si hay error para que el usuario vea el mensaje
                } finally {
                    if(btnSubmitBuscar) {
                        btnSubmitBuscar.disabled = false;
                        btnSubmitBuscar.textContent = 'Buscar';
                    }
                }
            };
        }

		// Dropdown Menu
		if (userNameDropdownBtn) {
			userNameDropdownBtn.onclick = (event) => {
				event.stopPropagation(); // Evita que el clic se propague al window inmediatamente
				userDropdownContent.style.display = userDropdownContent.style.display === 'block' ? 'none' : 'block';
			};
		}

		// Cerrar el dropdown si se hace clic fuera
		window.onclick = function(event) {
			if (userDropdownContent && userDropdownContent.style.display === 'block') {
				if (!event.target.matches('#userNameDropdownBtn') && !event.target.closest('#userNameDropdownBtn')) {
					 // Si el clic no fue en el bot√≥n ni dentro de √©l (por si el span arrow es un target)
					userDropdownContent.style.display = 'none';
				}
			}
			// Mant√©n tus otros window.onclick para cerrar otros modales aqu√≠ tambi√©n,
			// pero aseg√∫rate que no interfieran con la l√≥gica del dropdown.
			if (modalChangeUserPassword && event.target == modalChangeUserPassword) {
				modalChangeUserPassword.style.display = "none";
			}
			// ... tus otros event.target == modalXXX ...
		};

		if (logoutLink) {
			logoutLink.onclick = (e) => {
				e.preventDefault();
				if (userDropdownContent) userDropdownContent.style.display = 'none'; // Ocultar dropdown
				doLogout(); // Llamar a la funci√≥n de logout dedicada
			};
		}

		if (changePasswordLink) {
			changePasswordLink.onclick = (e) => {
				e.preventDefault();
				if (userDropdownContent) userDropdownContent.style.display = 'none';
				if (formChangeUserPassword) formChangeUserPassword.reset();
				if (changeUserPasswordErrorP) changeUserPasswordErrorP.textContent = '';
				if (changeUserPasswordSuccessP) changeUserPasswordSuccessP.textContent = '';
				if (modalChangeUserPassword) modalChangeUserPassword.style.display = 'block';
			};
		}

		if (closeModalChangeUserPassword) {
			closeModalChangeUserPassword.onclick = () => {
				if (modalChangeUserPassword) modalChangeUserPassword.style.display = 'none';
			};
		}

		if (btnCancelChangeUserPassword) {
			btnCancelChangeUserPassword.onclick = () => {
				if (modalChangeUserPassword) modalChangeUserPassword.style.display = 'none';
			};
		}
		
		function doLogout() {
			loggedInMedicoId = null;
			loggedInMedicoNombre = null;
			loggedInMedicoEspecialidad = null;
			localStorage.removeItem('loggedInMedicoId');
			localStorage.removeItem('loggedInMedicoNombre');
			localStorage.removeItem('loggedInMedicoEspecialidad');
			limpiarInterfazParaSeleccionCentro();
			// ... m√°s limpieza espec√≠fica si es necesaria ...
			
			// Ocultar todos los modales abiertos por si acaso
			document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');

			appContainer.style.display = 'none';
			loginScreen.style.display = 'flex';
			if (loginForm) loginForm.reset();
			if (loginErrorP) loginErrorP.textContent = ''; // Limpiar error de login screen
			if (forgotPasswordSectionDiv) forgotPasswordSectionDiv.style.display = 'none'; // Ocultar secci√≥n olvido pass
			if (loginFieldsDiv) loginFieldsDiv.style.display = 'block'; // Mostrar campos de login
			if (forgotPasswordLinkContainer) forgotPasswordLinkContainer.style.display = 'block';

			// Reactivar el bot√≥n de login principal de la pantalla de login
			const btnLoginPrincipal = document.getElementById('btnLogin');
			if(btnLoginPrincipal) {
				btnLoginPrincipal.disabled = false;
				btnLoginPrincipal.textContent = 'Ingresar';
			}
		}

		if (logoutLink) {
			logoutLink.onclick = (e) => {
				e.preventDefault();
				if (userDropdownContent) userDropdownContent.style.display = 'none';
				doLogout();
			};
		}

        if (formChangeUserPassword) {
            formChangeUserPassword.onsubmit = async (event) => {
                event.preventDefault();
                const btnSubmit = document.getElementById('btnSubmitChangeUserPassword');
                changeUserPasswordErrorP.textContent = '';
                changeUserPasswordSuccessP.textContent = '';
                btnSubmit.disabled = true;
                btnSubmit.textContent = 'Actualizando...';
        
                const currentPwd = document.getElementById('currentPassword').value;
                const newPwd = document.getElementById('newUserPassword').value;
                const confirmNewPwd = document.getElementById('confirmNewUserPassword').value;
        
                // Validaciones del frontend
                if (!currentPwd) {
                    changeUserPasswordErrorP.textContent = 'Por favor, ingrese su contrase√±a actual.';
                } else if (newPwd.length < 6) {
                    changeUserPasswordErrorP.textContent = 'La nueva contrase√±a debe tener al menos 6 caracteres.';
                } else if (newPwd !== confirmNewPwd) {
                    changeUserPasswordErrorP.textContent = 'Las nuevas contrase√±as no coinciden.';
                } else if (newPwd === currentPwd) {
                    changeUserPasswordErrorP.textContent = 'La nueva contrase√±a no puede ser igual a la actual.';
                }
        
                if (changeUserPasswordErrorP.textContent) {
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = 'Actualizar Contrase√±a';
                    return;
                }
        
                try {
                    // Preparar payload para tu API PHP (medicos.php?action=updatePassword)
                    const payloadParaApiPHP = {
                        action: 'updatePassword',
                        medicoId: loggedInMedicoId, // El ID del m√©dico actualmente logueado
                        currentPassword: currentPwd, // La contrase√±a actual para verificaci√≥n en backend
                        newPassword: newPwd,         // La nueva contrase√±a
                        isPrimerLogin: false,     // Indicar que NO es el flujo de primer login
                        // Datos para el email (si quieres enviar notificaci√≥n para este tipo de cambio tambi√©n)
                        // El backend (handleUpdatePassword) ya deber√≠a estar preparado para recibir estos
                        emailMedico: localStorage.getItem('loggedInUserEmail') || '', // Necesitar√≠as guardar el email en login
                        nombreCompletoMedico: loggedInMedicoNombre || '',
                        loginMedico: /* obtener login del usuario logueado si lo tienes en localStorage */ '', 
                        nombreCentro: /* obtener nombre del centro actual si es relevante */ ''
                    };
                    
                    // Recuperar datos del localStorage para el email (si no los tienes en variables globales)
                    // Si los tienes en variables globales (loggedInMedicoEmail, etc.), √∫salos.
                    const storedEmail = localStorage.getItem('loggedInUserEmail'); // Asume que guardas el email al loguear
                    const storedLogin = localStorage.getItem('loggedInUserLogin'); // Asume que guardas el login al loguear
                    const storedNombreCompleto = localStorage.getItem('loggedInMedicoNombre');
        
                    if (storedEmail) payloadParaApiPHP.emailMedico = storedEmail;
                    if (storedLogin) payloadParaApiPHP.loginMedico = storedLogin;
                    if (storedNombreCompleto) payloadParaApiPHP.nombreCompletoMedico = storedNombreCompleto;
                    // Para nombreCentro, si es un m√©dico con un solo centro, adminCentroMedicoData podr√≠a tenerlo
                    // o selectedCentroMedicoId si es m√©dico con m√∫ltiples centros.
                    // Si el m√©dico logueado es admin, adminCentroMedicoData.nombre.
                    // Si es m√©dico, y seleccion√≥ un centro, el nombre del centro est√° en el option del dropdown.
                    // Esta parte puede ser un poco m√°s compleja de obtener aqu√≠ si no est√° ya en una variable global.
                    // Por ahora, si no es cr√≠tico para el email de "cambio de contrase√±a normal", se puede omitir o poner un gen√©rico.
                    // payloadParaApiPHP.nombreCentro = "Centro M√©dico"; // Gen√©rico
        
                    //console.log("[ChangePassword] Enviando payload a API:", payloadParaApiPHP);
        
                    // apiMedicos debe estar definida en config.js
                    const resUpdate = await fetch(apiMedicos, {
                        method: 'PATCH', // O 'POST', seg√∫n tu backend para 'updatePassword'
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadParaApiPHP)
                    });
        
                    // Leer el cuerpo de la respuesta UNA SOLA VEZ
                    const responseBodyText = await resUpdate.text();
                    let responseData;
                    try {
                        responseData = JSON.parse(responseBodyText);
                    } catch (e) {
                        // Si no es JSON v√°lido, responseData contendr√° el texto crudo para depuraci√≥n
                        responseData = { error: `Respuesta inesperada del servidor: ${responseBodyText.substring(0,200)}` };
                        console.error("Error parseando JSON de updatePassword:", responseBodyText);
                    }
        
        
                    if (!resUpdate.ok || !responseData.success) {
                        const errorMsg = responseData.error || `Error ${resUpdate.status} al actualizar.`;
                        console.error("Error actualizando contrase√±a (API PHP):", resUpdate.status, errorMsg);
                        changeUserPasswordErrorP.textContent = errorMsg;
                        // No lanzar throw new Error aqu√≠ para que el finally se ejecute correctamente
                    } else {
                        changeUserPasswordSuccessP.textContent = responseData.message || '¬°Contrase√±a actualizada con √©xito!';
                        formChangeUserPassword.reset();
                        
                        // Opcional: Forzar logout para que re-ingrese con la nueva contrase√±a por seguridad
                        // alert("Contrase√±a actualizada. Por favor, inicie sesi√≥n nuevamente.");
                        // doLogout(); 
        
                        setTimeout(() => {
                            if (modalChangeUserPassword) modalChangeUserPassword.style.display = 'none';
                            changeUserPasswordSuccessP.textContent = '';
                        }, 3000);
                    }
        
                } catch (error) { // Captura errores de red o excepciones del JSON.parse si no se hizo text() antes
                    console.error("Error en el proceso de cambio de contrase√±a (catch JS):", error);
                    changeUserPasswordErrorP.textContent = error.message || "Ocurri√≥ un error inesperado.";
                } finally {
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = 'Actualizar Contrase√±a';
                }
            };
        }
		
        const formPrimerLoginPassword = document.getElementById('formPrimerLoginPassword');
        if (formPrimerLoginPassword) {
            formPrimerLoginPassword.onsubmit = async (event) => {
                event.preventDefault();
                const btnGuardarNuevoPasswordEl = document.getElementById('btnGuardarNuevoPassword');
                const primerLoginPasswordErrorP = document.getElementById('primerLoginPasswordError');
                
                btnGuardarNuevoPasswordEl.disabled = true;
                btnGuardarNuevoPasswordEl.textContent = 'Actualizando...';
                primerLoginPasswordErrorP.textContent = '';

                const medicoId = document.getElementById('primerLoginMedicoId').value; // ID del m√©dico de MySQL
                const nuevoPassword = document.getElementById('nuevoPassword').value;
                const confirmarNuevoPassword = document.getElementById('confirmarNuevoPassword').value;
                
                // Datos para el email (si la llamada al webhook se hace desde aqu√≠, pero ahora la haremos desde PHP)
                const emailMedico = document.getElementById('primerLoginEmailMedico').value;
                const nombreCompletoMedico = document.getElementById('primerLoginNombreCompletoMedico').value;
                const loginMedico = document.getElementById('primerLoginLoginMedico').value;
                const nombreCentro = document.getElementById('primerLoginNombreCentro').value;

                const passwordIngresadoOriginal = loginPasswordInput.value; // La contrase√±a con la que el usuario se logue√≥ inicialmente

                // Validaciones del frontend
                if (nuevoPassword.length < 6) {
                    primerLoginPasswordErrorP.textContent = 'La nueva contrase√±a debe tener al menos 6 caracteres.';
                } else if (nuevoPassword !== confirmarNuevoPassword) {
                    primerLoginPasswordErrorP.textContent = 'Las contrase√±as no coinciden.';
                } else if (nuevoPassword === passwordIngresadoOriginal) {
                    // Esta validaci√≥n es √∫til, pero la contrase√±a original ya fue verificada
                    // y el usuario est√° estableciendo una completamente nueva.
                    // Podr√≠as mantenerla o quitarla si el flujo es claro.
                    primerLoginPasswordErrorP.textContent = 'La nueva contrase√±a no puede ser igual a la anterior.';
                }

                if (primerLoginPasswordErrorP.textContent) {
                    btnGuardarNuevoPasswordEl.disabled = false;
                    btnGuardarNuevoPasswordEl.textContent = 'Actualizar Contrase√±a';
                    return;
                }

                try {
                    // 1. Preparar payload para tu API PHP (medicos.php?action=updatePassword)
                    const payloadParaApiPHP = {
                        action: 'updatePassword',
                        medicoId: medicoId,        // El ID del m√©dico de tu tabla MySQL
                        newPassword: nuevoPassword,
                        isPrimerLogin: true,      // Flag para que el backend sepa actualizar 'PrimerLogin' a 'ok'
                        // Datos adicionales para el email que el backend PHP pasar√° al webhook de n8n
                        emailMedico: emailMedico,
                        nombreCompletoMedico: nombreCompletoMedico,
                        loginMedico: loginMedico,
                        nombreCentro: nombreCentro
                        // No necesitas enviar 'currentPassword' si isPrimerLogin es true, 
                        // ya que el login inicial ya valid√≥ la contrase√±a original.
                    };
                    
                   // console.log("[PrimerLogin] Enviando payload a API para actualizar password:", payloadParaApiPHP);

                    // apiMedicos debe estar definida en config.js
                    const resUpdate = await fetch(apiMedicos, {
                        method: 'PATCH', // O 'POST' si tu backend est√° configurado para eso con la acci√≥n
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadParaApiPHP)
                    });

                    if (!resUpdate.ok) {
                        let errorMsg = `Error ${resUpdate.status} al actualizar.`;
                        try {
                            const errorData = await resUpdate.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) { 
                            const textError = await resUpdate.text();
                            errorMsg += " " + (textError || "Error desconocido del servidor.");
                        }
                        console.error("Error actualizando password (API PHP):", errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    const responseData = await resUpdate.json();
                    // console.log("[PrimerLogin] Respuesta de API updatePassword:", responseData);

                    if (responseData.success) {
                        // El email de notificaci√≥n ahora se env√≠a desde el backend (handleUpdatePassword en medicos.php)
                        alert("Contrase√±a actualizada con √©xito. Ahora ser√° redirigido a la aplicaci√≥n.");
                        document.getElementById('modalPrimerLoginPassword').style.display = 'none';
                        formPrimerLoginPassword.reset();
                        loginPasswordInput.value = nuevoPassword; // Actualizar el campo de la pantalla de login
                        loginForm.requestSubmit(); // Re-ejecutar onsubmit de loginForm para entrar a la app
                    } else {
                        throw new Error(responseData.error || "No se pudo actualizar la contrase√±a (respuesta del servidor).");
                    }

                } catch (error) {
                    console.error("Error en el proceso de cambio de contrase√±a del primer login (catch JS):", error);
                    primerLoginPasswordErrorP.textContent = error.message || "Ocurri√≥ un error inesperado.";
                } finally {
                    btnGuardarNuevoPasswordEl.disabled = false;
                    btnGuardarNuevoPasswordEl.textContent = 'Actualizar Contrase√±a';
                }
            };
        } else { 
            console.error("Elemento formPrimerLoginPassword no encontrado."); 
        }
		
	   const btnCancelarPrimerLogin = document.getElementById('btnCancelarPrimerLogin');
		if (btnCancelarPrimerLogin) {
			btnCancelarPrimerLogin.onclick = () => {
				const modalPrimerLogin = document.getElementById('modalPrimerLoginPassword');
				const pantallaLogin = document.getElementById('loginScreen');
				const btnLoginPrincipal = document.getElementById('btnLogin'); // Bot√≥n de la pantalla de login

				if (modalPrimerLogin) {
					modalPrimerLogin.style.display = 'none';
					// Opcional: resetear el formulario del modal de cambio de contrase√±a
					const formCambioPwd = document.getElementById('formPrimerLoginPassword');
					if (formCambioPwd) formCambioPwd.reset();
					const errorMsgCambioPwd = document.getElementById('primerLoginPasswordError');
					if (errorMsgCambioPwd) errorMsgCambioPwd.textContent = '';
				}
				if (pantallaLogin) {
					pantallaLogin.style.display = 'flex'; // Mostrar la pantalla de login
				}
				if (loginForm) {
					loginForm.reset(); // Resetear el formulario de login principal
				}
				if (loginErrorP) {
					loginErrorP.textContent = ''; // Limpiar mensajes de error del login principal
				}

				// Reactivar el bot√≥n de login principal
				if (btnLoginPrincipal) {
					btnLoginPrincipal.disabled = false;
					btnLoginPrincipal.textContent = 'Ingresar';
				}
			};
		} else {
			console.error("Elemento btnCancelarPrimerLogin no encontrado.");
		}
		
		// Manejador para el enlace "Olvid√≥ su Contrase√±a"
		if (forgotPasswordLink) {
			forgotPasswordLink.onclick = (e) => {
				e.preventDefault();
				if (loginFieldsDiv) loginFieldsDiv.style.display = 'none';
				if (forgotPasswordLinkContainer) forgotPasswordLinkContainer.style.display = 'none'; // Ocultar el propio enlace
				if (forgotPasswordSectionDiv) forgotPasswordSectionDiv.style.display = 'block';
				if (loginErrorP) loginErrorP.textContent = ''; // Limpiar errores de login previos
				if (forgotPasswordMessageP) forgotPasswordMessageP.textContent = ''; // Limpiar mensajes previos de olvido
			};
		}

		// Manejador para el enlace "Volver a Iniciar Sesi√≥n"
		if (backToLoginLink) {
			backToLoginLink.onclick = (e) => {
				e.preventDefault();
				if (forgotPasswordSectionDiv) forgotPasswordSectionDiv.style.display = 'none';
				if (loginFieldsDiv) loginFieldsDiv.style.display = 'block'; // O 'flex' si usabas flex para el form
				if (forgotPasswordLinkContainer) forgotPasswordLinkContainer.style.display = 'block'; // Mostrar de nuevo el enlace
				if (forgotPasswordMessageP) forgotPasswordMessageP.textContent = '';
			};
		}

		// Manejador para el bot√≥n "Enviar Contrase√±a"
		if (btnSendPasswordReminder) {
			btnSendPasswordReminder.onclick = async () => {
				const email = forgotPasswordEmailInput.value.trim();
				forgotPasswordMessageP.textContent = '';
				forgotPasswordMessageP.className = ''; // Reset class

				if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
					forgotPasswordMessageP.textContent = 'Por favor, ingrese un correo electr√≥nico v√°lido.';
					forgotPasswordMessageP.className = 'error';
					return;
				}

				btnSendPasswordReminder.disabled = true;
				btnSendPasswordReminder.textContent = 'Verificando...';

				try {
                    const payload = {
                        action: 'forgotPassword', // La acci√≥n para tu script medicos.php
                        emailMedico: email
                    };
        
                    // apiMedicos debe estar definida en config.js
                    const res = await fetch(apiMedicos, {
                        method: 'POST', // Usar POST para enviar el email en el cuerpo
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
        
                    // Siempre asumimos que la respuesta de la API PHP es JSON
                    const responseData = await res.json();
        
                    if (!res.ok || !responseData.success) { // Si el HTTP status no es OK o el payload indica error
                        const errorMsg = responseData.error || "Error al procesar la solicitud.";
                        console.error("Error en olvido de contrase√±a (API):", res.status, errorMsg);
                        forgotPasswordMessageP.textContent = errorMsg;
                        forgotPasswordMessageP.className = 'error';
                    } else {
                        // √âxito (o mensaje gen√©rico si el PHP lo devuelve as√≠)
                        forgotPasswordMessageP.textContent = responseData.message;
                        forgotPasswordMessageP.className = 'success';
                        forgotPasswordEmailInput.value = ''; 
                    }
        
                } catch (error) {
                    console.error("Error en el proceso de olvido de contrase√±a (catch JS):", error);
                    forgotPasswordMessageP.textContent = "Ocurri√≥ un error de red. Por favor, intente de nuevo.";
                    forgotPasswordMessageP.className = 'error';
                } finally {
                    btnSendPasswordReminder.disabled = false;
                    btnSendPasswordReminder.textContent = 'Enviar Contrase√±a';
                }
            };
        }

        if (closeModalNuevoPaciente) {
            closeModalNuevoPaciente.onclick = () => { modalNuevoPaciente.style.display = 'none'; };
        } else { console.error("Elemento closeModalNuevoPaciente no encontrado."); }

        if (btnCancelarNuevoPaciente) {
            btnCancelarNuevoPaciente.onclick = () => { modalNuevoPaciente.style.display = 'none'; };
        } else { console.error("Elemento btnCancelarNuevoPaciente no encontrado."); }

        if (formNuevoPaciente) {
            formNuevoPaciente.onsubmit = async (event) => {
                event.preventDefault();
                nuevoPacienteErrorP.textContent = '';
                nuevoPacienteSuccessP.textContent = '';
                const btnGuardar = document.getElementById('btnGuardarPaciente');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Validando c√≥digo...';
        
                const codigoActivacionIngresado = pacienteCodigoActivacionInput.value.trim();
                // Validar formato del c√≥digo (ej. 6 caracteres alfanum√©ricos, ajusta el regex si es solo num√©rico)
                if (!codigoActivacionIngresado || !/^[A-Za-z0-9]{6}$/.test(codigoActivacionIngresado)) {
                    nuevoPacienteErrorP.textContent = 'Ingrese un C√≥digo de Activaci√≥n v√°lido (6 caracteres).';
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Paciente';
                    return;
                }

                let idCentroDelCodigo = null;
                let nombreCentroDelCodigo = "Centro M√©dico Desconocido"; // Variable para almacenar el nombre del centro
        
                try {
                    // ETAPA 1: Validar el C√≥digo de Activaci√≥n y obtener el CentroMedicoID desde tu API PHP
                    // apiCodigos debe estar definida en config.js y apuntar a tu codigos.php
                    const payloadValidarCodigo = {
                        action: 'validarCodigoPaciente',
                        codigo: codigoActivacionIngresado,
                        adminCentroIdActual: (loggedInUserType === 'Administrador' ? adminCentroMedicoData?.id : null) 
                    };
                    
                    //console.log("[Nuevo Paciente] Validando c√≥digo con API PHP:", payloadValidarCodigo);
                    const resValidacion = await fetch(apiCodigos, { // Usa tu constante apiCodigos
                        method: 'POST', // O 'GET' si tu PHP lo espera as√≠ para esta acci√≥n
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadValidarCodigo)
                    });
        
                    // Leer el cuerpo de la respuesta UNA SOLA VEZ
                    const resValidacionBodyText = await resValidacion.text();
                    let dataValidacion;
                    try {
                        dataValidacion = JSON.parse(resValidacionBodyText);
                    } catch (e) {
                        dataValidacion = { success: false, message: `Respuesta inesperada del servidor al validar c√≥digo: ${resValidacionBodyText.substring(0,100)}`};
                        console.error("Error parseando JSON de validaci√≥n de c√≥digo:", resValidacionBodyText);
                    }
        
                    if (!resValidacion.ok || !dataValidacion.success || !dataValidacion.centroMedicoId) {
                        nuevoPacienteErrorP.textContent = dataValidacion.message || `Error ${resValidacion.status} al validar c√≥digo.`;
                        console.error("[Nuevo Paciente] Fall√≥ validaci√≥n de c√≥digo (API PHP):", dataValidacion);
                        throw new Error('Validaci√≥n de c√≥digo fallida.');
                    }
                    
                    idCentroDelCodigo = dataValidacion.centroMedicoId;
                    // El codigoActivacionValidado que devuelve el PHP es el mismo que codigoActivacionIngresado
                    //console.log("[Nuevo Paciente] C√≥digo validado por API PHP. Centro ID:", idCentroDelCodigo);
                    // ASUMIMOS que tu API PHP en 'validarCodigoPaciente' ahora tambi√©n devuelve 'nombreCentro'
                    if (dataValidacion.nombreCentro) {
                        nombreCentroDelCodigo = dataValidacion.nombreCentro;
                    }
                    //console.log("[Nuevo Paciente] C√≥digo validado. Centro ID:", idCentroDelCodigo, "Nombre Centro:", nombreCentroDelCodigo);
        
                    btnGuardar.textContent = 'Guardando Paciente...';
        
                    // ETAPA 2: Preparar y enviar datos del paciente para creaci√≥n a tu API PHP
                    const formData = new FormData(formNuevoPaciente);
                    const pacienteFields = {
                        // El 'Id' del paciente ser√° el c√≥digo de activaci√≥n.
                        // Tu backend (pacientes.php -> handleCreatePaciente) espera esto como 'Id' dentro de 'pacienteData'.
                        Id: parseInt(codigoActivacionIngresado, 10) // Asumiendo que el C√≥digo es num√©rico y Pacientes.Id es INT
                                                                    // Si CodigosActivacion.Codigo es VARCHAR, no necesitas parseInt.
                    };
        
                    // Recolectar otros campos del formulario
                    for (let [key, value] of formData.entries()) {
                        if (key === "ID") continue; // Ya lo establecimos como 'Id' en pacienteFields
        
                        // Mapear nombres de campo del formulario a nombres de columna de la DB si son diferentes
                        // y asegurar el tipo de dato correcto para el backend.
                        if (key === "Seguro") {
                            if (value) pacienteFields.SeguroID = parseInt(value, 10); else pacienteFields.SeguroID = null;
                        } else if (key === "Fecha Nacimiento") { // El name del input es "Fecha Nacimiento"
                            pacienteFields.Fecha_Nacimiento = value; // Enviar como YYYY-MM-DD
                        } else if (key === "Tipo Sangre") {
                            pacienteFields.Tipo_Sangre = value;
                        } else if (key === "Estado Civil") {
                            pacienteFields.Estado_Civil = value;
                        } else if (key === "Tel√©fono") { // El name del input es "Tel√©fono"
                            pacienteFields.Telefono = String(value); // Nombre de columna MySQL 'Telefono'
                        } else {
                             pacienteFields[key] = value; // Para Nombres, Apellidos, Carnet, Genero, Direccion, Vacunas, Alergias, Antecedentes
                        }
                    }
                     // (La l√≥gica de eliminar campos vac√≠os opcionales ya no es necesaria aqu√≠ si el backend los maneja)
                     
                                    
                    const carnetPaciente = pacienteFields.Carnet;
                    if (!carnetPaciente || !/^\d{1,12}$/.test(carnetPaciente)) { // Verificar que exista y cumpla el patr√≥n
                        nuevoPacienteErrorP.textContent = 'El Documento Id. (Carnet) es obligatorio y debe contener solo n√∫meros (hasta 12 d√≠gitos).';
                        btnGuardar.disabled = false;
                        btnGuardar.textContent = 'Guardar Paciente';
                        return;
                    }
        
                    if (!pacienteFields.Nombres || !pacienteFields.Apellidos || !pacienteFields.Carnet) {
                       nuevoPacienteErrorP.textContent = 'Nombres, Apellidos y Documento Id. son obligatorios.';
                       throw new Error('Campos obligatorios faltantes.');
                    }
        
                    const payloadCrearPaciente = {
                        action: 'createPaciente',
                        pacienteData: pacienteFields, 
                        centroMedicoIdParaAsociacion: idCentroDelCodigo, // El CentroID obtenido del c√≥digo de activaci√≥n
                        codigoActivacionUsado: codigoActivacionIngresado // El c√≥digo que se va a marcar como usado
                    };
                    
                    //console.log("[Nuevo Paciente] Payload para crear paciente (API PHP):", JSON.stringify(payloadCrearPaciente, null, 2));
        
                    // apiPacientes debe estar definida en config.js
                    const resCrearPaciente = await fetch(apiPacientes, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadCrearPaciente)
                    });
                    
                    const resCrearPacienteBodyText = await resCrearPaciente.text();
                    let dataCrearPaciente;
                    let isJsonParseSuccessful = false;
                    try {
                        dataCrearPaciente = JSON.parse(resCrearPacienteBodyText);
                        isJsonParseSuccessful = true;
                    } catch (e) {
                        dataCrearPaciente = { success: false, error: `Respuesta inesperada del servidor: ${resCrearPacienteBodyText.substring(0,200)}`};
                        console.error("Error parseando JSON de creaci√≥n de paciente:", resCrearPacienteBodyText);
                    }
        
                    if (!resCrearPaciente.ok || !dataCrearPaciente.success) {
                        nuevoPacienteErrorP.textContent = dataCrearPaciente.error || `Error ${resCrearPaciente.status} al crear paciente.`;
                        console.error("[Nuevo Paciente] Fall√≥ creaci√≥n de paciente (API PHP):", dataCrearPaciente);
                        throw new Error('Error al crear paciente.'); 
                    } else if (isJsonParseSuccessful && !dataCrearPaciente.success) { // Si HTTP es OK pero el payload JSON indica fallo
                        nuevoPacienteErrorP.textContent = dataCrearPaciente.error || "El servidor indic√≥ un error al crear el paciente.";
                        console.error("[Nuevo Paciente] Fall√≥ creaci√≥n de paciente (API Logic Error):", dataCrearPaciente);
                        throw new Error('Error l√≥gico de API al crear paciente.');
                    } else if (!isJsonParseSuccessful) { // Si HTTP es OK pero no se pudo parsear el JSON
                         nuevoPacienteErrorP.textContent = dataCrearPaciente.error; // Usar√° el mensaje del catch del parse
                         console.error("[Nuevo Paciente] Fall√≥ creaci√≥n de paciente (JSON Parse Error):", dataCrearPaciente);
                         throw new Error('Respuesta inv√°lida del servidor.');
                    } else {
                        // √âXITO
                        //console.log("[Nuevo Paciente] Paciente creado API PHP response:", dataCrearPaciente);
                        // ...
                    }
                    
                    // console.log("[Nuevo Paciente] Paciente creado API PHP response:", dataCrearPaciente);
        
                    nuevoPacienteSuccessP.textContent = `¬°Paciente guardado con √©xito para el ${nombreCentroDelCodigo}!`;
                    formNuevoPaciente.reset();
                    
                    // Refrescar lista de pacientes si es el admin y est√° viendo ese centro
                    if (loggedInUserType === 'Administrador') {
                        // Si el usuario actual es un administrador Y
                        // el paciente fue a√±adido al centro que el administrador est√° viendo actualmente
                        if (adminCentroMedicoData && adminCentroMedicoData.id && adminCentroMedicoData.id.toString() === idCentroDelCodigo.toString()) {
                            // Y la vista de gesti√≥n de pacientes est√° activa
                            if (adminGestionPacientesContainerDiv && adminGestionPacientesContainerDiv.style.display === 'block') {
                                //console.log("[Nuevo Paciente] Administrador refrescando lista de pacientes para el centro:", idCentroDelCodigo);
                                fetchPacientesAdmin(adminCentroMedicoData.id); // Llama a la funci√≥n que carga la tabla de admin
                            }
                        }
                    } 
                    // No es necesario refrescar para el m√©dico ya que √©l no tiene el bot√≥n de nuevo paciente.
        
                    setTimeout(() => { 
                        if(modalNuevoPaciente) modalNuevoPaciente.style.display = 'none';
                        if(nuevoPacienteSuccessP) nuevoPacienteSuccessP.textContent = '';
                    }, 3000);
        
                } catch (error) {
                    console.error('Error en submit nuevo paciente (catch JS):', error);
                    if (!nuevoPacienteErrorP.textContent) {
                       nuevoPacienteErrorP.textContent = error.message || 'Error al procesar el registro.';
                    }
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Paciente';
                }
            };
        } else { console.error("Elemento formNuevoPaciente no encontrado."); }
        
        if (closeModalDetallesConsulta) {
            closeModalDetallesConsulta.onclick = () => { modalVerDetallesConsulta.style.display = 'none'; };
        }
        if (btnCerrarModalDetallesConsulta) {
            btnCerrarModalDetallesConsulta.onclick = () => { modalVerDetallesConsulta.style.display = 'none'; };
        }
        
        if (closeModalCambiarFoto) {
            closeModalCambiarFoto.onclick = () => { modalCambiarFoto.style.display = 'none'; };
        } else { console.error("Elemento closeModalCambiarFoto no encontrado."); }

        if (btnCancelarCambiarFoto) {
            btnCancelarCambiarFoto.onclick = () => { modalCambiarFoto.style.display = 'none'; };
        } else { console.error("Elemento btnCancelarCambiarFoto no encontrado."); }

        function construirUrlFoto(fotoFieldName) {
            if (!fotoFieldName) return 'images/placeholder-paciente.png';
            // Ajusta esta l√≥gica seg√∫n c√≥mo construyes la URL de la foto en otros lugares
            if (!fotoFieldName.startsWith('uploads/fotos_pacientes/') && !fotoFieldName.startsWith('images/')) {
                return `uploads/fotos_pacientes/${fotoFieldName}`;
            }
            return fotoFieldName;
        }
        
        if (pacienteArchivoFotoInput) {
            pacienteArchivoFotoInput.onchange = (event) => {
                const file = event.target.files[0];
                const MAX_SIZE_KB = 100;
                const MAX_SIZE_BYTES = MAX_SIZE_KB * 1024;
        
                // Resetear mensaje de error y previsualizaci√≥n
                if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = '';
                const fotoOriginalSrc = (pacienteParaActualizarFotoAdmin && pacienteParaActualizarFotoAdmin.fields && pacienteParaActualizarFotoAdmin.fields.Foto) 
                                        ? construirUrlFoto(pacienteParaActualizarFotoAdmin.fields.Foto) 
                                        : 'images/placeholder-paciente.png';
                if(fotoPreviewImg) fotoPreviewImg.src = fotoOriginalSrc; // Volver a la original o placeholder
                archivoFotoSeleccionado = null; // Resetear por si falla la validaci√≥n
        
                if (file) {
                    // 1. Validar tipo de archivo
                    if (file.type !== "image/jpeg" && file.type !== "image/jpg") {
                        if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = `Formato no v√°lido. Solo JPEG. (Tipo detectado: ${file.type || 'desconocido'})`;
                        pacienteArchivoFotoInput.value = null; // Limpiar selecci√≥n inv√°lida
                        return;
                    }
        
                    // 2. Validar tama√±o del archivo
                    if (file.size > MAX_SIZE_BYTES) {
                        if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = `Archivo demasiado grande. M√°ximo ${MAX_SIZE_KB}KB. (Tama√±o: ${(file.size / 1024).toFixed(1)}KB)`;
                        pacienteArchivoFotoInput.value = null; // Limpiar selecci√≥n inv√°lida
                        return;
                    }
        
                    // Si pasa ambas validaciones:
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        if(fotoPreviewImg) fotoPreviewImg.src = e.target.result; 
                    }
                    reader.readAsDataURL(file);
                    archivoFotoSeleccionado = file; // Guardar el objeto File completo para el submit
        
                } else {
                    // No se seleccion√≥ archivo (o se cancel√≥ la selecci√≥n), no hay error que mostrar aqu√≠.
                    // El fotoPreviewImg ya se resete√≥ arriba.
                }
            };
        }

        if (formCambiarFoto) {
            formCambiarFoto.onsubmit = async (event) => {
                event.preventDefault();
                // Usar pacienteParaActualizarFotoAdmin en lugar de selectedPacienteData
                if (!pacienteParaActualizarFotoAdmin || !pacienteArchivoFotoInput.files[0]) {
                    if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = 'Seleccione un paciente y una imagen.';
                    return;
                }
                const archivoParaSubir = pacienteArchivoFotoInput.files[0];
        
                if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = '';
                if(cambiarFotoSuccessP) cambiarFotoSuccessP.textContent = '';
                if(btnGuardarNuevaFoto) {
                    btnGuardarNuevaFoto.disabled = true;
                    btnGuardarNuevaFoto.textContent = 'Guardando...';
                }
        
                const formData = new FormData();
                formData.append('action', 'updateFotoPaciente'); // Acci√≥n para tu pacientes.php
                formData.append('pacienteId', pacienteParaActualizarFotoAdmin.id); // Enviar el ID del paciente
                formData.append('archivoFoto', archivoParaSubir); // El archivo en s√≠
        
                try {
                    // apiPacientes debe estar definida en config.js y apuntar a tu pacientes.php
                    const res = await fetch(apiPacientes, { // LLAMADA A TU API PHP
                        method: 'POST', // PHP espera $_POST y $_FILES
                        // NO Content-Type header para FormData, el navegador lo pone
                        body: formData
                    });
        
                    const responseData = await res.json(); // Tu PHP devuelve JSON
        
                    if (res.ok && responseData.success) {
                        if(cambiarFotoSuccessP) cambiarFotoSuccessP.textContent = responseData.message || '¬°Foto actualizada!';
                        
                        // Actualizar la fuente de la imagen de previsualizaci√≥n en el modal (si a√∫n est√° abierto)
                        // y la imagen en la vista del paciente si ese paciente est√° cargado.
                        const nuevaFotoUrlCompleta = responseData.fotoUrl; // PHP devuelve la ruta relativa como 'uploads/fotos_pacientes/...'
        
                        if (fotoPreviewImg) fotoPreviewImg.src = nuevaFotoUrlCompleta;
        
                        // Si el paciente cuya foto se actualiz√≥ es el que est√° cargado en la vistaMedico
                        if (selectedPacienteData && selectedPacienteData.id == pacienteParaActualizarFotoAdmin.id) {
                            if(document.getElementById('pacienteFoto')) document.getElementById('pacienteFoto').src = nuevaFotoUrlCompleta;
                            if (selectedPacienteData.fields) selectedPacienteData.fields.Foto = nuevaFotoUrlCompleta; // Actualizar en el estado global
                        }
        
                        // Refrescar la tabla de admin para que muestre la nueva foto (o actualizar la celda si fuera simple)
                        if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id && adminGestionPacientesContainerDiv.style.display === 'block') {
                            fetchPacientesAdmin(adminCentroMedicoData.id);
                        }
        
                        setTimeout(() => {
                            if(modalCambiarFoto) modalCambiarFoto.style.display = 'none';
                            if(cambiarFotoSuccessP) cambiarFotoSuccessP.textContent = '';
                        }, 2000);
        
                    } else {
                        if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = `Error: ${responseData.error || res.statusText}`;
                        console.error('Error al actualizar foto (API PHP):', responseData.error || res.status);
                    }
                } catch (error) {
                    console.error('Error de red al actualizar foto:', error);
                    if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = 'Error de conexi√≥n o respuesta no JSON.';
                } finally {
                    if(btnGuardarNuevaFoto) {
                        btnGuardarNuevaFoto.disabled = false;
                        btnGuardarNuevaFoto.textContent = 'Guardar Foto';
                    }
                }
            };
        } else { console.error("Elemento formCambiarFoto no encontrado."); }

        // --- Eventos para el Modal de Resultados Lab y Agregar Documento ---
        if (closeModalResultadosLab) {
            // console.log("Asignando onclick a closeModalResultadosLab (X)");
            closeModalResultadosLab.onclick = () => {
                // console.log("Clic en closeModalResultadosLab (X)");
                cerrarYRestaurarBotonesModalResultados();
            };
        } else { console.error("Elemento closeModalResultadosLab no encontrado al asignar evento."); }

        if (btnCerrarModalResultados) {
            // console.log("Asignando onclick a btnCerrarModalResultados (Bot√≥n Cerrar)");
            btnCerrarModalResultados.onclick = () => {
                // console.log("Clic en btnCerrarModalResultados (Bot√≥n Cerrar)");
                cerrarYRestaurarBotonesModalResultados();
            };
        } else { console.error("Elemento btnCerrarModalResultados no encontrado al asignar evento."); }
        
        if (btnAbrirModalAgregarDocumento) {
            btnAbrirModalAgregarDocumento.onclick = () => {
                if(formAgregarDocumento) formAgregarDocumento.reset();
                agregarDocumentoErrorP.textContent = '';
                agregarDocumentoSuccessP.textContent = '';
                modalAgregarDocumento.style.display = 'block';
            };
        } else { console.error("Elemento btnAbrirModalAgregarDocumento no encontrado."); }

        if (closeModalAgregarDocumento) {
            closeModalAgregarDocumento.onclick = () => { modalAgregarDocumento.style.display = 'none'; };
        } else { console.error("Elemento closeModalAgregarDocumento no encontrado."); }
        
        if (btnCancelarAgregarDocumento) {
            btnCancelarAgregarDocumento.onclick = () => { modalAgregarDocumento.style.display = 'none'; };
        } else { console.error("Elemento btnCancelarAgregarDocumento no encontrado."); }

        if (formAgregarDocumento) {
            formAgregarDocumento.onsubmit = async (event) => {
                event.preventDefault();
                if (!currentConsultaIdForDocuments) {
                    agregarDocumentoErrorP.textContent = "Error: No se identific√≥ la consulta.";
                    return;
                }
                
                const titulo = inputDocumentoTitulo.value.trim();
                const archivoInputValue = inputDocumentoArchivo.value.trim();
                
                if (!titulo) {
                    agregarDocumentoErrorP.textContent = "Complete el t√≠tulo.";
                    return;
                }
                // Correcta validaci√≥n para input type="text"
                if (!archivoInputValue) {
                    agregarDocumentoErrorP.textContent = "Ingrese la URL o el nombre del archivo.";
                    return;
                }
                const nombreArchivo = archivoInputValue; // Usar el valor del input
        
                agregarDocumentoErrorP.textContent = '';
                agregarDocumentoSuccessP.textContent = '';
                const btnGuardar = document.getElementById('btnGuardarDocumento');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
        
                const nuevaEntradaResultado = `${titulo} file:${nombreArchivo}`;
                try {
                    // Paso 1: Obtener los resultados actuales usando la funci√≥n ya corregida
                    let resultadosActualesStr = await fetchConsultaResultados(currentConsultaIdForDocuments);
                    if (typeof resultadosActualesStr !== 'string') { // Doble chequeo por si acaso
                        resultadosActualesStr = "";
                    }
        
                    let resultadosActualizadosStr = (resultadosActualesStr.trim() !== "") ?
                                                  `${resultadosActualesStr}\n${nuevaEntradaResultado}` : nuevaEntradaResultado;
        
                    // Paso 2: Actualizar los resultados usando consultas.php
                    const payload = {
                        action: 'updateConsultaResultados', // Acci√≥n en tu consultas.php
                        consultaId: currentConsultaIdForDocuments,
                        fields: { // Tu PHP espera 'fields' y dentro 'Resultados'
                            Resultados: resultadosActualizadosStr
                        }
                    };
        
                    // apiConsultas se toma de config.js
                    const res = await fetch(apiConsultas, {
                        method: 'PATCH', // O 'POST', seg√∫n c√≥mo manejes esto en PHP
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
        
                    // Asumimos que tu API PHP siempre devuelve JSON
                    const responseData = await res.json().catch(() => ({ success: false, error: "Respuesta inv√°lida del servidor al actualizar resultados."}));
        
                    if (!res.ok || !responseData.success) {
                        const errorMsg = responseData.error || `Error ${res.status} al agregar documento.`;
                        console.error('Error al agregar documento (API):', errorMsg);
                        agregarDocumentoErrorP.textContent = errorMsg;
                    } else {
                        agregarDocumentoSuccessP.textContent = responseData.message || '¬°Documento agregado!';
                        formAgregarDocumento.reset();
                        // Actualizar el modal con los nuevos datos
                        const documentos = parseResultadosString(resultadosActualizadosStr);
                        displayResultadosEnModal(documentos);
                        setTimeout(() => {
                            if (modalAgregarDocumento) modalAgregarDocumento.style.display = 'none';
                            agregarDocumentoSuccessP.textContent = '';
                        }, 1500);
                    }
                } catch (error) { // Para errores de red en fetchConsultaResultados o el fetch de actualizaci√≥n
                    console.error('Error de red o procesamiento al agregar documento:', error);
                    agregarDocumentoErrorP.textContent = 'Error de conexi√≥n: ' + error.message;
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar Documento';
                }
            };
        } else { console.error("Elemento formAgregarDocumento no encontrado."); }


        // --- Eventos de Grabaci√≥n Principal ---
        if (startBtn) {
            startBtn.onclick = async () => {
              try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = []; 
                mediaRecorder.ondataavailable = event => { 
                    if (event.data.size > 0) { audioChunks.push(event.data); }
                };
                mediaRecorder.onstop = () => { 
                  currentAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                  const audioUrl = URL.createObjectURL(currentAudioBlob);
                  audioPlayback.src = audioUrl;
                  audioPlayback.style.display = 'block';
                  statusP.textContent = 'Grabaci√≥n finalizada.';
                  statusP.classList.remove('blink-red');
                  uploadRecordingBtn.disabled = false; 
                  cancelRecordingBtn.disabled = false;
                  recordingActionsDiv.style.display = 'inline-block'; 
                  uploadResultP.textContent = '';
                  stream.getTracks().forEach(track => track.stop()); 
                  startBtn.style.display = 'inline-block';
                  startBtn.disabled = false; 
                  startBtn.textContent = 'üé§Ô∏è Comenzar Grabaci√≥n';
                  pauseBtn.style.display = 'none'; pauseBtn.disabled = true;
                  resumeBtn.style.display = 'none'; resumeBtn.disabled = true;
                  finishBtn.style.display = 'none'; finishBtn.disabled = true;
                  isPaused = false;
                };
                mediaRecorder.onpause = () => { statusP.textContent = 'Grabaci√≥n pausada...'; statusP.classList.remove('blink-red'); isPaused = true; };
                mediaRecorder.onresume = () => { statusP.textContent = 'Grabando...'; statusP.classList.add('blink-red'); isPaused = false; };
                mediaRecorder.start(); 
                statusP.textContent = 'Grabando...'; statusP.classList.add('blink-red');
                startBtn.style.display = 'none'; 
                pauseBtn.style.display = 'inline-block'; pauseBtn.disabled = false;
                resumeBtn.style.display = 'none'; resumeBtn.disabled = true;
                finishBtn.style.display = 'inline-block'; finishBtn.disabled = false;
                audioPlayback.style.display = 'none'; audioPlayback.src = '';
                currentAudioBlob = null; recordingActionsDiv.style.display = 'none';
                uploadResultP.textContent = ''; isPaused = false;
              } catch (err) {
                console.error('Error al acceder al micr√≥fono:', err);
                statusP.textContent = 'Error: No se pudo acceder al micr√≥fono.';
                alert('No se pudo acceder al micr√≥fono.');
                resetRecordingState(); 
                startBtn.disabled = !(selectedPacienteData?.fields?.Carnet);
              }
            };
        } else { console.error("Elemento startBtn no encontrado."); }

        if(pauseBtn) pauseBtn.onclick = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block'; resumeBtn.disabled = false;
            }
        }; else { console.error("Elemento pauseBtn no encontrado."); }
        
        if(resumeBtn) resumeBtn.onclick = () => {
            if (mediaRecorder && mediaRecorder.state === 'paused') {
                mediaRecorder.resume();
                resumeBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block'; pauseBtn.disabled = false;
            }
        }; else { console.error("Elemento resumeBtn no encontrado."); }

        if(finishBtn) finishBtn.onclick = () => { 
            if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) {
                mediaRecorder.stop();
            }
        }; else { console.error("Elemento finishBtn no encontrado."); }

        if (uploadRecordingBtn) {
            uploadRecordingBtn.onclick = () => {
                uploadRecordingBtn.disabled = true;
                cancelRecordingBtn.disabled = true;
				// --- NUEVO: Deshabilitar startBtn INMEDIATAMENTE ---
                if (startBtn) {
                    // console.log("Deshabilitando startBtn desde uploadRecordingBtn.onclick");
                    startBtn.disabled = true;
                }
                if (currentAudioBlob) {
                    uploadAudioBlob(currentAudioBlob);
                } else {
                    uploadResultP.textContent = 'No hay grabaci√≥n para subir.';
					// Si no hay blob, los botones de acci√≥n de grabaci√≥n deben reactivarse,
                    // y startBtn tambi√©n (si hab√≠a paciente)
                    uploadRecordingBtn.disabled = false;
                    cancelRecordingBtn.disabled = false;
					if (startBtn && selectedPacienteData?.fields?.Carnet) {
                        // console.log("Re-habilitando startBtn porque no hab√≠a currentAudioBlob");
                        startBtn.disabled = false;
                    }
                }
            };
        } else { console.error("Elemento uploadRecordingBtn no encontrado."); }

        if(cancelRecordingBtn) cancelRecordingBtn.onclick = () => {
            resetRecordingState(); 
            if(startBtn) startBtn.disabled = !(selectedPacienteData?.fields?.Carnet);
        }; else { console.error("Elemento cancelRecordingBtn no encontrado."); }

        if (uploadForm) {
            uploadForm.onsubmit = async (event) => {
              event.preventDefault();
              const submitButton = uploadForm.querySelector('button[type="submit"]');
              if (submitButton) submitButton.disabled = true;
              const file = audioFileInput.files[0];
              if (!file) {
                uploadResultP.textContent = 'Selecciona un archivo de audio.';
                if (submitButton) submitButton.disabled = false;
                return;
              }
              const formData = new FormData();
              formData.set('audioFile', file, file.name);
              if (selectedPacienteData?.id && selectedPacienteData?.fields) {
                  formData.set('pacienteId', selectedPacienteData.id);
                  if (selectedPacienteData.fields.Carnet) { formData.set('pacienteCarnet', selectedPacienteData.fields.Carnet); }
                  if (selectedPacienteData.fields['Nombre Completo']) { formData.set('pacienteNombreCompleto', selectedPacienteData.fields['Nombre Completo']);}
              } else { console.warn("No se seleccion√≥ paciente para asociar archivo."); }
              uploadResultP.textContent = 'Subiendo archivo...';
              try {
                const response = await fetch(n8nWebhookUrlGrabacionPrincipal, { method: 'POST', body: formData });
                if (response.ok) {
                  await response.json();
                  uploadResultP.textContent = 'Archivo subido!';
                  uploadForm.reset();
                } else {
                  uploadResultP.textContent = `Error al subir: ${response.status} ${response.statusText}`;
                  console.error('Error en servidor (archivo):', await response.text());
                }
              } catch (error) {
                console.error('Error en subida (archivo):', error);
                uploadResultP.textContent = 'Error de red al subir.';
              } finally {
                   if (submitButton) submitButton.disabled = false;
              }
            };
        } else { console.error("Elemento uploadForm no encontrado."); }

		// --- Eventos para cerrar el modal de Antecedentes ---
        if (closeModalVerAntecedentes) {
            // console.log("Asignando onclick a closeModalVerAntecedentes (X de Antecedentes)");
            closeModalVerAntecedentes.onclick = () => {
                // console.log("Clic en closeModalVerAntecedentes (X)"); 
                if (modalVerAntecedentes) modalVerAntecedentes.style.display = 'none';
            };
        } else { 
            console.error("Elemento closeModalVerAntecedentes no encontrado al asignar evento."); 
        }

        if (btnCerrarModalAntecedentes) {
            // console.log("Asignando onclick a btnCerrarModalAntecedentes (Bot√≥n Cerrar de Antecedentes)");
            btnCerrarModalAntecedentes.onclick = () => {
                // console.log("Clic en btnCerrarModalAntecedentes (Bot√≥n Cerrar)");
                if (modalVerAntecedentes) modalVerAntecedentes.style.display = 'none';
            };
        } else { 
            console.error("Elemento btnCerrarModalAntecedentes no encontrado al asignar evento."); 
        }

        // Evento general para cerrar modales al hacer clic fuera
        window.addEventListener('click', (event) => {
            if (modalResultadosLab && event.target == modalResultadosLab) {
                // console.log("Clic fuera de modalResultadosLab (window listener)");
                cerrarYRestaurarBotonesModalResultados();
            }
            if (modalAgregarDocumento && event.target == modalAgregarDocumento) {
                modalAgregarDocumento.style.display = 'none';
            }
            if (modalNuevoPaciente && event.target == modalNuevoPaciente) {
                modalNuevoPaciente.style.display = 'none';
            }
            if (modalCambiarFoto && event.target == modalCambiarFoto) {
                modalCambiarFoto.style.display = 'none';
            }
			if (modalVerAntecedentes && event.target == modalVerAntecedentes) {
                // console.log("Clic fuera de modalVerAntecedentes (window listener)");
                modalVerAntecedentes.style.display = 'none';
            }
        });
		
        if (formModificarPaciente) {
            formModificarPaciente.onsubmit = async (event) => {
                event.preventDefault();
                modificarPacienteErrorP.textContent = '';
                modificarPacienteSuccessP.textContent = '';
                const btnGuardarMod = document.getElementById('btnGuardarModificacionesPaciente');
                btnGuardarMod.disabled = true;
                btnGuardarMod.textContent = 'Guardando Cambios...';
        
                const recordID = modificarPacienteRecordIDInput.value; // Este es el Paciente.Id
                if (!recordID) {
                    modificarPacienteErrorP.textContent = "Error: No se pudo identificar el registro del paciente.";
                    btnGuardarMod.disabled = false;
                    btnGuardarMod.textContent = 'Guardar Cambios';
                    return;
                }
        
                const formData = new FormData(formModificarPaciente);
                const pacienteFieldsToUpdate = {};
        
                // Recolectar datos del formulario de modificaci√≥n
                // (Aseg√∫rate que los names de los inputs coincidan con las claves que espera tu backend
                // o que mapees las claves aqu√≠ si son diferentes)
                pacienteFieldsToUpdate.Nombres = formData.get('Nombres');
                pacienteFieldsToUpdate.Apellidos = formData.get('Apellidos');
                pacienteFieldsToUpdate.Carnet = formData.get('Carnet');
                pacienteFieldsToUpdate.Fecha_Nacimiento = formData.get('Fecha Nacimiento'); // Nombre de columna MySQL
                pacienteFieldsToUpdate.Genero = formData.get('Genero');
                pacienteFieldsToUpdate.Telefono = String(formData.get('Tel√©fono')); // Nombre de columna MySQL (o Tel√©fono si as√≠ es)
                pacienteFieldsToUpdate.Tipo_Sangre = formData.get('Tipo Sangre'); // Nombre de columna MySQL
                pacienteFieldsToUpdate.Estado_Civil = formData.get('Estado Civil'); // Nombre de columna MySQL
                pacienteFieldsToUpdate.Direccion = formData.get('Direccion');
                pacienteFieldsToUpdate.Ocupacion = formData.get('Ocupacion');
                
                const seguroId = formData.get('Seguro');
                if (seguroId && seguroId !== "") { // Solo si se seleccion√≥ un seguro v√°lido
                    pacienteFieldsToUpdate.SeguroID = parseInt(seguroId, 10); // Enviar como INT
                } else {
                    pacienteFieldsToUpdate.SeguroID = null; // Permitir desasignar
                }
                
                const carnetModificar = pacienteFieldsToUpdate.Carnet;
                if (!/^\d{1,12}$/.test(carnetModificar)) {
                    modificarPacienteErrorP.textContent = 'El Documento Id. debe contener solo n√∫meros (hasta 12 d√≠gitos).';
                    btnGuardarMod.disabled = false;
                    btnGuardarMod.textContent = 'Guardar Cambios';
                    return;
                }

                try {
                    // CONSTRUIR EL PAYLOAD PARA TU API PHP
                    const payloadParaBackend = {
                        action: 'updatePaciente',
                        recordID: recordID, // El ID del paciente a actualizar
                        fields: pacienteFieldsToUpdate // El objeto con los campos y sus nuevos valores
                    };
        
                    // apiPacientes debe estar definido en config.js
                    // const apiPacientes = 'https://productsonpoint.com/hce/api/pacientes.php';
                    const res = await fetch(apiPacientes, {
                        method: 'PATCH', // O 'POST' si tu backend espera POST para actualizaciones
                        headers: {
                            'Content-Type': 'application/json'
                            // No necesitas Authorization aqu√≠ a menos que tu API PHP lo requiera
                        },
                        body: JSON.stringify(payloadParaBackend)
                    });
        
                    if (!res.ok) {
                        let errorMsg = `Error ${res.status} al modificar paciente.`;
                        try {
                            const errorData = await res.json();
                            if (errorData && errorData.error) {
                                errorMsg = errorData.error;
                            }
                        } catch (e) { /* La respuesta no fue JSON */ }
                        modificarPacienteErrorP.textContent = errorMsg;
                        console.error('Error al modificar paciente (API PHP):', res.status, errorMsg);
                        throw new Error('Error al guardar cambios.');
                    }
        
                    const responseData = await res.json();
                    if (responseData.success) {
                        modificarPacienteSuccessP.textContent = responseData.message || '¬°Datos del paciente actualizados con √©xito!';
                        
                        if (adminCentroMedicoData && adminCentroMedicoData.id) {
                            // Solo refrescar si la vista de gesti√≥n de pacientes del admin est√° activa
                            // y si el paciente pertenece al centro que el admin est√° viendo (esto es m√°s complejo de determinar aqu√≠ sin otra llamada)
                            // Por ahora, refrescamos si la vista est√° activa.
                            if (adminGestionPacientesContainerDiv && adminGestionPacientesContainerDiv.style.display === 'block') {
                               fetchPacientesAdmin(adminCentroMedicoData.id);
                            }
                        }
                        
                        setTimeout(() => {
                            if(modalModificarPaciente) modalModificarPaciente.style.display = 'none';
                            modificarPacienteSuccessP.textContent = '';
                        }, 2000);
                    } else {
                        modificarPacienteErrorP.textContent = responseData.error || 'No se pudo guardar el cambio (respuesta del servidor).';
                    }
        
                } catch (error) {
                    console.error("Error en submit modificar paciente (catch JS):", error);
                    if(!modificarPacienteErrorP.textContent) modificarPacienteErrorP.textContent = error.message || "Error al procesar la modificaci√≥n.";
                } finally {
                    btnGuardarMod.disabled = false;
                    btnGuardarMod.textContent = 'Guardar Cambios';
                }
            };
        }
			
		if (closeModalModificarPaciente) {
			closeModalModificarPaciente.onclick = () => { if(modalModificarPaciente) modalModificarPaciente.style.display = 'none'; };
		}
		if (btnCancelarModificarPaciente) {
			btnCancelarModificarPaciente.onclick = () => { if(modalModificarPaciente) modalModificarPaciente.style.display = 'none'; };
		}
		
        if (closeModalGenerarCodigo) {
            closeModalGenerarCodigo.onclick = () => { if(modalGenerarCodigo) modalGenerarCodigo.style.display = 'none'; };
        }
        if (btnCerrarModalGenerarCodigo) {
            btnCerrarModalGenerarCodigo.onclick = () => { if(modalGenerarCodigo) modalGenerarCodigo.style.display = 'none'; };
        }

        window.addEventListener('click', (event) => {
            // ...
            if (modalGenerarCodigo && event.target == modalGenerarCodigo) {
                modalGenerarCodigo.style.display = 'none';
            }
			if (modalModificarPaciente && event.target == modalModificarPaciente) {
				modalModificarPaciente.style.display = 'none';
			}
			if (modalVerDetallesConsulta && event.target == modalVerDetallesConsulta) {
                modalVerDetallesConsulta.style.display = 'none';
			}    
        });		

        // --- BOTONES DEL SIDEBAR DEL ADMINISTRADOR ---
        if (btnGenerarCodigoPacienteAdmin) {
            btnGenerarCodigoPacienteAdmin.onclick = async () => {
                if (loggedInUserType === 'Administrador') {
                    if (!adminCentroMedicoData || !adminCentroMedicoData.id || !adminCentroMedicoData.nombre) {
                        alert("Error: No se ha identificado el centro m√©dico del administrador."); return;
                    }
                    const mensajeModalCodigoP = document.getElementById("mensajeInstruccionCodigo");
                    if (mensajeModalCodigoP) {
                        mensajeModalCodigoP.innerHTML = `El siguiente c√≥digo debe ser proporcionado al m√©dico para registrar un nuevo paciente en el <strong>${adminCentroMedicoData.nombre}</strong>:`;
                    }

                    if(codigoGeneradoDisplayDiv) codigoGeneradoDisplayDiv.textContent = "Generando...";
                    if(modalGenerarCodigo) modalGenerarCodigo.style.display = 'block';

                    try {
                        // LLAMADA A TU API PHP
                        const params = new FormData();
                        params.append('action', 'generarCodigoPaciente');
                        params.append('adminCentroMedicoId', adminCentroMedicoData.id); // Enviar el ID del centro del admin
        
                        // apiCodigos debe estar definido en config.js
                        // const apiCodigos = 'https://productsonpoint.com/hce/api/codigos.php';
                        const resCodigo = await fetch(apiCodigos, {
                            method: 'POST',
                            body: params 
                            // No Content-Type para FormData, el navegador lo pone
                        });
                        
                        if (!resCodigo.ok) {
                            const errorData = await resCodigo.json().catch(() => ({error: "Error del servidor al generar c√≥digo."}));
                            console.error("Error al generar/guardar c√≥digo (API PHP):", resCodigo.status, errorData);
                            throw new Error(errorData.error || "No se pudo generar el c√≥digo. Intente de nuevo.");
                        }
        
                        const responseData = await resCodigo.json();
                        if (responseData.success && responseData.codigoGenerado) {
                            if(codigoGeneradoDisplayDiv) codigoGeneradoDisplayDiv.textContent = responseData.codigoGenerado;
                        } else {
                            throw new Error(responseData.error || "Respuesta inesperada del servidor al generar c√≥digo.");
                        }
        
                    } catch (error) {
                        console.error("Error en generaci√≥n/guardado de c√≥digo (catch JS):", error);
                        if(codigoGeneradoDisplayDiv) codigoGeneradoDisplayDiv.textContent = "Error";
                        // alert(error.message || "Ocurri√≥ un error inesperado al generar c√≥digo."); // El error ya se muestra en el modal o consola
                        if (document.getElementById('mensajeInstruccionCodigo')) {
                             document.getElementById('mensajeInstruccionCodigo').innerHTML += `<br><strong style='color:red;'>Error: ${error.message}</strong>`;
                        }
                    }
                }
            };
        } else { console.warn("Bot√≥n btnGenerarCodigoPacienteAdmin no encontrado"); }

        if (btnGestionPacientesAdmin) {
            btnGestionPacientesAdmin.onclick = () => {
                if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
                    //if(adminVistaTituloH1) adminVistaTituloH1.textContent = "Gesti√≥n de Pacientes";
                    if(adminGestionMedicosContainerDiv) adminGestionMedicosContainerDiv.style.display = 'none';
                    if(adminGestionPacientesContainerDiv) adminGestionPacientesContainerDiv.style.display = 'block';
                    fetchPacientesAdmin(adminCentroMedicoData.id);
                } else if (loggedInUserType !== 'Administrador') {
                    // No deber√≠a llegar aqu√≠ si el bot√≥n solo es visible para admin
                } else {
                    alert("Error: No se ha identificado el centro m√©dico del administrador.");
                }
            };
        }  else { console.warn("Bot√≥n btnGestionPacientesAdmin no encontrado"); }

        if (btnGestionMedicosAdmin) {
            btnGestionMedicosAdmin.onclick = () => {
                 if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
                    //if(adminVistaTituloH1) adminVistaTituloH1.textContent = "Gesti√≥n de RRHH";
                    if(adminGestionPacientesContainerDiv) adminGestionPacientesContainerDiv.style.display = 'none';
                    if(adminGestionMedicosContainerDiv) adminGestionMedicosContainerDiv.style.display = 'block';
					// console.log("btnGestionMedicosAdmin.onclick - Llamando a fetchMedicosAdmin con centroId:", adminCentroMedicoData.id);
                    fetchMedicosAdmin(adminCentroMedicoData.id);
                } else if (loggedInUserType !== 'Administrador') {
                    // No deber√≠a llegar aqu√≠
					console.error("Error: btnGestionMedicosAdmin clickeado por un no-administrador.");
                } else {
                    alert("Error: No se ha identificado el centro m√©dico del administrador.");
					console.error("Error: adminCentroMedicoData o adminCentroMedicoData.id no est√° definido al intentar gestionar m√©dicos.");
                }
            };
        } else { console.warn("Bot√≥n btnGestionMedicosAdmin no encontrado"); }
		
        if (btnNuevoMedicoAdmin) {
            btnNuevoMedicoAdmin.onclick = () => {
                if (loggedInUserType === 'Administrador') {
                    abrirModalGestionMedico(null); 
                }
            };
        } else { console.warn("Bot√≥n btnNuevoMedicoAdmin no encontrado"); }

		if (btnNuevoPacienteAdmin) {
			btnNuevoPacienteAdmin.onclick = () => {
				// Solo el admin puede usar esto y debe estar logueado y con un centro asociado
				if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
					if (formNuevoPaciente) formNuevoPaciente.reset();
					if (nuevoPacienteErrorP) nuevoPacienteErrorP.textContent = '';
					if (nuevoPacienteSuccessP) nuevoPacienteSuccessP.textContent = '';
					
					// El admin siempre crea pacientes para SU centro m√©dico.
					// El c√≥digo de activaci√≥n ya est√° ligado a un centro por el admin que lo genera.
					// No necesitamos pasar el centro aqu√≠, el modal de nuevo paciente
					// usa el c√≥digo de activaci√≥n que ya tiene el ID del centro.
					
					fetchSeguros('pacienteSeguro', null); // Cargar seguros en el select del modal
					
					if (pacienteCodigoActivacionInput) {
						pacienteCodigoActivacionInput.value = ''; // Limpiar el campo de c√≥digo por si acaso
					}

					if (modalNuevoPaciente) modalNuevoPaciente.style.display = 'block';
				} else {
					alert("Acci√≥n no permitida o no se ha identificado el centro m√©dico del administrador.");
				}
			};
		} else {
			console.warn("Bot√≥n btnNuevoPacienteAdmin no encontrado.");
		}		
	
         // --- EVENTOS PARA MODAL GESTION MEDICO ---
        if (closeModalGestionMedico) {
            closeModalGestionMedico.onclick = () => { if(modalGestionMedico) modalGestionMedico.style.display = 'none'; };
        }
        if (btnCancelarGestionMedico) {
            btnCancelarGestionMedico.onclick = () => { if(modalGestionMedico) modalGestionMedico.style.display = 'none'; };
        }

        if (formGestionMedico) {
            formGestionMedico.onsubmit = async (event) => {
                event.preventDefault();
                const btnGuardar = document.getElementById('btnGuardarGestionMedico');
                gestionMedicoErrorP.textContent = '';
                gestionMedicoSuccessP.textContent = '';
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
        
                const recordID = gestionMedicoRecordIDInput.value; // Si hay recordID, es edici√≥n. Si no, es creaci√≥n.
                const formData = new FormData(formGestionMedico);
                const medicoFields = {}; // Objeto para los campos que se enviar√°n al backend
        
                for (let [key, value] of formData.entries()) {
                    // Aseg√∫rate que las claves aqu√≠ coincidan con lo que tu backend PHP espera
                    medicoFields[key] = value;
                }
        
                // Validaciones b√°sicas del frontend (puedes expandirlas)
                let errorMsg = "";
                if (!medicoFields.Apellidos || !medicoFields.Nombres || !medicoFields.login) {
                    errorMsg = "Campos obligatorios: Apellidos, Nombres, Login.";
                } else if (medicoFields.Apellidos.trim().length < 3 || medicoFields.Nombres.trim().length < 3) {
                    errorMsg = "Apellidos y Nombres deben tener al menos 3 caracteres.";
                } else if (!medicoFields['EMail'] || !/^\S+@\S+\.\S+$/.test(medicoFields['EMail'])) {
                    errorMsg = "E-Mail es obligatorio y debe tener un formato v√°lido.";
                } else if (medicoFields.Carnet && !/^\d{1,12}$/.test(medicoFields.Carnet)) { 
                    errorMsg = "El Carnet debe contener solo n√∫meros (hasta 12 d√≠gitos).";
                }
                // A√±ade m√°s validaciones seg√∫n necesites (ej. para Abreviatura, Especialidad, Carnet)
        
                if (errorMsg) {
                    gestionMedicoErrorP.textContent = errorMsg;
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = recordID ? "Guardar Cambios" : "Guardar RR.HH.";
                    return;
                }
        
                let url = apiMedicos; // Tu constante de config.js: 'https://productsonpoint.com/hce/api/medicos.php'
                let method;
                let payloadParaBackend;
        
                if (recordID) { // MODO EDICI√ìN (UPDATE)
                    method = 'PATCH'; // O 'POST' si tu backend maneja updates con POST y una acci√≥n
                    payloadParaBackend = {
                        action: 'updateMedico', // Acci√≥n para tu script PHP
                        recordID: recordID,
                        fields: medicoFields // Los campos a actualizar
                    };
                } else { // MODO CREACI√ìN
                    method = 'POST';
                    payloadParaBackend = {
                            action: 'createMedico',
                            fields: medicoFields, // Contiene los datos del formulario del m√©dico
                            adminCentroId: adminCentroMedicoData?.id,      // <--- ASEG√öRATE DE ENVIAR ESTO
                            adminCentroNombre: adminCentroMedicoData?.nombre // Para el email de bienvenida
                    };
                }
        
                try {
                    // --- INICIO: Validaci√≥n de Login Duplicado (SOLO PARA NUEVOS M√âDICOS Y SI NO ES EL MISMO M√âDICO) ---
                    // Esta validaci√≥n ya la tienes en el backend (handleCreateMedico y handleUpdateMedico si el login cambia)
                    // Podr√≠as mantener una validaci√≥n del lado del cliente aqu√≠ tambi√©n si lo deseas para mejorar UX,
                    // pero la del backend es la crucial. Por ahora, nos fiaremos de la del backend.
        
                    // --- LLAMADA A TU API PHP ---
                    btnGuardar.textContent = recordID ? 'Actualizando...' : 'Creando...';
                    
                    const res = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                            // No Authorization header a menos que tu API PHP lo requiera
                        },
                        body: JSON.stringify(payloadParaBackend)
                    });
        
                    if (!res.ok) {
                        let serverErrorMsg = `Error ${res.status}.`;
                        try {
                            const errorData = await res.json();
                            serverErrorMsg = errorData.error || serverErrorMsg;
                        } catch (e) { 
                            serverErrorMsg += " " + await res.text(); // Si la respuesta no es JSON
                        }
                        gestionMedicoErrorP.textContent = serverErrorMsg;
                        console.error("Error guardando m√©dico (API PHP):", res.status, serverErrorMsg);
                        throw new Error(serverErrorMsg);
                    }
        
                    const responseData = await res.json();
        
                    if (responseData.success) {
                        gestionMedicoSuccessP.textContent = responseData.message || `¬°M√©dico ${recordID ? 'actualizado' : 'registrado'} con √©xito!`;
                        if (!recordID && responseData.generatedPassword) { // Si es nuevo y se devolvi√≥ la contrase√±a generada
                            gestionMedicoSuccessP.textContent += ` Su contrase√±a inicial es: ${responseData.generatedPassword}`;
                        }
                        formGestionMedico.reset();
                        if (adminCentroMedicoData?.id) {
                            fetchMedicosAdmin(adminCentroMedicoData.id); // Refrescar la lista
                        }
                        setTimeout(() => {
                            if (modalGestionMedico) modalGestionMedico.style.display = 'none';
                            gestionMedicoSuccessP.textContent = '';
                        }, (!recordID && responseData.generatedPassword) ? 6000 : 2500);
                    } else {
                        gestionMedicoErrorP.textContent = responseData.error || 'No se pudo completar la operaci√≥n.';
                    }
        
                } catch (error) {
                    console.error(`Error en submit ${recordID ? 'modificar' : 'crear'} m√©dico (catch JS):`, error);
                    if (!gestionMedicoErrorP.textContent) {
                        gestionMedicoErrorP.textContent = error.message || "Error desconocido al guardar.";
                    }
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = recordID ? "Guardar Cambios" : "Guardar RR.HH.";
                }
            };
        }
        // --- FIN EVENTOS MODAL GESTION MEDICO ---

        if (selectCentroMedicoDropdown) {
            selectCentroMedicoDropdown.onchange = (event) => {
                selectedCentroMedicoId = event.target.value;
                // --- INICIO: LIMPIAR DATOS DEL PACIENTE Y CONSULTAS ---
                selectedPacienteData = null; // Importante resetear el paciente seleccionado globalmente
                limpiarVistaPacienteYConsultas(); // Llama a una nueva funci√≥n de limpieza
                
                // --- FIN: LIMPIAR DATOS DEL PACIENTE Y CONSULTAS ---
                if (loggedInUserType === 'Medico' && sidebarMedicoContentDiv) {
                    sidebarMedicoContentDiv.style.display = 'block';
                }
                if (inputBuscarPacienteEl) inputBuscarPacienteEl.value = '';
    
                if (selectedCentroMedicoId) { 
                    const selectedOption = event.target.options[event.target.selectedIndex];
                    const logoFileNameConEspacios = selectedOption.dataset.logo; // Puede ser "centro medico.jpg"
                    let finalLogoUrl;
    
                    if (logoFileNameConEspacios && logoFileNameConEspacios.trim() !== '') {
                        finalLogoUrl = `images/${logoFileNameConEspacios}`; 
                    } else {
                        finalLogoUrl = 'images/logo_circular.png'; 
                    }
                    
                    //console.log("[Dropdown Centro] Intentando cargar logo:", finalLogoUrl);
                    if(sidebarCentroMedicoLogoImg) {
                        sidebarCentroMedicoLogoImg.src = finalLogoUrl;
                        sidebarCentroMedicoLogoImg.onerror = function() {
                            // Fallback si la imagen espec√≠fica del centro no se carga
                            console.warn("Error cargando logo espec√≠fico:", finalLogoUrl, ". Usando logo por defecto.");
                            this.src = 'images/logo_circular.png';
                            this.onerror = null; // Evitar bucle infinito si el placeholder tambi√©n falla
                        };
                    }
                    // Limpiar la lista de pacientes antes de cargar los nuevos
                    if(pacientesList) pacientesList.innerHTML = '<li>Cargando pacientes...</li>';                    
                    fetchPacientes(selectedCentroMedicoId, ''); // Cargar todos los pacientes del nuevo centro
                    actualizarEstadoControlesBusquedaPaciente(true); 
                } else { 
                    if(sidebarCentroMedicoLogoImg) {
                        sidebarCentroMedicoLogoImg.src = 'images/logo_circular.png';
                        sidebarCentroMedicoLogoImg.onerror = null; // Limpiar manejador de error anterior
                    }
                    if(pacientesList) pacientesList.innerHTML = '<li>Seleccione un Centro M√©dico para ver pacientes.</li>';
                    actualizarEstadoControlesBusquedaPaciente(false); // DESHABILITAR/OCULTAR controles de b√∫squeda
                 }
            };
		}
		
	    function limpiarVistaPacienteYConsultas() {
            // Limpiar informaci√≥n del paciente en la vista principal
            const camposInfoIds = [
                'infoNombreCompleto', 'infoFechaNacimiento', 'infoCarnet', 'infoEdad', 
                'infoTipoSangre', 'infoTelefono', 'infoGenero', 'infoEstadoCivil', 
                'infoDireccion', 'infoSeguro', 'infoOcupacion'
            ];
            camposInfoIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = ''; 
            });
    
            const pacienteFotoImg = document.getElementById('pacienteFoto');
            if (pacienteFotoImg) pacienteFotoImg.src = 'images/placeholder-paciente.png';
    
            // Limpiar Vacunas, Alergias, Antecedentes
            // Asumiendo que infoVacunas, infoAlergias, infoAntecedentesDivLocal son variables globales
            // o puedes obtenerlos con getElementById aqu√≠.
            [
                document.getElementById('infoVacunas'), 
                document.getElementById('infoAlergias'), 
                document.getElementById('infoAntecedentes') // Usa infoAntecedentesDivLocal si esa es tu variable global
            ].forEach(div => {
                if (div) {
                    div.innerHTML = ''; // O un placeholder como 'N/A'
                    div.classList.remove('expanded');
                    div.style.maxHeight = 'none';
                    div.style.overflowY = 'hidden';
                    div.style.cursor = 'default';
                    delete div.dataset.fullContentHtml;
                    delete div.dataset.initialMaxHeight;
                    delete div.dataset.fullHeight;
                }
            });
    
            // Limpiar tabla de consultas
            if (consultasBody) {
                consultasBody.innerHTML = '<tr><td colspan="6">Seleccione un paciente para ver sus consultas.</td></tr>';
            }
    
            // Resetear estado de grabaci√≥n y deshabilitar botones relacionados
            resetRecordingState(); // Ya tienes esta funci√≥n, que deber√≠a deshabilitar startBtn etc.
            if (startBtn) startBtn.disabled = true; // Asegurar que est√© deshabilitado
    
            // Si el bot√≥n de la c√°mara para la foto del paciente es espec√≠fico de la vista del paciente (ahora no lo es)
            // const btnAbrirModalFotoVistaMedico = document.getElementById('btnAbrirModalFoto'); // Si existiera a√∫n con este ID
            // if (btnAbrirModalFotoVistaMedico) btnAbrirModalFotoVistaMedico.style.display = 'none';
        }
        
        // Vacunas
        if (btnGestionarVacunasPaciente) {
            btnGestionarVacunasPaciente.onclick = () => {
                if (!selectedPacienteData) {
                    alert("Seleccione un paciente primero.");
                    return;
                }
                abrirModalGestionVacunas(selectedPacienteData);
            };
        }
        
        if (closeModalGestionVacunas) {
            closeModalGestionVacunas.onclick = () => modalGestionVacunas.style.display = 'none';
        }
        if (btnCerrarModalGestionVacunas) {
            btnCerrarModalGestionVacunas.onclick = () => modalGestionVacunas.style.display = 'none';
        }
        // Tambi√©n a√±adir al window.onclick para cerrar si se hace clic fuera
        
        if (btnEditarAntecedentesPaciente) { // Esta variable se inicializ√≥ arriba
            btnEditarAntecedentesPaciente.onclick = () => {
                if (!selectedPacienteData) {
                    alert("Seleccione un paciente primero.");
                    return;
                }
                configurarModalAntecedentes(selectedPacienteData, true); // Abrir en modo edici√≥n
            };
        }
        
        async function abrirModalGestionVacunas(pacienteData) {
            if (!pacienteData || !pacienteData.fields || !pacienteData.id) {
                console.error("Datos de paciente inv√°lidos para gestionar vacunas.");
                return;
            }
            if (tituloModalGestionVacunasSpan) tituloModalGestionVacunasSpan.textContent = pacienteData.fields['Nombre Completo'] || 'Paciente';
            if (formAnadirVacunaPaciente) formAnadirVacunaPaciente.reset();
            if (anadirVacunaErrorP) anadirVacunaErrorP.textContent = '';
            if (inputFechaAplicacionVacuna) inputFechaAplicacionVacuna.value = new Date().toISOString().split('T')[0]; // Fecha de hoy por defecto
        
            // Cargar lista de vacunas disponibles para el dropdown
            await poblarSelectVacunasDisponibles();
            // Cargar y mostrar vacunas ya aplicadas al paciente en la tabla del modal
            await cargarVacunasAplicadasEnModal(pacienteData.id);
        
            if (modalGestionVacunas) modalGestionVacunas.style.display = 'block';
        }
        
        async function poblarSelectVacunasDisponibles() {
            if (!selectVacunaDisponible) {
                console.error("poblarSelectVacunasDisponibles: selectVacunaDisponible no encontrado.");
                return;
            }
            selectVacunaDisponible.innerHTML = '<option value="">Cargando...</option>';
            selectVacunaDisponible.disabled = true; // Deshabilitar mientras carga
        
            try {
                // Definir params para esta llamada espec√≠fica
                const params = new URLSearchParams({
                    action: 'getAllVacunas'
                });
        
                // apiVacunas debe estar definida en config.js
                const res = await fetch(`${apiVacunas}?${params.toString()}`);
                
                if (!res.ok) { // Chequear res.ok primero
                    // Intentar obtener un mensaje de error del cuerpo si es posible
                    let errorMsg = `Error ${res.status} cargando lista de vacunas.`;
                    try {
                        const errorData = await res.json();
                        if (errorData && errorData.error) {
                            errorMsg = errorData.error;
                        }
                    } catch (e) { /* No era JSON o hubo otro error */ }
                    throw new Error(errorMsg);
                }
                
                const data = await res.json(); // Ahora parsear JSON
        
                // Si la respuesta fue ok, pero el payload de la API indica un error (algunas APIs lo hacen)
                if (data.error) { 
                    throw new Error(data.error);
                }
        
                selectVacunaDisponible.innerHTML = '<option value="">-- Seleccione una vacuna --</option>';
                if (data.records && data.records.length > 0) {
                    data.records.forEach(vac => { // vac es {Id: ..., NombreVacuna: ...}
                        const option = document.createElement('option');
                        option.value = vac.Id; 
                        option.textContent = vac.NombreVacuna; // Aseg√∫rate que PHP devuelva esta clave
                        selectVacunaDisponible.appendChild(option);
                    });
                } else {
                    selectVacunaDisponible.innerHTML = '<option value="">No hay vacunas disponibles</option>';
                }
            } catch (error) {
                console.error("Error poblando select de vacunas:", error);
                selectVacunaDisponible.innerHTML = `<option value="">Error: ${error.message}</option>`;
            } finally {
                selectVacunaDisponible.disabled = false; // Rehabilitar el select
            }
        }
        
        async function cargarVacunasAplicadasEnModal(pacienteId) {
            if (!tbodyVacunasDelPaciente) return;
            tbodyVacunasDelPaciente.innerHTML = '<tr><td colspan="3" style="text-align:center;">Cargando...</td></tr>';
            try {
                const params = new URLSearchParams({ action: 'getVacunasDelPaciente', paciente_id: pacienteId });
                const res = await fetch(`${apiPacientes}?${params.toString()}`);
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || "Error cargando vacunas aplicadas");
        
                tbodyVacunasDelPaciente.innerHTML = '';
                if (data.records && data.records.length > 0) {
                    // Array para los nombres abreviados de los meses en espa√±ol
                    const mesesAbreviados = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
        
                    data.records.forEach(vac => {
                        const tr = tbodyVacunasDelPaciente.insertRow();
                        tr.insertCell().textContent = vac.NombreVacuna;
        
                        let fechaFmtModal = 'N/A';
                        if (vac.FechaAplicacion) { // FechaAplicacion viene como 'YYYY-MM-DD' desde PHP
                            try {
                                const parts = vac.FechaAplicacion.split('-'); // [YYYY, MM, DD]
                                const year = parseInt(parts[0], 10);
                                const monthIndex = parseInt(parts[1], 10) - 1; // Meses en JS son 0-indexados (0 para enero)
                                const day = parseInt(parts[2], 10);

                                // Alternativa m√°s directa usando los parts parseados:
                                const diaFmt = day.toString().padStart(2, '0');
                                const mesAbrev = mesesAbreviados[monthIndex]; // Usar el √≠ndice del mes
                                const anioFmt = year;
        
                                fechaFmtModal = `${diaFmt}-${mesAbrev}-${anioFmt}`;
        
                            } catch (e) {
                                console.error("Error formateando fecha de vacuna en modal:", vac.FechaAplicacion, e);
                                fechaFmtModal = vac.FechaAplicacion; // Fallback a la fecha original si hay error
                            }
                        }
                        tr.insertCell().textContent = fechaFmtModal;
                        
                        const tdAccion = tr.insertCell();
                        tdAccion.style.textAlign = "center";
                        const btnEliminar = document.createElement('button');
                        btnEliminar.innerHTML = 'üóëÔ∏è';
                        btnEliminar.title = "Eliminar esta aplicaci√≥n de vacuna";
                        btnEliminar.classList.add('btn-accion-icono');
                        btnEliminar.dataset.pacienteId = vac.PacienteID;
                        btnEliminar.dataset.vacunaId = vac.VacunaID;
                        btnEliminar.dataset.fechaAplicacion = vac.FechaAplicacion; // Fecha original YYYY-MM-DD
        
                        btnEliminar.onclick = async () => {
                            if (confirm(`¬øEst√° seguro de eliminar la vacuna "${vac.NombreVacuna}" aplicada el ${fechaFmtModal}?`)) {
                                await eliminarAplicacionVacuna(
                                    vac.PacienteID,
                                    vac.VacunaID,
                                    vac.FechaAplicacion
                                );
                            }
                        };
                        tdAccion.appendChild(btnEliminar);
                    });
                } else {
                    tbodyVacunasDelPaciente.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay vacunas registradas para este paciente.</td></tr>';
                }
            } catch (error) {
                console.error("Error cargando vacunas en modal:", error);
                tbodyVacunasDelPaciente.innerHTML = '<tr><td colspan="3" style="color:red; text-align:center;">Error al cargar vacunas.</td></tr>';
            }
        }
        
        if (formAnadirVacunaPaciente) {
            formAnadirVacunaPaciente.onsubmit = async (event) => {
                event.preventDefault();
                if (!selectedPacienteData || !selectedPacienteData.id) {
                    if(anadirVacunaErrorP) anadirVacunaErrorP.textContent = "No hay paciente seleccionado.";
                    return;
                }
                const vacunaId = selectVacunaDisponible.value;
                const fechaAplicacion = inputFechaAplicacionVacuna.value;
        
                if (!vacunaId) { if(anadirVacunaErrorP) anadirVacunaErrorP.textContent = "Seleccione una vacuna."; return; }
                if (!fechaAplicacion) { if(anadirVacunaErrorP) anadirVacunaErrorP.textContent = "Seleccione una fecha."; return; }
        
                const btnSubmit = document.getElementById('btnSubmitAnadirVacuna');
                if(btnSubmit) btnSubmit.disabled = true;
                if(anadirVacunaErrorP) anadirVacunaErrorP.textContent = '';
        
                try {
                    const payload = {
                        action: 'registrarVacunaPaciente',
                        pacienteId: selectedPacienteData.id,
                        vacunaId: vacunaId,
                        fechaAplicacion: fechaAplicacion
                    };
                    const res = await fetch(apiPacientes, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
        
                    if (!res.ok || !data.success) {
                        throw new Error(data.error || "Error al registrar vacuna.");
                    }
                    // √âxito
                    formAnadirVacunaPaciente.reset(); // Limpiar formulario de a√±adir
                    if (inputFechaAplicacionVacuna) inputFechaAplicacionVacuna.value = new Date().toISOString().split('T')[0]; // Resetear fecha a hoy
                    await cargarVacunasAplicadasEnModal(selectedPacienteData.id); // Refrescar tabla en modal
                    // Refrescar tambi√©n la vista principal del paciente
                    const listaVacunasDivPrincipal = document.getElementById('listaVacunasAplicadas');
                    if (listaVacunasDivPrincipal) await cargarYMostrarVacunasDelPaciente(selectedPacienteData.id, listaVacunasDivPrincipal);
        
                } catch (error) {
                    console.error("Error a√±adiendo vacuna:", error);
                    if(anadirVacunaErrorP) anadirVacunaErrorP.textContent = error.message;
                } finally {
                    if(btnSubmit) btnSubmit.disabled = false;
                }
            };
        }
        
        async function eliminarAplicacionVacuna(pacienteIdRecibido, vacunaIdRecibida, fechaAplicacionRecibida) {
            // pacienteIdRecibido ES el ID del paciente para refrescar Y para la clave de eliminaci√≥n.
            try {
                //console.log("Eliminando vacuna para PacienteID:", pacienteIdRecibido, "VacunaID:", vacunaIdRecibida, "Fecha:", fechaAplicacionRecibida); // Log de depuraci√≥n
        
                const payload = {
                    action: 'eliminarVacunaPaciente',
                    pacienteId: pacienteIdRecibido,         // Usar el par√°metro recibido
                    vacunaId: vacunaIdRecibida,           // Usar el par√°metro recibido
                    fechaAplicacion: fechaAplicacionRecibida // Usar el par√°metro recibido (debe ser YYYY-MM-DD)
                };
        
                const res = await fetch(apiPacientes, { // apiPacientes de config.js
                    method: 'POST', // O 'DELETE' si tu PHP lo maneja as√≠
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
        
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || "Error al eliminar vacuna.");
                }
        
                // √âxito
                //console.log("Vacuna eliminada con √©xito, refrescando vistas...");
                // Refrescar usando el pacienteIdRecibido
                await cargarVacunasAplicadasEnModal(pacienteIdRecibido); 
                const listaVacunasDivPrincipal = document.getElementById('listaVacunasAplicadas');
                if (listaVacunasDivPrincipal) {
                    await cargarYMostrarVacunasDelPaciente(pacienteIdRecibido, listaVacunasDivPrincipal);
                }
        
            } catch (error) {
                console.error("Error eliminando vacuna:", error);
                alert("Error al eliminar el registro de vacuna: " + error.message);
            }
        }
        
        // Evento para el bot√≥n l√°piz de Alergias
        if (btnEditarAlergiasPaciente) {
            btnEditarAlergiasPaciente.onclick = () => {
                if (!selectedPacienteData || !selectedPacienteData.fields) {
                    alert("Seleccione un paciente primero.");
                    return;
                }
                if (tituloModalEditarAlergiasSpan) tituloModalEditarAlergiasSpan.textContent = selectedPacienteData.fields['Nombre Completo'] || 'Paciente';
                if (textareaAlergias) {
                    // Obtener el contenido completo, no el truncado del div.
                    // Asumimos que selectedPacienteData.fields.Alergias tiene el texto completo.
                    textareaAlergias.value = selectedPacienteData.fields.Alergias || '';
                }
                if (document.getElementById('editarAlergiasPacienteId')) { // Si tienes un input hidden para el ID
                     document.getElementById('editarAlergiasPacienteId').value = selectedPacienteData.id;
                }
                if (editarAlergiasErrorP) editarAlergiasErrorP.textContent = '';
                if (modalEditarAlergias) modalEditarAlergias.style.display = 'block';
                if (textareaAlergias) textareaAlergias.focus();
            };
        }
        
        if (closeModalEditarAlergias) {
            closeModalEditarAlergias.onclick = () => { if(modalEditarAlergias) modalEditarAlergias.style.display = 'none'; };
        }
        if (btnCancelarEditarAlergias) {
            btnCancelarEditarAlergias.onclick = () => { if(modalEditarAlergias) modalEditarAlergias.style.display = 'none'; };
        }
        // Tambi√©n a√±adir al window.onclick para cerrar si se hace clic fuera
        
        if (formEditarAlergias) {
            formEditarAlergias.onsubmit = async (event) => {
                event.preventDefault();
                if (!selectedPacienteData || !selectedPacienteData.id) {
                    if(editarAlergiasErrorP) editarAlergiasErrorP.textContent = "Error: Paciente no identificado.";
                    return;
                }
        
                const nuevasAlergias = textareaAlergias.value; // No es necesario trim() aqu√≠, puede que el usuario quiera espacios al final de una l√≠nea. El backend puede trimmear si es necesario.
                const btnGuardar = document.getElementById('btnGuardarAlergias');
        
                if(btnGuardar) {
                    btnGuardar.disabled = true;
                    btnGuardar.textContent = 'Guardando...';
                }
                if(editarAlergiasErrorP) editarAlergiasErrorP.textContent = '';
        
                try {
                    const payload = {
                        action: 'updatePaciente', // Reutilizamos la acci√≥n general
                        recordID: selectedPacienteData.id,
                        fields: {
                            Alergias: nuevasAlergias // Solo enviamos el campo Alergias
                        }
                    };
        
                    const res = await fetch(apiPacientes, {
                        method: 'PATCH', // O POST, seg√∫n tu API
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
        
                    const data = await res.json();
        
                    if (!res.ok || !data.success) {
                        throw new Error(data.error || "Error al guardar alergias.");
                    }
        
                    // √âxito
                    if(selectedPacienteData.fields) selectedPacienteData.fields.Alergias = nuevasAlergias; 
                    
                    const infoAlergiasDiv = document.getElementById('infoAlergias');
                    if (infoAlergiasDiv) {
                        if (nuevasAlergias.trim() === '') {
                            infoAlergiasDiv.innerHTML = '<small>No hay alergias registradas.</small>';
                        } else {
                            infoAlergiasDiv.innerHTML = nuevasAlergias.replace(/\n/g, '<br>');
                        }
                    }
        
                    if(modalEditarAlergias) modalEditarAlergias.style.display = 'none';
                    // Opcional: mostrar un mensaje de √©xito temporal
                    // alert("Alergias actualizadas con √©xito.");
        
        
                } catch (error) {
                    console.error("Error guardando alergias:", error);
                    if(editarAlergiasErrorP) editarAlergiasErrorP.textContent = error.message;
                } finally {
                    if(btnGuardar) {
                        btnGuardar.disabled = false;
                        btnGuardar.textContent = 'Guardar Alergias';
                    }
                }
            };
        }        
        
        // --- L√≥gica para ANTECEDENTES ---
        let modoEdicionAntecedentes = false; // Variable para rastrear el modo del modal
        
        function configurarModalAntecedentes(pacienteData, paraEdicion = false) {
            if (!pacienteData || !pacienteData.fields) {
                console.warn("configurarModalAntecedentes: pacienteData inv√°lido.");
                return;
            }
        
            if (!modalVerAntecedentes || !tituloModalVerAntecedentes ||
                !modalAntecedentesContenidoDisplay || !formEditarAntecedentes || 
                !textareaAntecedentesEditar || !btnGuardarAntecedentes || !editarAntecedentesErrorP) {
                console.error("configurarModalAntecedentes: Uno o m√°s elementos del modal no est√°n inicializados.");
                return;
            }
            
            const nombrePaciente = pacienteData.fields['Nombre Completo'] || 'Paciente';
            
            if (paraEdicion) {
                // Construir el t√≠tulo completo para edici√≥n
                tituloModalVerAntecedentes.textContent = `Editar Antecedentes de ${nombrePaciente}`;
                if (modalAntecedentesNombrePaciente) modalAntecedentesNombrePaciente.style.display = 'none'; // Opcional: ocultarlo en modo edici√≥n
            } else { // Modo Visualizaci√≥n
                tituloModalVerAntecedentes.textContent = `Antecedentes del Paciente ${nombrePaciente}`;
            }
            
            const contenidoActual = pacienteData.fields.Antecedentes || '';
        
            if (paraEdicion) {
                modoEdicionAntecedentes = true;
                modalAntecedentesContenidoDisplay.style.display = 'none';
                formEditarAntecedentes.style.display = 'block';
                textareaAntecedentesEditar.value = contenidoActual;
                btnGuardarAntecedentes.style.display = 'inline-block';
                editarAntecedentesErrorP.textContent = '';
                textareaAntecedentesEditar.focus();
            } else { // Modo Visualizaci√≥n
                modoEdicionAntecedentes = false;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contenidoActual.replace(/\n/g, '<br>');
                tempDiv.querySelectorAll('.see-more-link, .see-less-link, .see-more-overlay').forEach(el => el.remove());
                
                modalAntecedentesContenidoDisplay.innerHTML = tempDiv.innerHTML;
                modalAntecedentesContenidoDisplay.style.display = 'block';
                
                formEditarAntecedentes.style.display = 'none';
                btnGuardarAntecedentes.style.display = 'none';
            }
            modalVerAntecedentes.style.display = 'block';
        }

        // Cerrar el modal de Antecedentes
        if (closeModalVerAntecedentes) {
            closeModalVerAntecedentes.onclick = () => { if(modalVerAntecedentes) modalVerAntecedentes.style.display = 'none'; };
        }
        if (btnCerrarModalAntecedentes) { // USA LA VARIABLE CORRECTA: btnCerrarModalAntecedentes
            btnCerrarModalAntecedentes.onclick = () => {
                if (modalVerAntecedentes) modalVerAntecedentes.style.display = 'none';
            };
        }
        
        // Guardar cambios de Antecedentes
        if (formEditarAntecedentes) {
            formEditarAntecedentes.onsubmit = async (event) => {
                event.preventDefault();
                if (!selectedPacienteData || !selectedPacienteData.id || !modoEdicionAntecedentes) {
                    if(editarAntecedentesErrorP) editarAntecedentesErrorP.textContent = "Error: Paciente no identificado o no en modo edici√≥n.";
                    return;
                }
        
                const nuevosAntecedentes = textareaAntecedentesEditar.value;
                
                if(btnGuardarAntecedentes) {
                    btnGuardarAntecedentes.disabled = true;
                    btnGuardarAntecedentes.textContent = 'Guardando...';
                }
                if(editarAntecedentesErrorP) editarAntecedentesErrorP.textContent = '';
        
                try {
                    const payload = {
                        action: 'updatePaciente',
                        recordID: selectedPacienteData.id,
                        fields: {
                            Antecedentes: nuevosAntecedentes
                        }
                    };
                    const res = await fetch(apiPacientes, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
        
                    if (!res.ok || !data.success) {
                        throw new Error(data.error || "Error al guardar antecedentes.");
                    }
        
                    // √âxito
                    if(selectedPacienteData.fields) selectedPacienteData.fields.Antecedentes = nuevosAntecedentes;
                    
                    // Volver a renderizar la secci√≥n de antecedentes en la vista principal
                    const infoAntecedentesDiv = document.getElementById('infoAntecedentes');
                    if (infoAntecedentesDiv) {
                        const antecedentesTexto = fields.Antecedentes || ''; // Usar string vac√≠o si es null/undefined
                        const placeholder = 'No hay antecedentes registrados';
            
                        if (!antecedentesTexto.trim() || antecedentesTexto.toLowerCase() === placeholder.toLowerCase()) {
                            infoAntecedentesDiv.innerHTML = `<small>${placeholder}</small>`;
                        } else {
                            // Reemplazar saltos de l√≠nea \n con <br> para asegurar la visualizaci√≥n correcta
                            // Aunque white-space: pre-line; tambi√©n lo hace, ser expl√≠cito con <br> es m√°s robusto
                            // para el c√°lculo de scrollHeight en algunos navegadores.
                            //infoAntecedentesDiv.innerHTML = antecedentesTexto.replace(/\n/g, '<br>');
                            infoAntecedentesDiv.innerHTML = antecedentesTexto.replace(/\n/g, '<br>');
                        }
            
                        // Limpiar cualquier estilo residual de l√≥gicas anteriores si es necesario
                        infoAntecedentesDiv.style.maxHeight = ''; 
                        infoAntecedentesDiv.style.cursor = 'default'; 
                        infoAntecedentesDiv.classList.remove('expanded');
                        
                        const seeMoreLink = infoAntecedentesDiv.querySelector('.see-more-link, .see-more-overlay');
                        if (seeMoreLink) {
                            seeMoreLink.remove();
                        }
                    }
        
                    // Volver al modo visualizaci√≥n o cerrar
                    // configurarModalAntecedentes(selectedPacienteData, false); // Opci√≥n 1: Volver a modo visualizaci√≥n
                    if(modalVerAntecedentes) modalVerAntecedentes.style.display = 'none'; // Opci√≥n 2: Simplemente cerrar
        
        
                } catch (error) {
                    console.error("Error guardando antecedentes:", error);
                    if(editarAntecedentesErrorP) editarAntecedentesErrorP.textContent = error.message;
                } finally {
                    if(btnGuardarAntecedentes) {
                        btnGuardarAntecedentes.disabled = false;
                        btnGuardarAntecedentes.textContent = 'Guardar Cambios';
                    }
                }
            };
        }
        
        const btnEditarDetallesModal = document.getElementById('btnEditarDetallesConsultaModal');
        if (btnEditarDetallesModal) {
            btnEditarDetallesModal.onclick = habilitarEdicionDetallesConsulta;
        }

        const btnGuardarDetallesModal = document.getElementById('btnGuardarCambiosDetallesConsulta');
        if (btnGuardarDetallesModal) {
            btnGuardarDetallesModal.onclick = guardarCambiosDetallesConsulta;
        }
    
        const btnCancelarEdicionDetallesModal = document.getElementById('btnCancelarEdicionDetallesConsulta');
        if (btnCancelarEdicionDetallesModal) {
            btnCancelarEdicionDetallesModal.onclick = cancelarEdicionDetallesConsulta;
        }
        
        const pacienteSearchContainerEl = document.getElementById('pacienteSearchContainer');
        const inputBuscarPacienteEl = document.getElementById('inputBuscarPaciente');
        const btnBuscarPacienteGoEl = document.getElementById('btnBuscarPacienteGo');
        const btnVerTodosPacientesEl = document.getElementById('btnVerTodosPacientes');
        
        function actualizarEstadoControlesBusquedaPaciente(habilitar) {
            if (pacienteSearchContainerEl) {
                pacienteSearchContainerEl.style.display = habilitar ? 'block' : 'none';
            }
            // Si prefieres deshabilitar en lugar de ocultar el contenedor:
            /*
            if (inputBuscarPacienteEl) inputBuscarPacienteEl.disabled = !habilitar;
            if (btnBuscarPacienteGoEl) btnBuscarPacienteGoEl.disabled = !habilitar;
            if (btnVerTodosPacientesEl) btnVerTodosPacientesEl.disabled = !habilitar;
            */
        }
    
        // Funci√≥n para realizar la b√∫squeda
        const realizarBusquedaPacientes = () => {
            if (selectedCentroMedicoId) { // Solo buscar si hay un centro seleccionado
                const termino = inputBuscarPacienteEl.value;
                fetchPacientes(selectedCentroMedicoId, termino);
            } else if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
                 // Para admin, la b√∫squeda es en su tabla, no en esta lista del sidebar
                 // Esta lista del sidebar es para m√©dicos.
            } else {
                // alert("Por favor, seleccione un centro m√©dico primero.");
                if (pacientesList) pacientesList.innerHTML = '<li>Seleccione un Centro M√©dico para buscar pacientes.</li>';
            }
        };
    
        if (btnBuscarPacienteGoEl) {
            btnBuscarPacienteGoEl.onclick = realizarBusquedaPacientes;
        }
    
        if (inputBuscarPacienteEl) {
            // B√∫squeda al presionar Enter en el input
            inputBuscarPacienteEl.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Evitar submit de formulario si estuviera dentro de uno
                    realizarBusquedaPacientes();
                }
            });
            // Opcional: B√∫squeda en tiempo real (descomentar si se desea)
            /*
            inputBuscarPacienteEl.addEventListener('input', () => {
                // A√±adir un debounce aqu√≠ ser√≠a ideal para no hacer llamadas a la API en cada tecla
                realizarBusquedaPacientes(); 
            });
            */
        }
    
        if (btnVerTodosPacientesEl) {
            btnVerTodosPacientesEl.onclick = () => {
                if (inputBuscarPacienteEl) inputBuscarPacienteEl.value = ''; // Limpiar input
                if (selectedCentroMedicoId) { // Solo si hay un centro seleccionado
                    fetchPacientes(selectedCentroMedicoId, ''); // "" para obtener todos
                } else if (loggedInUserType === 'Administrador' && adminCentroMedicoData?.id) {
                    // No aplica a la lista del sidebar del m√©dico
                } else {
                    if (pacientesList) pacientesList.innerHTML = '<li>Seleccione un Centro M√©dico.</li>';
                }
            };
        }
    
        // Modificar el onchange del selector de centro m√©dico para que tambi√©n use fetchPacientes
        if (selectCentroMedicoDropdown) {
            selectCentroMedicoDropdown.onchange = (event) => {
                selectedCentroMedicoId = event.target.value;
                selectedPacienteData = null;
                limpiarVistaPacienteYConsultas(); // Ya tienes esta funci√≥n
    
                if (loggedInUserType === 'Medico' && sidebarMedicoContentDiv) {
                    sidebarMedicoContentDiv.style.display = 'block';
                }
                if (inputBuscarPacienteEl) inputBuscarPacienteEl.value = ''; // Limpiar b√∫squeda al cambiar de centro
    
                if (selectedCentroMedicoId) {
                    // ... (c√≥digo existente para cambiar el logo) ...
                    const selectedOption = event.target.options[event.target.selectedIndex];
                    const logoFileNameConEspacios = selectedOption.dataset.logo;
                    let finalLogoUrl = (logoFileNameConEspacios && logoFileNameConEspacios.trim() !== '') ? `images/${logoFileNameConEspacios}` : 'images/logo_circular.png';
                    if(sidebarCentroMedicoLogoImg) { /* ... tu l√≥gica de logo ... */ }
                    
                    fetchPacientes(selectedCentroMedicoId, ''); // Cargar todos los pacientes del nuevo centro
                } else {
                    // ... (c√≥digo existente para cuando no hay centro seleccionado) ...
                    if(sidebarCentroMedicoLogoImg) { /* ... */ }
                    if(pacientesList) pacientesList.innerHTML = '<li>Seleccione un Centro M√©dico.</li>';
                }
            };
        }
            
        window.addEventListener('click', (event) => {
            // ... (tus otros if para modales) ...
            if (modalGenerarCodigo && event.target == modalGenerarCodigo) { modalGenerarCodigo.style.display = 'none'; }
            if (modalGestionMedico && event.target == modalGestionMedico) { modalGestionMedico.style.display = 'none'; }
            if (modalBuscarCarnetRrhh && event.target == modalBuscarCarnetRrhh) { modalBuscarCarnetRrhh.style.display = 'none';  }
        });	
		
        // Inicializaci√≥n de la aplicaci√≥n
        checkLoginStatus();

    });
    // --- FIN DEL BLOQUE DOMContentLoaded ---

    async function fetchPacientesAdmin(centroId) {
        if (!tablaPacientesAdminBody) {
            console.error("fetchPacientesAdmin: tablaPacientesAdminBody no encontrado.");
            return;
        }
        tablaPacientesAdminBody.innerHTML = '<tr><td colspan="13">Cargando pacientes del centro...</td></tr>';
    
        if (!centroId) {
            console.error("fetchPacientesAdmin: centroId no proporcionado.");
            tablaPacientesAdminBody.innerHTML = '<tr><td colspan="13">Error: ID de centro no especificado.</td></tr>';
            return;
        }
    
        try {
            const params = new URLSearchParams({
                action: 'getPacientesPorCentro', // Usa la misma acci√≥n que fetchPacientes si la l√≥gica es igual
                                                 // o crea una 'getPacientesAdminPorCentro' si hay diferencias.
                centro_id: centroId,
                sort_field: 'Apellidos', // O el campo por el que quieras ordenar por defecto
                sort_direction: 'ASC'
            });
    
            // apiPacientes debe estar definida en config.js y apuntar a tu pacientes.php
            // const apiPacientes = 'https://productsonpoint.com/hce/api/pacientes.php';
            const res = await fetch(`${apiPacientes}?${params.toString()}`);
    
            if (!res.ok) {
                let errorMsg = `Error ${res.status} al cargar pacientes.`;
                try {
                    const errorData = await res.json();
                    if (errorData && errorData.error) {
                        errorMsg = errorData.error;
                    }
                } catch (e) { /* Mantener errorMsg original si la respuesta no es JSON */ }
                console.error("fetchPacientesAdmin - Error de API:", res.status, errorMsg);
                tablaPacientesAdminBody.innerHTML = `<tr><td colspan="13">${errorMsg}</td></tr>`;
                return;
            }
    
            const data = await res.json(); // Espera { records: [ {id: ..., fields: {...} }, ... ] }
            // console.log(`[fetchPacientesAdmin] Datos recibidos para centro ${centroId}:`, data);
    
            tablaPacientesAdminBody.innerHTML = '';
            if (data.records && data.records.length > 0) {
                data.records.forEach(pacienteRecord => { // 'pacienteRecord' es {id: ..., fields: {...}}
                    const fields = pacienteRecord.fields; // 'fields' contiene los datos del paciente
                    const tr = tablaPacientesAdminBody.insertRow();
                    
                    tr.insertCell().textContent = fields.Id || fields.ID || 'N/A'; // El ID del paciente (viene de CodigosActivacion.Codigo)
                    tr.insertCell().textContent = fields.Apellidos || '';
                    tr.insertCell().textContent = fields.Nombres || '';
                    tr.insertCell().textContent = fields.Telefono || fields.Tel√©fono || ''; // Considerar ambos nombres
                    tr.insertCell().textContent = fields.Carnet || '';
                    tr.insertCell().textContent = fields.Genero || '';
                    
                    let fechaNacFormateada = 'N/A';
                    if (fields.Fecha_Nacimiento) { // Nombre de columna MySQL
                        try {
                            const parts = fields.Fecha_Nacimiento.split('-');
                            const fechaObj = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); // Mes es 0-indexado
    
                            if (!isNaN(fechaObj.getTime())) {
                                const dia = fechaObj.getUTCDate(); // Usar getUTCDate()
                                const mesIndice = fechaObj.getUTCMonth(); // Mes 0-11
                                const anio = fechaObj.getUTCFullYear();
    
                                const mesesAbrev = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
                                const nombreMes = mesesAbrev[mesIndice];
    
                                fechaNacFormateadaParaTabla = `${dia}/${nombreMes}/${anio}`;
                            } else {
                                fechaNacFormateadaParaTabla = 'Inv√°lida';
                            }
                        } catch(e) {
                            console.error("Error formateando fecha en JS:", fields.Fecha_Nacimiento, e);
                            fechaNacFormateadaParaTabla = 'Error';
                        }
                    }
                    tr.insertCell().textContent = fechaNacFormateadaParaTabla;
                    
                    tr.insertCell().textContent = fields.Direccion || '';
                    tr.insertCell().textContent = fields.Tipo_Sangre || '';
                    tr.insertCell().textContent = fields.Estado_Civil || '';
                    tr.insertCell().textContent = fields['Razon Social (de Seguros)'] || 'N/A'; // Este alias viene del JOIN en PHP
                    tr.insertCell().textContent = fields.Ocupacion || '';
                    
                    const tdAccionesAdmin = tr.insertCell();
                    tdAccionesAdmin.style.textAlign = 'center';
                    const btnEditarPaciente = document.createElement('button');
                    btnEditarPaciente.innerHTML = '‚úèÔ∏è'; 
                    btnEditarPaciente.title = "Modificar Datos del Paciente";
                    btnEditarPaciente.classList.add('btn-accion-icono'); 
                    // Para abrirModalModificarPaciente, pasar el objeto 'fields' y el 'id'
                    const pacienteParaModal = { id: pacienteRecord.id, fields: fields };
                    btnEditarPaciente.onclick = () => abrirModalModificarPaciente(pacienteParaModal);
                    tdAccionesAdmin.appendChild(btnEditarPaciente);
                    
                    // NUEVO: Bot√≥n Cambiar Foto Paciente
                    const btnCambiarFotoAdmin = document.createElement('button');
                    btnCambiarFotoAdmin.innerHTML = 'üì∑';
                    btnCambiarFotoAdmin.title = "Cambiar Foto del Paciente";
                    btnCambiarFotoAdmin.classList.add('btn-accion-icono');
                    btnCambiarFotoAdmin.style.marginLeft = '5px'; // Espacio entre botones
                    // Guardamos los datos del paciente en el bot√≥n para usarlos al abrir el modal
                    btnCambiarFotoAdmin.dataset.pacienteId = pacienteRecord.id;
                    // Necesitamos el objeto completo para simular 'selectedPacienteData'
                    // y para la previsualizaci√≥n inicial de la foto.
                    // Convertir el objeto fields a string para guardarlo y parsearlo luego.
                    btnCambiarFotoAdmin.dataset.pacienteFieldsString = JSON.stringify(fields);
        
                    btnCambiarFotoAdmin.onclick = () => {
                        const pacienteIdParaFoto = btnCambiarFotoAdmin.dataset.pacienteId;
                        const pacienteFieldsParaFoto = JSON.parse(btnCambiarFotoAdmin.dataset.pacienteFieldsString);
                        
                        // Simular el objeto que espera la l√≥gica de cambio de foto
                        const pacienteDataParaModalFoto = {
                            id: pacienteIdParaFoto,
                            fields: pacienteFieldsParaFoto
                        };
                        abrirModalCambiarFotoParaAdmin(pacienteDataParaModalFoto);
                    };
                    tdAccionesAdmin.appendChild(btnCambiarFotoAdmin);
                });
            } else {
                tablaPacientesAdminBody.innerHTML = '<tr><td colspan="13">No hay pacientes registrados en este centro.</td></tr>';
            }
        } catch (error) {
            console.error("Error en fetchPacientesAdmin (catch JS):", error); // Aqu√≠ deber√≠a mostrarse tu "baseId is not defined"
            tablaPacientesAdminBody.innerHTML = `<tr><td colspan="13">Error al cargar pacientes: ${error.message}</td></tr>`;
        }
    }

   function abrirModalCambiarFotoParaAdmin(pacienteData) {
        pacienteParaActualizarFotoAdmin = pacienteData; // Guardar el paciente actual
    
        if (!pacienteParaActualizarFotoAdmin) {
            alert("Error: No se pudo identificar al paciente para cambiar la foto.");
            return;
        }
    
        if (formCambiarFoto) formCambiarFoto.reset();
        
        // Previsualizar la foto actual del paciente
        let fotoActualSrc = 'images/placeholder-paciente.png';
        if (pacienteParaActualizarFotoAdmin.fields && pacienteParaActualizarFotoAdmin.fields.Foto) {
            // Asumimos que Foto es solo el nombre del archivo, ej: "nombre.jpg"
            // y la ruta completa se construye como "images/fotos_pacientes/nombre.jpg"
            // O si ya viene con la ruta, usarla directamente.
            // La l√≥gica en tu `cargarPaciente` es: `uploads/fotos_pacientes/${fields.Foto}`
            // Deber√≠amos usar la misma l√≥gica aqu√≠.
            // Si fields.Foto ya es la ruta relativa correcta desde la ra√≠z de 'hce/' (ej. "uploads/...")
            // no necesitas anteponer nada.
            // Si fields.Foto es SOLO el nombre del archivo, y las im√°genes se sirven desde "images/fotos_pacientes/"
            // entonces ser√≠a: `images/fotos_pacientes/${pacienteParaActualizarFotoAdmin.fields.Foto}`
    
            // Ajusta esto seg√∫n c√≥mo se guarde y sirva `fields.Foto`
            let rutaFotoExistente = pacienteParaActualizarFotoAdmin.fields.Foto;
            if (rutaFotoExistente && !rutaFotoExistente.startsWith('uploads/fotos_pacientes/') && !rutaFotoExistente.startsWith('images/')) {
                // Si es solo el nombre del archivo, construimos la ruta como en cargarPaciente
                rutaFotoExistente = `uploads/fotos_pacientes/${rutaFotoExistente}`;
            } else if (!rutaFotoExistente) {
                 rutaFotoExistente = 'images/placeholder-paciente.png';
            }
            fotoActualSrc = rutaFotoExistente;
        }
    
        if(fotoPreviewImg) {
            fotoPreviewImg.src = fotoActualSrc;
            fotoPreviewImg.onerror = () => { fotoPreviewImg.src = 'images/placeholder-paciente.png'; fotoPreviewImg.onerror = null; };
        }
    
        if(cambiarFotoErrorP) cambiarFotoErrorP.textContent = '';
        if(cambiarFotoSuccessP) cambiarFotoSuccessP.textContent = '';
        archivoFotoSeleccionado = null; // Esta variable global se sigue usando
        if (pacienteArchivoFotoInput) pacienteArchivoFotoInput.value = null; // Resetear el input file
        if (modalCambiarFoto) modalCambiarFoto.style.display = 'block';
    }

    // --- L√≥gica de Subida de Audio (Definici√≥n) ---
    async function uploadAudioBlob(blob) {
        if (!blob) {
            uploadResultP.textContent = 'No hay audio grabado para subir.';
            // No necesitamos tocar startBtn aqu√≠ si no hay blob, ya se manej√≥ en el .onclick
            if(uploadRecordingBtn) uploadRecordingBtn.disabled = false; 
            if(cancelRecordingBtn) cancelRecordingBtn.disabled = false;  
            return;
        }
        uploadResultP.textContent = 'Subiendo audio...';
        const formData = new FormData();
        formData.set('audioFile', blob, 'consulta_grabada.wav');
        if (selectedPacienteData?.id && selectedPacienteData?.fields) {
            formData.set('pacienteId', selectedPacienteData.id);
            if (selectedPacienteData.fields.Carnet) { formData.set('pacienteCarnet', selectedPacienteData.fields.Carnet); }
            if (selectedPacienteData.fields['Nombre Completo']) { formData.set('pacienteNombreCompleto', selectedPacienteData.fields['Nombre Completo']); }
			if (loggedInMedicoId) { formData.set('medicoCreadorId', loggedInMedicoId); }
        } else { console.warn("No se seleccion√≥ paciente para asociar grabaci√≥n."); }
        
        // uploadRecordingBtn y cancelRecordingBtn ya est√°n deshabilitados desde el .onclick
        // startBtn tambi√©n ya est√° deshabilitado desde el .onclick

        try {
            const response = await fetch(n8nWebhookUrlGrabacionPrincipal, { method: 'POST', body: formData });
            if (response.ok) {
                // Intenta leer la respuesta de n8n (del nodo Respond to Webhook)
                let n8nResponseData;
                try {
                    n8nResponseData = await response.json();
                    // console.log("Respuesta de n8n (Respond to Webhook):", n8nResponseData);
                    // Aqu√≠ podr√≠as verificar n8nResponseData por un campo espec√≠fico de √©xito si lo configuras en n8n
                } catch (e) {
                    console.warn("No se pudo parsear la respuesta JSON de n8n, o no fue JSON.", await response.text());
                    n8nResponseData = { success: true, message: "Proceso iniciado en n8n."}; // Asumir √©xito si la llamada a n8n fue ok
                }

                if (uploadResultP) uploadResultP.textContent = '¬°Consulta creada y registrada!'; // Mensaje de √©xito
                currentAudioBlob = null;
                if (audioPlayback) {
                    audioPlayback.src = '';
                    audioPlayback.style.display = 'none';
                }
                if (recordingActionsDiv) recordingActionsDiv.style.display = 'none';
                if (statusP) statusP.textContent = 'Estado: esperando grabaci√≥n...';

                // --- REFRESCAR LA VISTA DEL PACIENTE ---
                if (selectedPacienteData) {
                    // console.log("uploadAudioBlob: Llamando a cargarPaciente para refrescar la historia cl√≠nica.");
                    await cargarPaciente(selectedPacienteData); // Usar await si cargarPaciente es async (lo es)
                }
                // ---------------------------------------

            } else {
                const errorText = await response.text();
                if(uploadResultP) uploadResultP.textContent = `Error al procesar consulta (n8n): ${response.status} ${response.statusText}`;
                console.error('Error en respuesta de n8n (webhook principal):', response.status, errorText);
            }
        } catch (error) {
            console.error('Error en subida:', error);
            if(uploadResultP) uploadResultP.textContent = 'Error de red o al procesar la consulta.';
            // Si hay error, los botones upload/cancel se reactivan en el finally si es necesario
        } finally {
            // --- NUEVO: Re-habilitar startBtn SIEMPRE al finalizar (√©xito o error) ---
            // Solo si hay un paciente v√°lido seleccionado.
            if (startBtn && selectedPacienteData?.fields?.Carnet) {
                // console.log("Re-habilitando startBtn en el finally de uploadAudioBlob");
                startBtn.disabled = false;
            } else if (startBtn) {
                // Si no hay paciente con carnet, se asegura que quede deshabilitado
                // console.log("Asegurando que startBtn quede deshabilitado (sin paciente v√°lido) en el finally de uploadAudioBlob");
                startBtn.disabled = true;
            }

            // Reactivar botones de acci√≥n de la grabaci√≥n si no fue exitosa o si ya no hay blob
            // (currentAudioBlob ser√° null si la subida fue exitosa)
            if (currentAudioBlob && uploadRecordingBtn) uploadRecordingBtn.disabled = false;
            if (currentAudioBlob && cancelRecordingBtn) cancelRecordingBtn.disabled = false;
        }
    }
	
	async function iniciarGrabacionActualizacion(buttonElement) {
		if (mediaRecorder && mediaRecorder.state !== 'inactive') {
			 alert('Ya hay grabaci√≥n en curso.');
			 return;
		 }
		 
		 // Deshabilitar bot√≥n de grabaci√≥n principal ---
		if (startBtn) {
			// console.log("Deshabilitando startBtn principal desde iniciarGrabacionActualizacion");
			startBtn.disabled = true;
		}
		// --- FIN ---
	
		 const todosLosControlesAccion = consultasBody.querySelectorAll('.grabacion-inline-controls');
		 todosLosControlesAccion.forEach(controls => {
			 const mic = controls.querySelector('.btn-record-update');
			 const docs = controls.querySelector('.btn-view-results');
			 if (mic && mic !== buttonElement) mic.disabled = true;
			 if (docs) docs.disabled = true; 
		 });
		currentRecordingConsultaId = buttonElement.dataset.consultaId;
        const filaDeBotones = buttonElement.closest('.grabacion-inline-controls'); // Esto deber√≠a ser divFilaDeBotones
        if (!filaDeBotones) {
            console.error("iniciarGrabacionActualizacion: No se encontr√≥ el contenedor de la fila de botones (clase 'grabacion-inline-controls').");
            // Rehabilitar botones globales si es necesario
            return;
        }
    
        // El contenedor padre de la fila de botones Y del span de estado
        const contenedorAccionesCompleto = filaDeBotones.parentElement; 
        if (!contenedorAccionesCompleto) {
            console.error("iniciarGrabacionActualizacion: No se encontr√≥ el contenedor principal de acciones.");
            return;
        }
    
        const statusEl = contenedorAccionesCompleto.querySelector('.status-grabacion-inline');
        const btnGrabar = filaDeBotones.querySelector('.btn-record-update');     // El propio micr√≥fono
        const btnDetener = filaDeBotones.querySelector('.btn-stop-update');
        const btnCancelar = filaDeBotones.querySelector('.btn-cancel-update');
    
        if (!statusEl || !btnGrabar || !btnDetener || !btnCancelar) {
            console.error("Error: Faltan elementos de UI para la grabaci√≥n en l√≠nea (status, grabar, detener o cancelar).");
            // resetearControlesGrabacionInline(filaDeBotones, contenedorAccionesCompleto); // Necesitar√≠amos pasar ambos
            return;
        }

		 try {
			 const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
			 mediaRecorder = new MediaRecorder(stream); 
			 audioChunks = []; 
			 mediaRecorder.ondataavailable = event => { if(event.data.size > 0) audioChunks.push(event.data); };
			 mediaRecorder.onstop = async () => { 
                if (statusEl) statusEl.textContent = 'Procesando...';
                if (btnDetener) btnDetener.disabled = true;
                if (btnCancelar) btnCancelar.disabled = true;
				 const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
				 const formData = new FormData(); // Necesitas construir este formData
                 formData.set('audioFile', audioBlob, `actualizacion_consulta_${currentRecordingConsultaId}.wav`);
                 formData.set('consultaId', currentRecordingConsultaId);
                 if (selectedPacienteData?.fields?.Carnet) { formData.set('pacienteCarnet', selectedPacienteData.fields.Carnet); }
				 if (loggedInMedicoId) { formData.set('medicoQueActualizaId', loggedInMedicoId); }
				 try {
					 const response = await fetch(n8nWebhookUrlActualizacionConsulta, { method: 'POST', body: formData });
					 if (response.ok) {
						 statusEl.textContent = 'Actualizaci√≥n enviada.';
					 } else { 
                        statusEl.textContent = `Error env√≠o: ${response.status}`; 
                        console.error("Error al enviar actualizaci√≥n:", await response.text());
                     }
				 } catch (error) { 
                    statusEl.textContent = 'Error red env√≠o.'; 
                    console.error("Error de red al enviar actualizaci√≥n:", error);
                 } 
				 finally {
					stream.getTracks().forEach(track => track.stop());
					currentRecordingConsultaId = null;
					mediaRecorder = null; // Limpiar mediaRecorder para permitir nueva grabaci√≥n principal

					// --- Rehabilitar bot√≥n de grabaci√≥n principal ---
					if (startBtn && selectedPacienteData?.fields?.Carnet) {
						// console.log("Rehabilitando startBtn principal despu√©s de onstop de actualizaci√≥n");
						startBtn.disabled = false;
					} else if (startBtn) {
						 startBtn.disabled = true; // Si no hay paciente, mantenerlo deshabilitado
					}

					 if (selectedPacienteData) {
						 setTimeout(() => cargarPaciente(selectedPacienteData), 1000); 
					 } else {
						  resetearControlesGrabacionInline(currentRecordingRowElement); 
					 }
				 }
			 };
            mediaRecorder.start();
            if (statusEl) statusEl.textContent = 'Grabando actualiz...';
            if (btnGrabar) btnGrabar.style.display = 'none';
            if (btnDetener) { btnDetener.style.display = 'inline-block'; btnDetener.disabled = false; }
            if (btnCancelar) { btnCancelar.style.display = 'inline-block'; btnCancelar.disabled = false; }
		 } catch (err) {
			 console.error('Error al iniciar grabaci√≥n de actualizaci√≥n:', err);
			 if (statusEl) statusEl.textContent = 'Error mic.';
			 resetearControlesGrabacionInline(currentRecordingRowElement); 
			 
			// --- Rehabilitar bot√≥n de grabaci√≥n principal en caso de error al iniciar ---
			if (startBtn && selectedPacienteData?.fields?.Carnet) {
				// console.log("Rehabilitando startBtn principal despu√©s de error al iniciar actualizaci√≥n");
				startBtn.disabled = false;
			} else if (startBtn) {
				startBtn.disabled = true;
			}
			// --- FIN  ---
			
			 if (selectedPacienteData) {
				 cargarPaciente(selectedPacienteData);
			 } else { 
				 const todosLosControlesAccionFallback = consultasBody.querySelectorAll('.grabacion-inline-controls');
				 todosLosControlesAccionFallback.forEach(controls => {
					 const mic = controls.querySelector('.btn-record-update');
					 const docs = controls.querySelector('.btn-view-results');
					 if (mic) mic.disabled = false;
					 if (docs) docs.disabled = false;
				 });
			 }
		 }
	 }

    function detenerGrabacionActualizacion(buttonElement) {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    }
	
	function abrirModalModificarPaciente(pacienteData) {
		if (!formModificarPaciente || !modalModificarPaciente) {
			console.error("El formulario o modal de modificaci√≥n no est√°n definidos.");
			return;
		}
		formModificarPaciente.reset(); 
		if(modificarPacienteErrorP) modificarPacienteErrorP.textContent = '';
		if(modificarPacienteSuccessP) modificarPacienteSuccessP.textContent = '';

		const fields = pacienteData.fields;
		const recordId = pacienteData.id;

		if(modificarPacienteRecordIDInput) modificarPacienteRecordIDInput.value = recordId; 

		// Poblar los campos del formulario
		if(document.getElementById('modificarPacienteNombres')) document.getElementById('modificarPacienteNombres').value = fields.Nombres || '';
		if(document.getElementById('modificarPacienteApellidos')) document.getElementById('modificarPacienteApellidos').value = fields.Apellidos || '';
		if(document.getElementById('modificarPacienteCarnet')) document.getElementById('modificarPacienteCarnet').value = fields.Carnet || '';
		if(document.getElementById('modificarPacienteFechaNacimiento')) document.getElementById('modificarPacienteFechaNacimiento').value = fields['Fecha_Nacimiento'] || ''; 
		if(document.getElementById('modificarPacienteGenero')) document.getElementById('modificarPacienteGenero').value = fields.Genero || '';
		if(document.getElementById('modificarPacienteTelefono')) document.getElementById('modificarPacienteTelefono').value = fields.Telefono || '';
		if(document.getElementById('modificarPacienteTipoSangre')) document.getElementById('modificarPacienteTipoSangre').value = fields['Tipo_Sangre'] || '';
		if(document.getElementById('modificarPacienteEstadoCivil')) document.getElementById('modificarPacienteEstadoCivil').value = fields['Estado_Civil'] || '';
		if(document.getElementById('modificarPacienteDireccion')) document.getElementById('modificarPacienteDireccion').value = fields.Direccion || '';
		if(document.getElementById('modificarPacienteOcupacion')) document.getElementById('modificarPacienteOcupacion').value = fields.Ocupacion || '';
		const idDelSeguroActual = fields.SeguroID || null; // Asume que tu API devuelve SeguroID
        fetchSeguros('modificarPacienteSeguro', idDelSeguroActual); // El 'Error al cargar seguros' sugiere que fetchSeguros est√° fallando o no encuentra el ID.
		if(modalModificarPaciente) modalModificarPaciente.style.display = 'block';
	}

    async function fetchMedicosAdmin(centroId) {
        if (!tablaMedicosAdminBody) {
            console.error("fetchMedicosAdmin - Error: El elemento tablaMedicosAdminBody no se encontr√≥.");
            return;
        }
        tablaMedicosAdminBody.innerHTML = '<tr><td colspan="11">Cargando m√©dicos del centro...</td></tr>'; // Colspan es 11
    
        if (!centroId) {
            console.error("fetchMedicosAdmin: centroId no proporcionado.");
            tablaMedicosAdminBody.innerHTML = '<tr><td colspan="11">Error: ID de centro no especificado.</td></tr>';
            return;
        }
    
        try {
            const params = new URLSearchParams({
                action: 'getAllMedicosPorCentro', // Acci√≥n definida en tu medicos.php
                centro_id: centroId,
                sort_field: 'Apellidos', // Campo de ordenaci√≥n por defecto
                sort_direction: 'ASC'    // Direcci√≥n de ordenaci√≥n por defecto
            });
    
            // apiMedicos debe estar definida en config.js y apuntar a tu medicos.php
            // const apiMedicos = 'https://productsonpoint.com/hce/api/medicos.php';
            const res = await fetch(`${apiMedicos}?${params.toString()}`);
    
            if (!res.ok) {
                let errorMsg = `Error ${res.status} al cargar m√©dicos.`;
                try {
                    const errorData = await res.json();
                    if (errorData && errorData.error) {
                        errorMsg = errorData.error;
                    }
                } catch (e) { /* Mantener errorMsg original si la respuesta no es JSON */ }
                console.error("fetchMedicosAdmin - Error de API:", res.status, errorMsg);
                tablaMedicosAdminBody.innerHTML = `<tr><td colspan="11">${errorMsg}</td></tr>`;
                return;
            }
    
            const data = await res.json(); // Espera { records: [ {id: ..., fields: {...} }, ... ] }
            // console.log(`[fetchMedicosAdmin] Datos recibidos para centro ${centroId}:`, data);
    
            tablaMedicosAdminBody.innerHTML = '';
            if (data.records && data.records.length > 0) {
                data.records.forEach(medicoRecord => { // medicoRecord es {id: ..., fields: {...}}
                    const fields = medicoRecord.fields; // 'fields' contiene los datos del m√©dico
                    const tr = tablaMedicosAdminBody.insertRow();
                    
                    tr.insertCell().textContent = fields.Carnet || '';
                    tr.insertCell().textContent = fields.Abreviatura || ''; 
                    tr.insertCell().textContent = fields.Apellidos || '';   
                    tr.insertCell().textContent = fields.Nombres || '';     
                    tr.insertCell().textContent = fields.Especialidad || '';
                    tr.insertCell().textContent = fields.Telefono || fields.Tel√©fono || ''; // Considerar ambos nombres
                    tr.insertCell().textContent = fields.Direccion || ''; 
                    tr.insertCell().textContent = fields.login || '';
                    tr.insertCell().textContent = fields['Tipo User'] || fields.TipoUser || ''; // Considerar nombre con espacio y sin espacio
                    tr.insertCell().textContent = fields['E-Mail'] || fields.EMail || ''; // Considerar 'E-Mail' y 'EMail'
    
                    const tdAcciones = tr.insertCell();
                    tdAcciones.style.textAlign = 'center';
                    const btnEditarMedico = document.createElement('button');
                    btnEditarMedico.innerHTML = '‚úèÔ∏è';
                    btnEditarMedico.title = "Modificar Datos del M√©dico";
                    btnEditarMedico.classList.add('btn-accion-icono');
                    // Pasar el objeto completo que incluye el ID y los campos
                    const medicoParaModal = { id: medicoRecord.id, fields: fields };
                    btnEditarMedico.onclick = () => abrirModalGestionMedico(medicoParaModal); 
                    tdAcciones.appendChild(btnEditarMedico);
                });
            } else {
                tablaMedicosAdminBody.innerHTML = '<tr><td colspan="11">No hay RR.HH. registrados para este centro.</td></tr>';
            }
        } catch (error) {
            console.error("Error en fetchMedicosAdmin (catch JS):", error); // El ReferenceError se mostrar√≠a aqu√≠ si persistiera
            tablaMedicosAdminBody.innerHTML = `<tr><td colspan="11">Error al cargar RR.HH.: ${error.message}</td></tr>`;
        }
    }

    function abrirModalGestionMedico(medicoData, carnetPrellenado = null) {
            //console.log("abrirModalGestionMedico llamada con:", medicoData, "y carnet prellenado:", carnetPrellenado); // LOG
            if (!formGestionMedico || !modalGestionMedico) {
                console.error("Error en abrirModalGestionMedico: formGestionMedico o modalGestionMedico es null.");
                return;
            }
            formGestionMedico.reset();
            if(gestionMedicoErrorP) gestionMedicoErrorP.textContent = '';
            if(gestionMedicoSuccessP) gestionMedicoSuccessP.textContent = '';
            if(gestionMedicoRecordIDInput) gestionMedicoRecordIDInput.value = '';

		if (medicoData) { // Modo Editar
		    modalGestionMedicoTituloH2.textContent = "Modificar Datos del M√©dico";
			document.getElementById('btnGuardarGestionMedico').textContent = "Guardar Cambios";
			gestionMedicoRecordIDInput.value = medicoData.id; // Guardar Record ID para PATCH

			const fields = medicoData.fields;
			document.getElementById('medicoAbreviatura').value = fields.Abreviatura || ''; 
			document.getElementById('medicoApellidos').value = fields.Apellidos || '';     
			document.getElementById('medicoNombres').value = fields.Nombres || '';       
			document.getElementById('medicoEspecialidad').value = fields.Especialidad || '';
			document.getElementById('medicoCarnet').value = fields.Carnet || '';
			document.getElementById('medicoTelefono').value = fields.Telefono || '';
			document.getElementById('medicoDireccion').value = fields.Direccion || '';
			document.getElementById('medicoLogin').value = fields.login || '';
			// Password no se puebla por seguridad, solo se puede cambiar
			document.getElementById('medicoTipoUser').value = fields.TipoUser || 'Medico';
			document.getElementById('medicoemail').value = fields.EMail || '';
			if(modalGestionMedico) { // Ya sabemos que no es null por la comprobaci√≥n al inicio de la funci√≥n
                modalGestionMedico.style.display = 'block';
            }
		} else { // Modo Crear Nuevo
			modalGestionMedicoTituloH2.textContent = "Registrar Nuevo RR.HH.";
			document.getElementById('btnGuardarGestionMedico').textContent = "Guardar RR.HH.";
		    if (carnetPrellenado && document.getElementById('medicoCarnet')) {
                document.getElementById('medicoCarnet').value = carnetPrellenado;
		    }
		    if(modalGestionMedico) modalGestionMedico.style.display = 'block';
	    }
    }
    
    async function asociarMedicoACentroExistente(medicoId, centroId, carnetParaLog) {
        // Muestra alg√∫n indicador de carga si quieres
        // ej: adminGestionMedicosContainerDiv.innerHTML = '<p>Asociando m√©dico...</p>';
        try {
            const payload = {
                action: 'asociarMedicoACentro',
                medicoId: medicoId,
                centroId: centroId
            };
    
            const res = await fetch(apiMedicos, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
    
            const data = await res.json();
    
            if (!res.ok || !data.success) {
                throw new Error(data.error || `Error ${res.status} al asociar m√©dico.`);
            }
    
            alert(data.message || `El RR.HH. con carnet ${carnetParaLog} ha sido habilitado para ${adminCentroMedicoData.nombre}.`);
            fetchMedicosAdmin(adminCentroMedicoData.id); // Refrescar la tabla
    
        } catch (error) {
            console.error("Error asociando m√©dico a centro:", error);
            alert("Error al asociar el RR.HH. al centro: " + error.message);
        }
    }
	

  </script>
</body>
</html>